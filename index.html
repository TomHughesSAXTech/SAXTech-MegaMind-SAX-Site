<!-- Enhanced MegaMind SAX with 3D Carousel and Full Functionality -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Prevent search engine indexing and caching -->
    <meta name="robots" content="noindex, nofollow, noarchive, nosnippet, noimageindex, nocache">
    <meta name="googlebot" content="noindex, nofollow, noarchive, nosnippet, noimageindex, max-snippet:0, max-image-preview:none">
    <meta name="bingbot" content="noindex, nofollow, noarchive, nosnippet, noimageindex">
    <meta name="slurp" content="noindex, nofollow, noarchive, nosnippet, noimageindex">
    <meta name="duckduckbot" content="noindex, nofollow, noarchive, nosnippet, noimageindex">
    <meta name="baiduspider" content="noindex, nofollow, noarchive, nosnippet, noimageindex">
    <meta name="yandexbot" content="noindex, nofollow, noarchive, nosnippet, noimageindex">
    <!-- Prevent social media crawling -->
    <meta property="og:type" content="website">
    <meta property="og:title" content="Private Application">
    <meta property="og:description" content="This is a private application. Access restricted.">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Private Application">
    <meta name="twitter:description" content="This is a private application. Access restricted.">
    <!-- Additional privacy headers -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate, private">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>MegaMind SAX</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="alternate icon" href="/favicon.ico">
    <script>
        // Force HTTPS redirect
        if (location.protocol !== 'https:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
            location.replace('https:' + window.location.href.substring(window.location.protocol.length));
        }
    </script>
    <script src="https://alcdn.msauth.net/browser/2.38.0/js/msal-browser.min.js" crossorigin="anonymous" onload="window.msalLoaded = true" onerror="window.msalLoaded = false"></script>
    <script>
        window.msalLoaded = false;
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #000000 0%, #1a1a1a 25%, #FFD700 50%, #FFA500 75%, #000000 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        /* Authentication overlay */
        .auth-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .auth-overlay.hidden {
            display: none;
        }

        .auth-card {
            background: linear-gradient(135deg, #2C2C2C 0%, #1F1F1F 50%, #333333 100%);
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            box-shadow: 0 25px 50px rgba(0,0,0,0.5);
            border: 1px solid rgba(255,215,0,0.3);
            max-width: 400px;
            width: 100%;
        }

        .robot-logo {
            margin-bottom: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* Robot Image with floating animation */
        .robot-image {
            width: 120px;
            height: 120px;
            object-fit: contain;
            animation: float 3s ease-in-out infinite;
            filter: drop-shadow(0 8px 16px rgba(255,215,0,0.4));
            background: transparent;
        }
        
        .robot-shadow {
            position: absolute;
            bottom: -15px;
            left: 50%;
            transform: translateX(-50%);
            width: 80px;
            height: 15px;
            background: radial-gradient(ellipse, rgba(0,0,0,0.2) 0%, transparent 70%);
            border-radius: 50%;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-8px); }
        }

        .auth-card h1 {
            color: #FFD700;
            font-size: 32px;
            margin-bottom: 20px;
            letter-spacing: 2px;
        }

        .auth-card p {
            color: #999;
            margin-bottom: 30px;
            font-size: 16px;
        }

        .sign-in-btn {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: #1a1a1a;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .sign-in-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(255,215,0,0.3);
        }

        /* Document Portal Button */
        .document-portal-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: #1a1a1a;
            padding: 10px 20px;
            border-radius: 25px;
            text-decoration: none;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s ease;
            z-index: 100;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .document-portal-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255,215,0,0.4);
        }

        .document-portal-btn.hidden {
            display: none;
        }

        /* User profile bar */
        .user-profile {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 15px 20px;
            color: white;
            z-index: 100;
            border: 1px solid rgba(255,215,0,0.3);
        }

        .user-profile.hidden {
            display: none;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #FFD700, #FFA500);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #1a1a1a;
        }

        .user-details h3 {
            font-size: 14px;
            margin-bottom: 2px;
        }

        .user-details p {
            font-size: 12px;
            color: #999;
        }
        
        .user-details .location {
            font-size: 11px;
            color: #888;
            margin-top: 2px;
        }

        .sign-out-btn {
            background: transparent;
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 8px 15px;
            border-radius: 15px;
            font-size: 12px;
            cursor: pointer;
            margin-left: 10px;
            transition: all 0.3s ease;
        }

        .sign-out-btn:hover {
            background: rgba(255,255,255,0.1);
        }

        /* Admin indicator */
        .admin-badge {
            background: linear-gradient(135deg, #FF4500, #FF6B47);
            color: white;
            padding: 4px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: bold;
            text-transform: uppercase;
            margin-left: 5px;
        }

        .admin-badge.hidden {
            display: none;
        }

        .container {
            display: flex;
            gap: 40px;
            max-width: 1800px;
            width: 100%;
            align-items: center;
            justify-content: flex-start;
            padding-left: 30px;
            padding-right: 30px;
        }

        .container.hidden {
            display: none;
        }

        /* iPhone 16 Style Device */
        .iphone-container {
            position: relative;
            width: 320px;
            flex-shrink: 0;
        }

        .iphone {
            width: 320px;
            height: 680px;
            background: linear-gradient(145deg, #3a3a3a, #2a2a2a);
            border-radius: 55px;
            padding: 8px;
            box-shadow: 
                0 30px 60px rgba(0,0,0,0.5),
                0 15px 30px rgba(0,0,0,0.3),
                inset 0 -2px 0 rgba(255,255,255,0.1),
                inset 0 2px 0 rgba(0,0,0,0.8);
            position: relative;
        }

        .dynamic-island {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 126px;
            height: 37px;
            background: #000;
            border-radius: 20px;
            z-index: 10;
            box-shadow: inset 0 0 0 1px rgba(255,255,255,0.1);
        }

        .side-button {
            position: absolute;
            background: linear-gradient(to bottom, #2a2a2a, #1a1a1a);
            box-shadow: 
                0 2px 4px rgba(0,0,0,0.5),
                inset 0 1px 0 rgba(255,255,255,0.1);
        }

        .power-button {
            right: -3px;
            top: 200px;
            width: 3px;
            height: 100px;
            border-radius: 0 3px 3px 0;
        }

        .volume-up {
            left: -3px;
            top: 180px;
            width: 3px;
            height: 60px;
            border-radius: 3px 0 0 3px;
        }

        .volume-down {
            left: -3px;
            top: 250px;
            width: 3px;
            height: 60px;
            border-radius: 3px 0 0 3px;
        }

        .screen {
            width: 100%;
            height: calc(100% - 16px);
            background: linear-gradient(180deg, #000000 0%, #0a0a0a 100%);
            border-radius: 47px;
            margin-top: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
            box-shadow: inset 0 0 0 1px rgba(255,255,255,0.1);
        }

        .voice-selector {
            position: absolute;
            top: 80px;
            width: 80%;
            background: rgba(255,255,255,0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 15px;
        }
        
        .voice-selector label {
            color: #888;
            font-size: 12px;
            display: block;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .voice-selector select {
            width: 100%;
            padding: 10px;
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 10px;
            color: white;
            font-size: 14px;
            outline: none;
            cursor: pointer;
        }

        .speaker-icon {
            width: 100px;
            height: 100px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 30px;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            background: rgba(255,255,255,0.05);
            backdrop-filter: blur(10px);
        }

        .speaker-icon.listening {
            border-color: rgba(100, 150, 255, 0.5);
            background: rgba(100, 150, 255, 0.1);
            /* Removed animation and glow for less distraction */
        }

        .speaker-icon svg {
            width: 50px;
            height: 50px;
            fill: currentColor;
            color: rgba(255, 255, 255, 0.8);
        }

        .speaker-icon.listening svg {
            color: rgba(100, 150, 255, 0.8);
        }

        .status-text {
            color: #999;
            font-size: 16px;
            text-align: center;
            margin-bottom: 20px;
            font-weight: 500;
            letter-spacing: 1px;
        }

        .status-text.listening {
            color: rgba(100, 150, 255, 0.8);
            /* Removed text shadow for less distraction */
        }

        .volume-bars {
            display: flex;
            gap: 4px;
            margin-top: 20px;
        }

        .volume-bar {
            width: 5px;
            height: 25px;
            background: #333;
            border-radius: 3px;
            transition: all 0.3s ease;
        }

        .volume-bar.active {
            background: rgba(100, 150, 255, 0.4);
        }
        
        /* Gentle wave animation for listening state */
        .volume-bar.wave {
            animation: gentleWave 3s ease-in-out infinite;
        }
        
        .volume-bar.wave:nth-child(1) { animation-delay: 0s; }
        .volume-bar.wave:nth-child(2) { animation-delay: 0.3s; }
        .volume-bar.wave:nth-child(3) { animation-delay: 0.6s; }
        .volume-bar.wave:nth-child(4) { animation-delay: 0.9s; }
        .volume-bar.wave:nth-child(5) { animation-delay: 1.2s; }
        
        @keyframes gentleWave {
            0%, 100% { 
                transform: scaleY(0.5);
                opacity: 0.4;
            }
            50% { 
                transform: scaleY(1);
                opacity: 0.8;
            }
        }

        .conversation-indicator {
            position: absolute;
            bottom: 30px;
            width: 100%;
            text-align: center;
            padding: 10px;
        }
        
        .conversation-state {
            display: inline-block;
            padding: 8px 16px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 20px;
            color: rgba(255,255,255,0.7);
            font-size: 12px;
            font-weight: 600;
            letter-spacing: 1px;
            text-transform: uppercase;
        }
        
        .conversation-state.listening {
            background: rgba(100,150,255,0.15);
            border-color: rgba(100,150,255,0.4);
            color: rgba(100,150,255,0.9);
            /* Removed pulsing animation */
        }

        /* Large 3D Spinning Carousel */
        .personality-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.85);
            backdrop-filter: blur(20px);
            z-index: 2000;
            display: none;
            opacity: 0;
            transition: all 0.4s ease;
            align-items: center;
            justify-content: center;
        }

        .personality-overlay.show {
            display: flex;
            opacity: 1;
        }

        .big-carousel-container {
            perspective: 1500px;
            width: 1200px;
            height: 700px;
            position: relative;
        }

        .big-carousel-3d {
            position: relative;
            width: 100%;
            height: 100%;
            transform-style: preserve-3d;
            transition: transform 0.8s ease;
            transform: rotateY(0deg);
        }

        .big-personality-card {
            position: absolute;
            width: 440px;
            height: 550px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            left: 50%;
            top: 50%;
            margin-left: -220px;
            margin-top: -275px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .big-personality-card:nth-child(1) { 
            transform: rotateY(0deg) translateZ(450px); 
        }
        .big-personality-card:nth-child(2) { 
            transform: rotateY(90deg) translateZ(450px); 
        }
        .big-personality-card:nth-child(3) { 
            transform: rotateY(180deg) translateZ(450px); 
        }
        .big-personality-card:nth-child(4) { 
            transform: rotateY(270deg) translateZ(450px); 
        }
        
        /* Hide cards when they're in the back */
        .big-personality-card {
            opacity: 0.3;
            transition: opacity 0.8s ease, transform 0.3s ease;
        }
        
        .big-personality-card.active {
            opacity: 1;
        }
        
        /* Cards on the sides are semi-visible */
        .big-personality-card.side-visible {
            opacity: 0.6;
        }
        
        /* Cards in the back are hidden */
        .big-personality-card.back-hidden {
            opacity: 0;
            pointer-events: none;
        }

        .floating-character {
            width: 220px;
            height: 220px;
            margin-bottom: 30px;
            background: transparent !important;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: visible;
            animation: bigBounce 2.5s ease-in-out infinite;
            z-index: 10;
            position: relative;
        }

        .floating-character img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            background: transparent;
            filter: drop-shadow(0 10px 20px rgba(255,215,0,0.3)) drop-shadow(0 15px 25px rgba(0,0,0,0.5));
            image-rendering: auto;
            mix-blend-mode: normal;
        }

        .floating-character .emoji-fallback {
            font-size: 120px;
            filter: drop-shadow(0 15px 25px rgba(0,0,0,0.4));
        }

        @keyframes bigBounce {
            0%, 100% { 
                transform: translateY(0px) scale(1); 
            }
            50% { 
                transform: translateY(-20px) scale(1.05); 
            }
        }

        .character-details {
            background: linear-gradient(135deg, #2C2C2C 0%, #1F1F1F 50%, #333333 100%);
            border: 2px solid rgba(255,215,0,0.6);
            border-radius: 25px;
            padding: 35px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.6);
            width: 100%;
            transition: all 0.3s ease;
        }

        .big-personality-card:hover .character-details {
            border-color: #FFD700;
            box-shadow: 0 25px 50px rgba(255,215,0,0.5);
            transform: translateY(-5px);
            background: linear-gradient(135deg, #333333 0%, #2C2C2C 50%, #3a3a3a 100%);
        }

        .big-personality-card.active .character-details {
            border-color: #FFD700;
            box-shadow: 0 30px 60px rgba(255,215,0,0.7);
            background: linear-gradient(135deg, #3a3a3a 0%, #333333 50%, #404040 100%);
        }

        .big-personality-name {
            color: white;
            font-size: 22px;
            font-weight: 600;
            margin-bottom: 12px;
            letter-spacing: 0.5px;
        }

        .big-personality-role {
            color: #FFD700;
            font-size: 16px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            margin-bottom: 18px;
        }

        .big-personality-description {
            color: #ccc;
            font-size: 14px;
            line-height: 1.6;
        }

        .big-carousel-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 50%;
            width: 70px;
            height: 70px;
            color: white;
            cursor: pointer;
            font-size: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            backdrop-filter: blur(15px);
        }

        .big-carousel-nav:hover {
            background: rgba(255,215,0,0.3);
            border-color: #FFD700;
            transform: translateY(-50%) scale(1.1);
        }

        .big-carousel-nav.prev {
            left: -150px;
        }

        .big-carousel-nav.next {
            right: -150px;
        }

        .big-carousel-close {
            position: absolute;
            top: -100px;
            right: 0;
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 50%;
            width: 60px;
            height: 60px;
            color: white;
            cursor: pointer;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            backdrop-filter: blur(15px);
        }

        .big-carousel-close:hover {
            background: rgba(255,69,0,0.3);
            border-color: #FF4500;
            color: #FF4500;
        }

        /* Chat Interface */
        .chat-container {
            flex: 3;
            background: linear-gradient(135deg, #2C2C2C 0%, #1F1F1F 50%, #333333 100%);
            border-radius: 25px;
            box-shadow: 
                0 25px 50px rgba(0,0,0,0.3),
                0 10px 20px rgba(0,0,0,0.2),
                inset 0 1px 0 rgba(255,255,255,0.1);
            overflow: hidden;
            height: 90vh;
            max-height: 950px;
            width: 100%;
            max-width: 1200px;
            display: flex;
            flex-direction: column;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,215,0,0.2);
            position: relative;
        }
        
        .header-robot {
            width: 140px;
            height: 140px;
            margin-right: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: visible;
            background: transparent;
            animation: float 3s ease-in-out infinite;
            position: relative;
            flex-shrink: 0;
        }

        .header-robot img {
            width: 85%;
            height: 85%;
            object-fit: contain;
            background: transparent;
            filter: drop-shadow(0 8px 16px rgba(255,215,0,0.4)) drop-shadow(0 4px 8px rgba(0,0,0,0.3));
        }

        .chat-header {
            background: linear-gradient(135deg, rgba(255,215,0,0.15), rgba(0,0,0,0.3));
            backdrop-filter: blur(10px);
            color: #FFD700;
            padding: 15px 30px;
            border-bottom: 1px solid rgba(255,215,0,0.2);
            position: relative;
            height: 160px;
            display: flex;
            align-items: center;
            overflow: hidden;
        }
        
        .chat-header-content {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 25px;
            width: 100%;
        }

        .header-text h2 {
            font-size: 32px;
            font-weight: 300;
            letter-spacing: 2px;
            margin: 0;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header-text h2:hover {
            transform: scale(1.02);
        }

        .header-text p {
            font-size: 18px;
            opacity: 0.8;
            letter-spacing: 1px;
            margin: 5px 0 0 0;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 30px;
            height: calc(100% - 240px);
            background: rgba(255,255,255,0.05);
            max-height: calc(90vh - 240px);
        }

        .message {
            margin-bottom: 20px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
            animation: messageSlide 0.3s ease;
        }

        @keyframes messageSlide {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-bubble {
            max-width: 75%;
            padding: 15px 20px;
            border-radius: 20px;
            word-wrap: break-word; /* legacy */
            overflow-wrap: anywhere; /* modern */
            word-break: break-word;
            white-space: normal; /* normal spacing instead of pre-wrap */
            line-height: 1.5;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }
        
        /* Collapse excessive spacing in bot messages */
        .message-bubble p {
            margin: 0.5em 0;
        }
        
        .message-bubble p:first-child {
            margin-top: 0;
        }
        
        .message-bubble p:last-child {
            margin-bottom: 0;
        }
        
        .message-bubble br + br {
            display: none; /* Hide consecutive line breaks */
        }
        
        .message-bubble a {
            color: #0084ff;
            text-decoration: underline;
            word-break: break-word;
            overflow-wrap: anywhere;
        }
        
        .message-bubble img {
            max-width: 100%;
            height: auto;
            display: block;
            border-radius: 8px;
        }

        .message.user .message-bubble {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: #1a1a1a;
            border-bottom-right-radius: 5px;
        }

        .message.bot .message-bubble {
            background: rgba(255,255,255,0.9);
            color: #1a1a1a;
            border-bottom-left-radius: 5px;
            border: 1px solid rgba(255,215,0,0.2);
        }

        .message-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: bold;
            flex-shrink: 0;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        }

        .message.user .message-avatar {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: #1a1a1a;
        }

        .message.bot .message-avatar {
            background: transparent;
            overflow: visible;
            box-shadow: none;
            border-radius: 50%;
            animation: messageBounce 2s ease-in-out infinite;
        }

        .message.bot .message-avatar img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            background: transparent;
            filter: drop-shadow(0 3px 6px rgba(255,215,0,0.3));
        }

        @keyframes messageBounce {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-5px); }
        }

        .chat-input-container {
            padding: 25px;
            border-top: 1px solid rgba(255,255,255,0.1);
            background: rgba(0,0,0,0.2);
        }

        .chat-input {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .chat-input input {
            flex: 1;
            background: rgba(255,255,255,0.9);
            border: 1px solid rgba(255,215,0,0.3);
            padding: 15px 20px;
            border-radius: 25px;
            font-size: 16px;
            outline: none;
            transition: all 0.3s ease;
        }

        .chat-input input:focus {
            border-color: #FFD700;
            box-shadow: 0 0 20px rgba(255,215,0,0.3);
        }

        .send-btn, .file-btn, .reset-btn, .voice-btn {
            width: 50px;
            height: 50px;
            border: none;
            border-radius: 50%;
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: #1a1a1a;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .send-btn:hover, .file-btn:hover, .reset-btn:hover, .voice-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 5px 15px rgba(255,215,0,0.4);
        }

        .send-btn.stop-mode {
            background: linear-gradient(135deg, #FF4500, #FF6B47);
            animation: pulse 1.5s infinite;
        }

        .send-btn.stop-mode:hover {
            box-shadow: 0 5px 15px rgba(255,69,0,0.4);
            transform: scale(1.15);
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        #fileInput {
            display: none;
        }

        /* Typing indicator */
        .typing-indicator {
            display: inline-block;
            padding: 15px 20px;
            background: rgba(255,255,255,0.9);
            border-radius: 20px;
            border-bottom-left-radius: 5px;
            border: 1px solid rgba(255,215,0,0.2);
        }

        .typing-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: #999;
            border-radius: 50%;
            margin: 0 2px;
            animation: typing 1.4s infinite;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
            }
            30% {
                transform: translateY(-10px);
            }
        }

        @media (max-width: 1400px) {
            .big-carousel-container {
                width: 90%;
                max-width: 1000px;
            }

            .big-carousel-nav.prev {
                left: -100px;
            }

            .big-carousel-nav.next {
                right: -100px;
            }
        }

        @media (max-width: 1200px) {
            .container {
                flex-direction: column;
                gap: 40px;
            }

            .big-personality-card {
                width: 350px;
                height: 450px;
                margin-left: -175px;
                margin-top: -225px;
            }

            .floating-character {
                width: 180px;
                height: 180px;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .iphone {
                width: 280px;
                height: 600px;
            }

            .chat-container {
                max-height: 500px;
            }

            .user-profile {
                position: relative;
                top: auto;
                right: auto;
                margin-bottom: 20px;
            }
        }

        /* Document Preview Modal Styles */
        .modal {
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            padding: 15px 20px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 1.5em;
            color: #333;
        }

        .modal-header .close {
            font-size: 28px;
            font-weight: bold;
            color: #aaa;
            cursor: pointer;
            transition: color 0.3s;
        }

        .modal-header .close:hover {
            color: #000;
        }

        .modal-body {
            overflow: hidden;
        }
        
        /* History Dropdown Styles */
        .history-dropdown {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            z-index: 10001;  /* Higher than other elements but reasonable */
        }
        
        .history-btn {
            background: linear-gradient(135deg, rgba(255,215,0,0.3), rgba(255,165,0,0.3));
            border: 2px solid #FFD700;
            color: #FFD700;
            padding: 10px 20px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(255,215,0,0.3);
        }
        
        .history-btn:hover {
            background: rgba(255,215,0,0.3);
            transform: scale(1.05);
        }
        
        .history-menu {
            position: fixed !important;  /* Force fixed positioning */
            background: white !important;  /* Solid white background */
            border: 2px solid #FFD700;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            display: none;
            min-width: 350px;
            max-width: 450px;
            max-height: 400px;  /* Fixed max height for better control */
            overflow-y: auto;
            z-index: 999999 !important;  /* Highest z-index to ensure it's on top */
            opacity: 1 !important;
            visibility: visible !important;
            padding: 10px 0;  /* Add padding for content */
        }
        
        .history-menu.active {
            display: block !important;
            opacity: 1 !important;
            visibility: visible !important;
        }
        
        .history-item {
            padding: 15px;
            border-bottom: 1px solid rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
            position: relative;
        }
        
        .history-item:hover {
            background: rgba(255,215,0,0.15);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .history-item:last-child {
            border-bottom: none;
        }
        
        .history-item-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
            font-size: 14px;
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .history-item-time {
            font-size: 11px;
            color: #999;
            margin-bottom: 5px;
        }
        
        .history-item-preview {
            font-size: 12px;
            color: #666;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .history-loading {
            padding: 20px;
            text-align: center;
            color: #666;
            font-size: 14px;
        }
        
        .history-empty {
            padding: 20px;
            text-align: center;
            color: #666;
            font-size: 14px;
        }
        
        #historyList {
            min-height: 50px;
            color: #333;
        }
    </style>
</head>
<body>

    <!-- Authentication overlay -->
    <div id="authOverlay" class="auth-overlay hidden">
        <div class="auth-card">
            <div class="robot-logo">
                <img src="robot.png" alt="MegaMind Robot" class="robot-image">
                <div class="robot-shadow"></div>
            </div>
            <h1>MegaMind SAX</h1>
            <p id="authMessage">Your AI-powered assistant for SAX Advisory Group</p>
            <button id="signInBtn" class="sign-in-btn">Sign in with Microsoft</button>
        </div>
    </div>

    <!-- User profile bar -->
    <div id="userProfile" class="user-profile hidden">
        <div class="user-info">
            <div id="userAvatar" class="user-avatar"></div>
            <div class="user-details">
                <h3 id="userName"></h3>
                <p id="userRole"></p>
                <p id="userLocation" class="location"></p>
            </div>
            <div id="adminBadge" class="admin-badge hidden">Admin</div>
            <button id="signOutBtn" class="sign-out-btn">Sign Out</button>
            <button onclick="openDocumentPortal()" class="sign-out-btn" style="margin-left: 10px;">Documents</button>
        </div>
    </div>

    <!-- Large 3D Spinning Personality Carousel -->
    <div class="personality-overlay" id="personalityOverlay">
        <div class="big-carousel-container">
            <div class="big-carousel-close" id="carouselClose">✕</div>
            <div class="big-carousel-nav prev" id="carouselPrev">‹</div>
            <div class="big-carousel-nav next" id="carouselNext">›</div>
            <div class="big-carousel-3d" id="carousel3d">
                <div class="big-personality-card active" data-personality="sage">
                    <div class="floating-character">
                        <img src="robot.png" alt="SAX MegaMind" onerror="this.style.display='none'; this.parentNode.innerHTML='<div class=emoji-fallback>🧠</div>';">
                    </div>
                    <div class="character-details">
                        <div class="big-personality-name">SAX MegaMind</div>
                        <div class="big-personality-role">General Business Assistant</div>
                        <div class="big-personality-description">Expert in business operations, strategy, and general advisory services for all departments. Your go-to assistant for comprehensive business guidance.</div>
                    </div>
                </div>
                <div class="big-personality-card" data-personality="tax">
                    <div class="floating-character">
                        <img src="robot-cpa.png" alt="SAX CPA" onerror="this.style.display='none'; this.parentNode.innerHTML='<div class=emoji-fallback>📋</div>';">
                    </div>
                    <div class="character-details">
                        <div class="big-personality-name">SAX CPA</div>
                        <div class="big-personality-role">Tax & Accounting Expert</div>
                        <div class="big-personality-description">Specialized in tax planning, accounting principles, and financial compliance. Expert in federal, state, and local tax regulations.</div>
                    </div>
                </div>
                <div class="big-personality-card" data-personality="trainer">
                    <div class="floating-character">
                        <img src="robot-trainer.png" alt="SAX Trainer" onerror="this.style.display='none'; this.parentNode.innerHTML='<div class=emoji-fallback>📚</div>';">
                    </div>
                    <div class="character-details">
                        <div class="big-personality-name">SAX Trainer</div>
                        <div class="big-personality-role">Learning & Development</div>
                        <div class="big-personality-description">Expert in professional development, training programs, and skill building. Your partner in continuous learning and growth.</div>
                    </div>
                </div>
                <div class="big-personality-card" data-personality="auditor">
                    <div class="floating-character">
                        <img src="robot-auditor.png" alt="SAX Auditor" onerror="this.style.display='none'; this.parentNode.innerHTML='<div class=emoji-fallback>🔍</div>';">
                    </div>
                    <div class="character-details">
                        <div class="big-personality-name">SAX Auditor</div>
                        <div class="big-personality-role">Audit & Compliance Expert</div>
                        <div class="big-personality-description">Focused on audit procedures, compliance requirements, and risk assessment protocols. Expert in audit standards and regulatory compliance.</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main application -->
    <div id="mainApp" class="container hidden">
        <!-- Conversational interaction device -->
        <div class="iphone-container">
            <div class="iphone">
                <div class="dynamic-island"></div>
                <div class="side-button power-button"></div>
                <div class="side-button volume-up"></div>
                <div class="side-button volume-down"></div>
                
                <div class="screen">
                    <!-- Voice selector and TTS toggle -->
                    <div class="voice-selector">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
                            <label style="margin: 0;">Audio Settings</label>
                            <label class="switch" style="position: relative; display: inline-block; width: 44px; height: 24px; margin: 0;">
                                <input type="checkbox" id="ttsToggle" style="opacity: 0; width: 0; height: 0;">
                                <span class="slider" id="ttsSlider" style="
                                    position: absolute;
                                    cursor: pointer;
                                    top: 0;
                                    left: 0;
                                    right: 0;
                                    bottom: 0;
                                    background-color: #ccc;
                                    border-radius: 24px;
                                    transition: .3s;
                                ">
                                    <span id="sliderKnob" style="
                                        position: absolute;
                                        content: '';
                                        height: 18px;
                                        width: 18px;
                                        left: 3px;
                                        bottom: 3px;
                                        background-color: white;
                                        border-radius: 50%;
                                        transition: .3s;
                                    "></span>
                                </span>
                            </label>
                        </div>
                        <select id="voiceSelect">
                            <option value="rachel">Rachel (Female Professional)</option>
                            <option value="clyde">Clyde (Male Professional)</option>
                            <option value="charlotte">Charlotte (British Female)</option>
                            <option value="bill">Bill (American Documentary)</option>
                            <option value="george">George (British Narrator)</option>
                            <option value="domi">Domi (Young Female)</option>
                            <option value="nicole">Nicole (Soft Female)</option>
                            <option value="jessie">Jessie (Warm Male)</option>
                        </select>
                        <div id="ttsStatus" style="text-align: center; margin-top: 5px; font-size: 11px; color: rgba(255,255,255,0.6);">Audio: OFF</div>
                    </div>
                    
                    <!-- Speaker icon and status -->
                    <div class="speaker-icon" id="speakerIcon">
                        <svg viewBox="0 0 24 24">
                            <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>
                        </svg>
                    </div>
                    
                    <div class="status-text" id="statusText">Turn on Audio, then tap speaker for conversational mode</div>
                    
                    <!-- Volume bars for voice activity -->
                    <div class="volume-bars">
                        <div class="volume-bar"></div>
                        <div class="volume-bar"></div>
                        <div class="volume-bar"></div>
                        <div class="volume-bar"></div>
                        <div class="volume-bar"></div>
                    </div>
                    
                <!-- Conversation state indicator -->
                <div class="conversation-indicator">
                    <span id="conversationState" class="conversation-state" style="display: none;"></span>
                    <button id="stopConversationBtn" class="stop-conversation-btn" style="
                        padding: 8px 16px;
                        background: rgba(255, 100, 100, 0.2);
                        border: 1px solid rgba(255, 100, 100, 0.4);
                        border-radius: 20px;
                        color: rgba(255, 100, 100, 0.9);
                        font-size: 12px;
                        cursor: pointer;
                        transition: all 0.3s ease;
                    " onmouseover="this.style.background='rgba(255, 100, 100, 0.3)'" 
                       onmouseout="this.style.background='rgba(255, 100, 100, 0.2)'">Stop Conversation</button>
                </div>
                </div>
            </div>
        </div>

        <!-- Chat interface -->
        <div class="chat-container">
            <div class="chat-header">
                <div class="chat-header-content">
                    <div class="header-robot" id="currentPersonalityAvatar">
                        <img src="robot.png" alt="SAX MegaMind" onerror="this.style.display='none'; this.parentNode.innerHTML='🧠';">
                    </div>
                    <div class="header-text">
                        <h2 id="personalitySelector">
                            <span id="currentPersonalityName">SAX MegaMind</span>
                            <span style="font-size: 14px;">▼</span>
                        </h2>
                        <p id="personalityIndicator">General Business Assistant</p>
                    </div>
                </div>
                
                <!-- History Dropdown -->
                <div class="history-dropdown">
                    <button class="history-btn" id="historyBtn" onclick="window.toggleHistoryMenu(); return false;">
                        History
                    </button>
                    <div class="history-menu" id="historyMenu">
                        <div class="history-loading" id="historyLoading">Loading...</div>
                        <div class="history-empty" id="historyEmpty" style="display: none;">No conversation history</div>
                        <div id="historyList"></div>
                    </div>
                </div>
            </div>
            
            <div class="chat-messages" id="chatMessages">
                <!-- Messages will be added here dynamically -->
            </div>
            
            <!-- Tax Search Component Container (Hidden by default, shown for CPA profile) -->
            <div id="taxSearchContainer" style="display: none;">
                <!-- Tax Search UI will be rendered here dynamically -->
            </div>
            
            <div class="chat-input-container">
                <div class="chat-input">
                    <input type="text" id="messageInput" placeholder="Type your message or click voice to speak...">
                    <button class="send-btn" id="sendBtn" title="Send message">➤</button>
                    <button class="file-btn" id="fileBtn" title="Attach file">📎</button>
                    <input type="file" id="fileInput" accept="*/*" multiple>
                    <button class="voice-btn" id="voiceBtn" title="Voice input">🎤</button>
                    <button class="reset-btn" id="resetBtn" title="Reset conversation">🔄</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Report AI Issue Button -->
    <button onclick="window.location.href='https://help.saxtechnology.com/app/service/report/363'" style="
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: linear-gradient(135deg, #f93b1d 0%, #ea1e63 100%);
        color: white;
        border: none;
        border-radius: 50px;
        padding: 12px 24px;
        font-size: 14px;
        font-weight: bold;
        cursor: pointer;
        z-index: 9999;
        box-shadow: 0 4px 15px rgba(249, 59, 29, 0.3);
        transition: transform 0.3s, box-shadow 0.3s;
    " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(249, 59, 29, 0.4)'" 
       onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(249, 59, 29, 0.3)'">
        🚨 Report AI Issue
    </button>

    <script>
        // Microsoft Authentication configuration
        const msalConfig = {
            auth: {
                clientId: "23453f6d-01b3-4fa2-88c5-177f8bd56bb1", // MegaMind SAX Portal app registration
                authority: "https://login.microsoftonline.com/3d659328-eef0-44f7-8481-5833e1051aec", // saxtechnology.com tenant
                redirectUri: window.location.origin,
                postLogoutRedirectUri: window.location.origin
            },
            cache: {
                cacheLocation: "localStorage",
                storeAuthStateInCookie: true
            },
            system: {
                loggerOptions: {
                    loggerCallback: function (level, message, containsPii) {
                        if (containsPii) return;
                        console.log(message);
                    },
                    piiLoggingEnabled: false,
                    logLevel: window.msal ? msal.LogLevel.Warning : 2
                }
            }
        };

        const loginRequest = {
            scopes: ["openid", "profile", "User.Read", "UserAuthenticationMethod.Read.All"],
            prompt: "select_account",
            domainHint: "saxadvisorygroup.com",
            loginHint: "@saxadvisorygroup.com"
        };

        // Initialize MSAL instance
        let msalInstance = null;
        
        function initializeMSAL() {
            if (window.msalLoaded && typeof msal !== 'undefined' && msal.PublicClientApplication) {
                try {
                    msalInstance = new msal.PublicClientApplication(msalConfig);
                    return true;
                } catch (error) {
                    console.error('Error creating MSAL instance:', error);
                    return false;
                }
            }
            return false;
        }

        // Global variables
        let currentAccount = null;
        let userProfile = null;
        let sessionId = null;
        let isRecording = false;
        let mediaRecorder = null;
        let audioChunks = [];
        window.attachedFiles = [];  // Make it globally accessible
        let attachedFiles = window.attachedFiles;  // Use the window reference
        let conversationMode = true;  // Always in conversation mode
        let isInConversation = false;
        let silenceTimer = null;
        let audioContext = null;
        let analyser = null;
        let microphone = null;
        let currentAudio = null;
        let isAISpeaking = false;
        let currentCarouselRotation = 0;
        let isChatRunning = false;
        let abortController = null;  // For cancelling fetch requests
        let recognition = null;  // Speech recognition instance
        let isListening = false;
        let continuousMode = true;  // Always continuous conversation
        let autoRestartTimer = null;
        let volumeAnimationFrame = null;
        let recognitionActive = false;  // Track actual recognition state
        let voiceInteractionActive = false;  // Track conversational mode
        
        // Session History Management
        let conversationHistory = [];
        let userSessionId = null;
        let historyMenuOpen = false;
        
        // Generate unique session ID on page load
        function generateSessionId() {
            return 'session-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
        }
        
        // History dropdown functions - simplified version
        window.toggleHistoryMenu = function() {
            console.log('toggleHistoryMenu called');
            
            const menu = document.getElementById('historyMenu');
            const btn = document.getElementById('historyBtn');
            
            if (!menu || !btn) {
                console.error('Menu or button not found');
                return;
            }
            
            // Move menu to body if it's not there already to ensure it's above everything
            if (menu.parentElement.id !== 'body' && !menu.parentElement.classList.contains('body')) {
                document.body.appendChild(menu);
                console.log('Moved menu to body for proper z-index stacking');
            }
            
            // Toggle visibility
            const isVisible = menu.style.display === 'block';
            console.log('Current visibility:', isVisible, 'Toggling to:', !isVisible);
            
            if (!isVisible) {
                // Show menu
                const btnRect = btn.getBoundingClientRect();
                
                // Position menu to the LEFT of the button, extending leftward
                const menuWidth = 400; // Approximate width
                const rightEdge = btnRect.left; // Right edge of menu should align with left edge of button
                const leftPosition = Math.max(10, rightEdge - menuWidth); // Ensure it doesn't go off screen
                
                // Set all positioning at once
                menu.style.cssText = `
                    display: block !important;
                    position: fixed !important;
                    top: ${btnRect.bottom + 10}px !important;
                    left: ${leftPosition}px !important;
                    width: ${menuWidth}px !important;
                    z-index: 2147483647 !important;
                    opacity: 1 !important;
                    visibility: visible !important;
                    background: white !important;
                    border: 2px solid #FFD700 !important;
                    border-radius: 12px !important;
                    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.8) !important;
                    max-height: 400px !important;
                    overflow-y: auto !important;
                    padding: 10px 0 !important;
                `;
                
                menu.classList.add('active');
                historyMenuOpen = true;
                
                console.log('Menu shown with styles:', menu.style.cssText);
                
                // Load history
                loadHistoryFromAzure();
            } else {
                // Hide menu
                menu.style.display = 'none';
                menu.classList.remove('active');
                historyMenuOpen = false;
                console.log('Menu hidden');
            }
        }
        
        // Load conversation history from Azure
        async function loadHistoryFromAzure() {
            const historyList = document.getElementById('historyList');
            const historyLoading = document.getElementById('historyLoading');
            const historyEmpty = document.getElementById('historyEmpty');
            
            // Show loading
            historyLoading.style.display = 'block';
            historyEmpty.style.display = 'none';
            historyList.innerHTML = '';
            
            if (!currentAccount || !currentAccount.username) {
                historyLoading.style.display = 'none';
                historyEmpty.style.display = 'block';
                historyEmpty.textContent = 'Please sign in to view history';
                return;
            }
            
            try {
                // Fetch from Azure Function using GET with query params (like admin.html does)
                const response = await fetch(`https://saxtechconversationlogs.azurewebsites.net/api/SaveConversationLog?action=get&email=${encodeURIComponent(currentAccount.username)}&range=all&code=w_j-EeXYy7G1yfUBkSVvlT5Hhafzg-eCNkaUOkOzzIveAzFu9NTlQw==`, {
                    method: 'GET',
                    headers: {}
                });
                
                if (!response.ok) {
                    throw new Error('Failed to fetch history');
                }
                
                const data = await response.json();
                console.log('Raw history data from Azure:', data);
                
                // Try different possible data structures
                let sessions = [];
                if (Array.isArray(data)) {
                    sessions = data;
                } else if (data.sessions) {
                    sessions = data.sessions;
                } else if (data.conversations) {
                    sessions = data.conversations;
                } else if (data.data) {
                    sessions = Array.isArray(data.data) ? data.data : [];
                }
                
                console.log('Parsed sessions:', sessions);
                console.log('Number of sessions:', sessions.length);
                
                // Hide loading
                historyLoading.style.display = 'none';
                
                if (sessions.length === 0) {
                    historyEmpty.style.display = 'block';
                    historyEmpty.textContent = 'No conversation history yet';
                    return;
                }
                
                historyEmpty.style.display = 'none';
                
                // Display conversations
                let html = '';
                sessions.forEach((session, index) => {
                    // Parse the conversation data - can be string array or object
                    let messages = [];
                    try {
                        if (typeof session.conversation === 'string') {
                            const parsed = JSON.parse(session.conversation);
                            // Handle array or object format
                            messages = Array.isArray(parsed) ? parsed : (parsed.messages || []);
                        } else if (Array.isArray(session.conversation)) {
                            messages = session.conversation;
                        } else if (session.conversation && session.conversation.messages) {
                            messages = session.conversation.messages;
                        } else if (session.messages) {
                            messages = session.messages;
                        }
                    } catch (e) {
                        console.error('Error parsing conversation for display:', e);
                    }
                    
                    const firstUserMessage = messages.find(m => m.role === 'user');
                    const firstBotResponse = messages.find(m => m.role === 'assistant');
                    
                    // Generate title from first user message
                    let title = 'Conversation';
                    if (session.summary) {
                        title = session.summary;
                    } else if (firstUserMessage && firstUserMessage.content) {
                        // Clean up the content for display
                        const cleanContent = firstUserMessage.content.replace(/\n/g, ' ').trim();
                        title = cleanContent.substring(0, 50);
                        if (cleanContent.length > 50) title += '...';
                    }
                    
                    // Generate preview from bot response
                    let preview = '';
                    if (firstBotResponse && firstBotResponse.content) {
                        // Clean up the content for display
                        const cleanContent = firstBotResponse.content.replace(/\n/g, ' ').replace(/<[^>]*>/g, '').trim();
                        preview = cleanContent.substring(0, 100);
                        if (cleanContent.length > 100) preview += '...';
                    }
                    
                    const timestamp = new Date(session.timestamp || session.createdAt || Date.now());
                    const timeStr = timestamp.toLocaleString();
                    
                    html += `
                        <div class="history-item" onclick="loadConversationFromAzure('${session.sessionId || session.id || session._id}')">
                            <div class="history-item-title">${escapeHtml(title)}</div>
                            <div class="history-item-time">${timeStr}</div>
                            ${preview ? `<div class="history-item-preview">${escapeHtml(preview)}</div>` : ''}
                        </div>
                    `;
                });
                
                console.log('Generated HTML for history list:', html);
                console.log('History list element:', historyList);
                historyList.innerHTML = html;
                console.log('History list after innerHTML set:', historyList.innerHTML);
                
            } catch (error) {
                console.error('Error loading history:', error);
                console.error('Error details:', error.message);
                console.error('Error stack:', error.stack);
                historyLoading.style.display = 'none';
                historyEmpty.style.display = 'block';
                historyEmpty.textContent = `Error loading history: ${error.message}`;
            }
        }
        
        // Load a specific conversation from Azure
        async function loadConversationFromAzure(sessionId) {
            try {
                console.log('Loading conversation:', sessionId);
                
                // First get all sessions, then find the specific one
                // The API doesn't support getting individual sessions directly
                const response = await fetch(`https://saxtechconversationlogs.azurewebsites.net/api/SaveConversationLog?action=get&email=${encodeURIComponent(currentAccount.username)}&range=all&code=w_j-EeXYy7G1yfUBkSVvlT5Hhafzg-eCNkaUOkOzzIveAzFu9NTlQw==`, {
                    method: 'GET',
                    headers: {}
                });
                
                if (!response.ok) {
                    throw new Error('Failed to load conversations');
                }
                
                const data = await response.json();
                
                // Find the specific session
                let sessions = [];
                if (Array.isArray(data)) {
                    sessions = data;
                } else if (data.sessions) {
                    sessions = data.sessions;
                } else if (data.conversations) {
                    sessions = data.conversations;
                }
                
                const targetSession = sessions.find(s => 
                    s.sessionId === sessionId || 
                    s.id === sessionId || 
                    s._id === sessionId
                );
                
                console.log('Found session:', targetSession);
                
                if (!targetSession) {
                    throw new Error('Session not found');
                }
                
                // Parse the conversation data - it can be in multiple formats
                let messages = [];
                try {
                    if (typeof targetSession.conversation === 'string') {
                        console.log('Parsing conversation string:', targetSession.conversation.substring(0, 200));
                        const parsed = JSON.parse(targetSession.conversation);
                        
                        // Check if parsed is array directly or object with messages
                        if (Array.isArray(parsed)) {
                            messages = parsed;
                            console.log('Conversation was array of messages');
                        } else if (parsed.messages) {
                            messages = parsed.messages;
                            console.log('Conversation was object with messages property');
                        }
                    } else if (Array.isArray(targetSession.conversation)) {
                        // Conversation is already an array of messages
                        messages = targetSession.conversation;
                        console.log('Conversation is array:', messages.length, 'messages');
                    } else if (targetSession.conversation && targetSession.conversation.messages) {
                        // Conversation is object with messages property
                        messages = targetSession.conversation.messages;
                        console.log('Conversation is object with messages:', messages.length);
                    } else if (targetSession.messages) {
                        // Messages at top level
                        messages = targetSession.messages;
                        console.log('Messages at top level:', messages.length);
                    }
                } catch (e) {
                    console.error('Error parsing conversation:', e);
                    console.error('Raw conversation data:', targetSession.conversation);
                }
                console.log('Messages found:', messages.length, messages);
                
                if (messages && messages.length > 0) {
                    // Clear current chat
                    chatMessages.innerHTML = '';
                    
                    // Load messages
                    messages.forEach(msg => {
                        console.log('Adding message:', msg);
                        addMessage(msg.role === 'user' ? 'user' : 'bot', msg.content, null, false);
                    });
                    
                    // Update conversation history
                    conversationHistory = messages;
                    
                    // Close history menu
                    toggleHistoryMenu();
                } else {
                    console.error('No messages found in session');
                    alert('This conversation appears to be empty.');
                }
            } catch (error) {
                console.error('Error loading conversation:', error);
                alert('Failed to load conversation');
            }
        }

        // Keep this for backward compatibility but rename it
        function loadHistoryFromLocalStorage() {
            const historyList = document.getElementById('historyList');
            const historyLoading = document.getElementById('historyLoading');
            const historyEmpty = document.getElementById('historyEmpty');
            
            // Hide loading
            historyLoading.style.display = 'none';
            
            // Get stored conversations from localStorage
            const storedConversations = [];
            
            // Check all localStorage keys for conversation data
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('megamind_conversation_')) {
                    try {
                        const data = JSON.parse(localStorage.getItem(key));
                        if (data && data.messages && data.messages.length > 0) {
                            storedConversations.push(data);
                        }
                    } catch (e) {
                        console.error('Error parsing conversation:', e);
                    }
                }
            }
            
            // Sort by timestamp (most recent first)
            storedConversations.sort((a, b) => {
                const timeA = new Date(a.timestamp || 0).getTime();
                const timeB = new Date(b.timestamp || 0).getTime();
                return timeB - timeA;
            });
            
            if (storedConversations.length === 0) {
                historyEmpty.style.display = 'block';
                historyList.innerHTML = '';
                return;
            }
            
            historyEmpty.style.display = 'none';
            
            // Display conversations
            let html = '';
            storedConversations.slice(0, 10).forEach((conv, index) => {
                const firstUserMessage = conv.messages.find(m => m.role === 'user');
                const firstBotResponse = conv.messages.find(m => m.role === 'assistant');
                
                // Generate a meaningful title from the first user message or bot response
                let title = 'Conversation';
                if (firstUserMessage && firstUserMessage.content) {
                    // Extract first 50 characters of user message as title
                    title = firstUserMessage.content.substring(0, 50);
                    if (firstUserMessage.content.length > 50) title += '...';
                } else if (firstBotResponse && firstBotResponse.content) {
                    // Use bot response if no user message
                    title = 'Response: ' + firstBotResponse.content.substring(0, 40) + '...';
                }
                
                // Generate preview from first exchange
                let preview = '';
                if (firstBotResponse && firstBotResponse.content) {
                    preview = firstBotResponse.content.substring(0, 100);
                    if (firstBotResponse.content.length > 100) preview += '...';
                }
                
                const timestamp = new Date(conv.timestamp || Date.now());
                const timeStr = timestamp.toLocaleString();
                
                html += `
                    <div class="history-item" onclick="loadConversation(${index})">
                        <div class="history-item-title">${escapeHtml(title)}</div>
                        <div class="history-item-time">${timeStr}</div>
                        ${preview ? `<div class="history-item-preview">${escapeHtml(preview)}</div>` : ''}
                    </div>
                `;
            });
            
            historyList.innerHTML = html;
        }

        function loadConversation(index) {
            // Get stored conversations
            const storedConversations = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('megamind_conversation_')) {
                    try {
                        const data = JSON.parse(localStorage.getItem(key));
                        if (data && data.messages) {
                            storedConversations.push(data);
                        }
                    } catch (e) {
                        console.error('Error parsing conversation:', e);
                    }
                }
            }
            
            // Sort by timestamp
            storedConversations.sort((a, b) => {
                const timeA = new Date(a.timestamp || 0).getTime();
                const timeB = new Date(b.timestamp || 0).getTime();
                return timeB - timeA;
            });
            
            if (storedConversations[index]) {
                const conversation = storedConversations[index];
                
                // Clear current chat
                chatMessages.innerHTML = '';
                
                // Load messages
                conversation.messages.forEach(msg => {
                    addMessage(msg.role === 'user' ? 'user' : 'bot', msg.content, null, false);
                });
                
                // Update conversation history
                conversationHistory = conversation.messages || [];
                
                // Close history menu
                toggleHistoryMenu();
            }
        }

        // Save session to Azure only - no localStorage limitations
        function saveSessionHistoryDropdown() {
            // This function is now just a wrapper for saveSessionHistory
            // All saving happens through Azure
            if (conversationHistory.length === 0) return;
            
            // Optionally save a temporary copy to localStorage for offline access
            const sessionData = {
                sessionId: sessionId,
                timestamp: new Date().toISOString(),
                messages: conversationHistory,
                userEmail: userProfile?.mail || currentAccount?.username || 'anonymous'
            };
            
            // Save current session only (not all sessions)
            const key = `megamind_current_session`;
            localStorage.setItem(key, JSON.stringify(sessionData));
        }
        
        // AI Profile Management
        let currentAIProfile = 'sage';  // Start with SAX MegaMind as default
        let currentWebhook = 'megamind-chat';
        const aiProfiles = {
            tax: {
                name: 'SAX CPA',
                webhook: 'megamind-cpa',
                avatar: '📋',
                description: 'Tax and accounting specialist',
                robotImage: 'robot-cpa.png',
                role: 'Tax & Accounting Expert',
                customInterface: {
                    onSelect: function() {
                        // Add Tax Search button under History button for CPA profile
                        const chatHeader = document.querySelector('.chat-header');
                        if (!document.getElementById('taxSearchDropdown')) {
                            // Create tax search dropdown container
                            const taxSearchDropdown = document.createElement('div');
                            taxSearchDropdown.id = 'taxSearchDropdown';
                            taxSearchDropdown.className = 'history-dropdown';
                            taxSearchDropdown.style.cssText = `
                                position: absolute;
                                left: 20px;
                                top: 50%;
                                transform: translateY(-50%);
                                z-index: 10001;
                            `;
                            
                            const taxSearchBtn = document.createElement('button');
                            taxSearchBtn.id = 'taxSearchToggleBtn';
                            taxSearchBtn.className = 'history-btn';
                            taxSearchBtn.innerHTML = 'Tax Dictionary';
                            taxSearchBtn.onclick = function() {
                                const taxSearchContainer = document.getElementById('taxSearchContainer');
                                const isVisible = taxSearchContainer.style.display === 'block';
                                
                                if (isVisible) {
                                    // Hide tax search
                                    taxSearchContainer.style.display = 'none';
                                    this.innerHTML = 'Tax Dictionary';
                                } else {
                                    // Show tax search
                                    taxSearchContainer.style.display = 'block';
                                    this.innerHTML = '✖ Close Dictionary';
                                    // Initialize tax search component if needed
                                    if (window.TaxSearchComponent && typeof window.TaxSearchComponent.init === 'function') {
                                        window.TaxSearchComponent.init('taxSearchContainer');
                                    }
                                }
                            };
                            
                            taxSearchDropdown.appendChild(taxSearchBtn);
                            
                            // Insert after the chat header
                            chatHeader.appendChild(taxSearchDropdown);
                        }
                    },
                    onDeselect: function() {
                        // Remove Tax Search dropdown and hide container
                        const taxSearchDropdown = document.getElementById('taxSearchDropdown');
                        if (taxSearchDropdown) {
                            taxSearchDropdown.remove();
                        }
                        const taxSearchContainer = document.getElementById('taxSearchContainer');
                        if (taxSearchContainer) {
                            taxSearchContainer.style.display = 'none';
                        }
                    }
                }
            },
            trainer: {
                name: 'SAX Trainer',
                webhook: 'megamind-trainer',
                avatar: '📚',
                description: 'Learning and development specialist',
                robotImage: 'robot-trainer.png',
                role: 'Learning & Development'
            },
            auditor: {
                name: 'SAX Auditor',
                webhook: 'megamind-auditor',
                avatar: '🔍',
                description: 'Audit and compliance expert',
                robotImage: 'robot-auditor.png',
                role: 'Audit & Compliance Expert'
            },
            sage: {
                name: 'SAX MegaMind',
                webhook: 'megamind-chat',  // Direct webhook for SAX MegaMind
                avatar: '🧠',
                description: 'General business intelligence assistant',
                robotImage: 'robot.png',
                role: 'General Business Assistant'
            }
        };

        // DOM elements
        const authOverlay = document.getElementById('authOverlay');
        const signInBtn = document.getElementById('signInBtn');
        const signOutBtn = document.getElementById('signOutBtn');
        const userProfileDiv = document.getElementById('userProfile');
        const mainApp = document.getElementById('mainApp');
        const userName = document.getElementById('userName');
        const userRole = document.getElementById('userRole');
        const userLocation = document.getElementById('userLocation');
        const userAvatar = document.getElementById('userAvatar');
        const adminBadge = document.getElementById('adminBadge');
        const chatMessages = document.getElementById('chatMessages');
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        const voiceBtn = document.getElementById('voiceBtn');
        const speakerIcon = document.getElementById('speakerIcon');
        const statusText = document.getElementById('statusText');
        const voiceSelect = document.getElementById('voiceSelect');
        const conversationState = document.getElementById('conversationState');
        let previewAudio = null;
        const fileBtn = document.getElementById('fileBtn');
        
        // Debug: Track attachedFiles changes
        window.debugAttachments = function() {
            console.log('Current attachedFiles:', attachedFiles);
            return attachedFiles;
        };
        const resetBtn = document.getElementById('resetBtn');
        let conversationStopped = false;  // Track if conversation is manually stopped

        // Initialize carousel visibility
        function initializeCarousel() {
            const cards = document.querySelectorAll('.big-personality-card');
            cards.forEach((card, index) => {
                card.classList.remove('active', 'side-visible', 'back-hidden');
                if (index === 0) {
                    card.classList.add('active'); // First card is active
                } else if (index === 1 || index === 3) {
                    card.classList.add('side-visible'); // Side cards
                } else if (index === 2) {
                    card.classList.add('back-hidden'); // Back card
                }
            });
        }
        
        // Initialize application
        async function initialize() {
            console.log('Initializing MegaMind SAX...');
            
            // Generate new session ID for this page load
            sessionId = generateSessionId();
            console.log('New session ID:', sessionId);
            
            // Initialize ElevenLabs API key if not set
            if (!localStorage.getItem('elevenlabs_api_key')) {
                localStorage.setItem('elevenlabs_api_key', 'sk_94c95a3f46355ef03ad7cc214059cccfd2c492fc1571a2bf');
                console.log('ElevenLabs API key initialized');
            }
            
            // Initialize carousel visibility
            initializeCarousel();
            
            // Initialize TTS toggle handler
            const ttsToggle = document.getElementById('ttsToggle');
            const ttsStatus = document.getElementById('ttsStatus');
            
            ttsToggle.addEventListener('change', () => {
                if (ttsToggle.checked) {
                    ttsStatus.textContent = 'Audio: ON';
                    ttsStatus.style.color = 'rgba(255,215,0,0.8)';
                    statusText.textContent = 'Audio enabled. Tap speaker for conversational mode';
                    // Update slider visual
                    document.getElementById('ttsSlider').style.backgroundColor = 'rgba(255,215,0,0.8)';
                    document.getElementById('sliderKnob').style.transform = 'translateX(20px)';
                } else {
                    ttsStatus.textContent = 'Audio: OFF';
                    ttsStatus.style.color = 'rgba(255,255,255,0.6)';
                    statusText.textContent = 'Turn on Audio, then tap speaker for conversational mode';
                    // Update slider visual
                    document.getElementById('ttsSlider').style.backgroundColor = '#ccc';
                    document.getElementById('sliderKnob').style.transform = 'translateX(0)';
                    
                        // If conversational mode is active, stop it
                        if (voiceInteractionActive) {
                            voiceInteractionActive = false;
                            conversationStopped = true;
                            
                            // Stop any ongoing recognition
                            if (recognition && recognitionActive) {
                                recognition.stop();
                            }
                            
                            // Stop any playing audio
                            stopAudio();
                            
                            // Visual feedback
                            speakerIcon.classList.remove('active', 'listening');
                            conversationState.style.display = 'none';
                            
                            // Update status text
                            statusText.textContent = 'Turn on Audio, then tap speaker for conversational mode';
                            statusText.classList.remove('listening');
                            
                            // Clear volume bars
                            clearVolumeAnimation();
                        }
                }
            });
            
            // Initialize MSAL
            console.log('Initializing MSAL...');
            if (initializeMSAL()) {
                console.log('MSAL initialized successfully');
                await handleRedirectPromise();
                const account = getAccount();
                if (account) {
                    console.log('User is already signed in:', account);
                    showMainApp();
                } else {
                    console.log('User is not signed in');
                    showSignInPrompt();
                }
            } else {
                console.error('Failed to initialize MSAL');
                document.getElementById('authMessage').textContent = 'Authentication service is currently unavailable. Please try again later.';
                showSignInPrompt();
            }
        }
        
        // Initialize MSAL redirect promise handling
        async function handleRedirectPromise() {
            try {
                const response = await msalInstance.handleRedirectPromise();
                if (response !== null) {
                    console.log('Redirect response received:', response);
                    currentAccount = response.account;
                    await loadUserProfile();
                    return true;
                }
            } catch (error) {
                console.error('Error handling redirect promise:', error);
            }
            return false;
        }
        
        function getAccount() {
            if (!msalInstance) return null;
            const currentAccounts = msalInstance.getAllAccounts();
            if (currentAccounts.length === 0) {
                return null;
            } else if (currentAccounts.length > 1) {
                // Multiple accounts available - use first one
                console.log('Multiple accounts found, using first one:', currentAccounts[0]);
                return currentAccounts[0];
            } else {
                return currentAccounts[0];
            }
        }
        
        async function signIn() {
            if (!msalInstance) {
                console.error('MSAL instance not available');
                alert('Authentication service is not available. Please refresh the page and try again.');
                return;
            }
            
            try {
                console.log('Initiating sign-in...');
                const loginResponse = await msalInstance.loginPopup(loginRequest);
                console.log('Login response:', loginResponse);
                currentAccount = loginResponse.account;
                await loadUserProfile();
                showMainApp();
            } catch (error) {
                console.error('Sign-in error:', error);
                if (error.errorCode === 'popup_window_error' || error.errorCode === 'user_cancelled') {
                    // Fallback to redirect method
                    console.log('Popup failed, falling back to redirect...');
                    try {
                        await msalInstance.loginRedirect(loginRequest);
                    } catch (redirectError) {
                        console.error('Redirect sign-in also failed:', redirectError);
                        alert('Sign-in failed. Please try again or contact support.');
                    }
                } else {
                    alert(`Sign-in failed: ${error.errorMessage || error.message || 'Unknown error'}`);
                }
            }
        }
        
        async function signOut() {
            if (!msalInstance || !currentAccount) return;
            
            try {
                await msalInstance.logoutPopup({
                    account: currentAccount,
                    postLogoutRedirectUri: window.location.origin
                });
                currentAccount = null;
                userProfile = null;
                showSignInPrompt();
            } catch (error) {
                console.error('Sign-out error:', error);
                // Force sign out even if popup fails
                currentAccount = null;
                userProfile = null;
                showSignInPrompt();
            }
        }
        
        async function loadUserProfile() {
            if (!msalInstance || !currentAccount) return;
            
            try {
                const tokenRequest = {
                    scopes: ['User.Read'],
                    account: currentAccount
                };
                
                const response = await msalInstance.acquireTokenSilent(tokenRequest);
                const accessToken = response.accessToken;
                
                const graphResponse = await fetch('https://graph.microsoft.com/v1.0/me', {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });
                
                if (graphResponse.ok) {
                    userProfile = await graphResponse.json();
                    console.log('User profile loaded:', userProfile);
                    updateUserInterface();
                } else {
                    console.error('Failed to load user profile from Microsoft Graph');
                }
            } catch (error) {
                console.error('Error loading user profile:', error);
            }
        }
        
        function updateUserInterface() {
            if (userProfile) {
                userName.textContent = userProfile.displayName || 'User';
                userRole.textContent = userProfile.jobTitle || 'SAX Team Member';
                userLocation.textContent = userProfile.officeLocation || userProfile.city || 'SAX Advisory Group';
                userAvatar.textContent = userProfile.displayName ? userProfile.displayName[0].toUpperCase() : 'U';
                
                // Check if user is an admin (you can customize this logic)
                const adminEmails = ['thughes@saxtechnology.com', 'thughes@saxadvisorygroup.com', 'admin@saxadvisorygroup.com'];
                const isAdmin = adminEmails.includes(userProfile.mail || currentAccount?.username || '');
                
                if (isAdmin) {
                    adminBadge.classList.remove('hidden');
                } else {
                    adminBadge.classList.add('hidden');
                }
            }
        }
        
        function showSignInPrompt() {
            authOverlay.classList.remove('hidden');
            userProfileDiv.classList.add('hidden');
            mainApp.classList.add('hidden');
        }
        
        function showMainApp() {
            authOverlay.classList.add('hidden');
            userProfileDiv.classList.remove('hidden');
            mainApp.classList.remove('hidden');
            
            // Load user profile if not already loaded
            if (!userProfile && currentAccount) {
                loadUserProfile();
            }
        }
        
        // Add message to chat
        function addMessage(sender, content, isTypingIndicator = false, saveToHistory = true) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            const avatarDiv = document.createElement('div');
            avatarDiv.className = 'message-avatar';
            
            if (sender === 'user') {
                avatarDiv.textContent = userProfile?.displayName ? userProfile.displayName[0].toUpperCase() : 'U';
            } else {
                // Use current AI profile's robot image
                const currentProfile = aiProfiles[currentAIProfile] || aiProfiles.sage;
                avatarDiv.innerHTML = `<img src="${currentProfile.robotImage}" alt="${currentProfile.name}" onerror="this.style.display='none'; this.parentNode.innerHTML='${currentProfile.avatar}';">`;
            }
            
            const bubbleDiv = document.createElement('div');
            bubbleDiv.className = 'message-bubble';
            
            if (isTypingIndicator) {
                bubbleDiv.className += ' typing-indicator';
                bubbleDiv.innerHTML = '<div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>';
            } else {
                bubbleDiv.innerHTML = content;
            }
            
            messageDiv.appendChild(avatarDiv);
            messageDiv.appendChild(bubbleDiv);
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            // Add to conversation history (but not typing indicators)
            if (saveToHistory && !isTypingIndicator) {
                const historyEntry = {
                    role: sender === 'user' ? 'user' : 'assistant',
                    content: content
                };
                conversationHistory.push(historyEntry);
                
                // Save to Azure after each message
                saveSessionHistory();
            }
            
            return messageDiv;
        }
        
        // Save session history to Azure Function
        async function saveSessionHistory() {
            if (!currentAccount || conversationHistory.length === 0) {
                return;
            }
            
            try {
                // Always save complete session history
                const sessionData = {
                    sessionId: sessionId,
                    userEmail: userProfile?.mail || currentAccount?.username || 'anonymous',
                    userName: userProfile?.displayName || 'Anonymous User',
                    timestamp: new Date().toISOString(),
                    aiProfile: currentAIProfile,
                    webhook: currentWebhook,
                    conversation: conversationHistory,  // Full array of messages
                    messageCount: conversationHistory.length
                };
                
                console.log('Saving session history to Azure:', {
                    sessionId: sessionData.sessionId,
                    messageCount: sessionData.messageCount,
                    userEmail: sessionData.userEmail
                });
                
                const response = await fetch('https://saxtechconversationlogs.azurewebsites.net/api/SaveConversationLog?code=w_j-EeXYy7G1yfUBkSVvlT5Hhafzg-eCNkaUOkOzzIveAzFu9NTlQw==', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(sessionData)
                });
                
                if (response.ok) {
                    console.log('Session history saved to Azure successfully');
                    // Also save to localStorage as backup
                    saveSessionHistoryDropdown();
                } else {
                    const errorText = await response.text();
                    console.error('Failed to save session history to Azure:', response.status, errorText);
                }
            } catch (error) {
                console.error('Error saving session history to Azure:', error);
                // Fall back to localStorage only
                saveSessionHistoryDropdown();
            }
        }
        
        // Utility function for HTML escaping
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Send message function
        async function sendMessage() {
            const message = messageInput.value.trim();
            const files = attachedFiles;
            
            if (!message && (!files || files.length === 0)) return;
            
            // Disable send button to prevent double-sending
            sendBtn.disabled = true;
            
            try {
                // Check if we should stop current generation instead
                if (isChatRunning) {
                    // Stop current generation
                    if (abortController) {
                        abortController.abort();
                        abortController = null;
                    }
                    isChatRunning = false;
                    sendBtn.classList.remove('stop-mode');
                    sendBtn.innerHTML = '➤';
                    sendBtn.title = 'Send message';
                    
                    // Remove typing indicator if present
                    const typingIndicator = document.querySelector('.typing-indicator');
                    if (typingIndicator) {
                        typingIndicator.closest('.message').remove();
                    }
                    
                    sendBtn.disabled = false;
                    return;
                }
                
                // Clear input
                messageInput.value = '';
                
                // Add user message to chat
                let userMessage = message;
                if (files && files.length > 0) {
                    userMessage += `<br><small>📎 ${files.length} file(s) attached</small>`;
                }
                addMessage('user', userMessage);
                
                // Set up for generation stopping
                isChatRunning = true;
                sendBtn.classList.add('stop-mode');
                sendBtn.innerHTML = '⏹';
                sendBtn.title = 'Stop generation';
                
                // Add typing indicator
                const typingMessage = addMessage('bot', '', true, false);
                
                // Set up abort controller
                abortController = new AbortController();
                
                // Prepare the request body
                const requestBody = {
                    message: message,
                    files: files || [],
                    conversationHistory: conversationHistory.slice(-10) // Last 10 messages for context
                };
                
                // Make request to the appropriate webhook
                const webhookUrl = `https://hooks.zapier.com/hooks/catch/19095038/${currentWebhook}/`;
                console.log('Sending to webhook:', webhookUrl);
                
                const response = await fetch(webhookUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestBody),
                    signal: abortController.signal
                });
                
                // Remove typing indicator
                typingMessage.remove();
                
                if (response.ok) {
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    let buffer = '';
                    let botMessageDiv = null;
                    let botMessageBubble = null;
                    let currentContent = '';
                    
                    try {
                        while (true) {
                            const { done, value } = await reader.read();
                            
                            if (done) break;
                            
                            buffer += decoder.decode(value, { stream: true });
                            
                            // Process complete lines
                            while (buffer.includes('\n')) {
                                const lineEnd = buffer.indexOf('\n');
                                const line = buffer.slice(0, lineEnd).trim();
                                buffer = buffer.slice(lineEnd + 1);
                                
                                if (line.startsWith('data: ')) {
                                    const data = line.slice(6);
                                    
                                    if (data === '[DONE]') {
                                        break;
                                    }
                                    
                                    try {
                                        const chunk = JSON.parse(data);
                                        
                                        if (chunk.choices && chunk.choices[0] && chunk.choices[0].delta && chunk.choices[0].delta.content) {
                                            const content = chunk.choices[0].delta.content;
                                            currentContent += content;
                                            
                                            // Create or update the bot message
                                            if (!botMessageDiv) {
                                                botMessageDiv = addMessage('bot', currentContent, false, false);
                                                botMessageBubble = botMessageDiv.querySelector('.message-bubble');
                                            } else {
                                                botMessageBubble.innerHTML = currentContent;
                                                chatMessages.scrollTop = chatMessages.scrollHeight;
                                            }
                                        }
                                    } catch (parseError) {
                                        console.error('Error parsing JSON chunk:', parseError, 'Data:', data);
                                        // Try to handle partial JSON
                                        if (data.trim()) {
                                            currentContent += data;
                                            if (!botMessageDiv) {
                                                botMessageDiv = addMessage('bot', currentContent, false, false);
                                                botMessageBubble = botMessageDiv.querySelector('.message-bubble');
                                            } else {
                                                botMessageBubble.innerHTML = currentContent;
                                                chatMessages.scrollTop = chatMessages.scrollHeight;
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    } catch (streamError) {
                        if (streamError.name === 'AbortError') {
                            console.log('Stream aborted by user');
                            if (botMessageDiv && currentContent.trim()) {
                                // Keep partial content
                                botMessageBubble.innerHTML = currentContent + ' <em>[Stopped]</em>';
                            }
                        } else {
                            throw streamError;
                        }
                    }
                    
                    // Final update to conversation history with complete bot response
                    if (currentContent.trim()) {
                        conversationHistory.push({
                            role: 'assistant',
                            content: currentContent.trim()
                        });
                        
                        // Save the completed conversation
                        await saveSessionHistory();
                        
                        // Text-to-speech if enabled
                        const ttsToggle = document.getElementById('ttsToggle');
                        if (ttsToggle.checked) {
                            await textToSpeech(currentContent.trim());
                        }
                    } else {
                        // No content received, show error
                        addMessage('bot', 'I apologize, but I didn\'t receive a proper response. Please try again.');
                    }
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                if (error.name === 'AbortError') {
                    console.log('Request was aborted by user');
                } else {
                    console.error('Error sending message:', error);
                    // Remove typing indicator if present
                    const typingIndicator = document.querySelector('.typing-indicator');
                    if (typingIndicator) {
                        typingIndicator.closest('.message').remove();
                    }
                    addMessage('bot', `Sorry, I encountered an error: ${error.message}. Please try again.`);
                }
            } finally {
                // Reset send button state
                isChatRunning = false;
                sendBtn.classList.remove('stop-mode');
                sendBtn.innerHTML = '➤';
                sendBtn.title = 'Send message';
                sendBtn.disabled = false;
                
                // Clear attached files after sending
                attachedFiles = [];
                window.attachedFiles = attachedFiles;  // Update window reference
                updateFileButtonDisplay();
            }
        }
        
        // Text-to-speech using ElevenLabs
        async function textToSpeech(text) {
            if (!text) return;
            
            try {
                const apiKey = localStorage.getItem('elevenlabs_api_key');
                if (!apiKey) {
                    console.error('ElevenLabs API key not found');
                    return;
                }
                
                const voiceId = voiceSelect.value || 'rachel';
                
                // Clean up text for TTS
                const cleanText = text.replace(/<[^>]*>/g, '').replace(/\n/g, ' ').replace(/\s+/g, ' ').trim();
                
                if (cleanText.length === 0) {
                    console.log('No text content for TTS after cleaning');
                    return;
                }
                
                // Limit text length for TTS (ElevenLabs has limits)
                const maxLength = 1000;
                const ttsText = cleanText.length > maxLength ? cleanText.substring(0, maxLength) + '...' : cleanText;
                
                console.log('Generating TTS for:', ttsText.substring(0, 100) + '...');
                
                const response = await fetch(`https://api.elevenlabs.io/v1/text-to-speech/${voiceId}`, {
                    method: 'POST',
                    headers: {
                        'Accept': 'audio/mpeg',
                        'Content-Type': 'application/json',
                        'xi-api-key': apiKey
                    },
                    body: JSON.stringify({
                        text: ttsText,
                        model_id: 'eleven_monolingual_v1',
                        voice_settings: {
                            stability: 0.5,
                            similarity_boost: 0.5
                        }
                    })
                });
                
                if (response.ok) {
                    const audioBlob = await response.blob();
                    const audioUrl = URL.createObjectURL(audioBlob);
                    
                    // Stop any currently playing audio
                    stopAudio();
                    
                    currentAudio = new Audio(audioUrl);
                    isAISpeaking = true;
                    
                    currentAudio.onended = () => {
                        isAISpeaking = false;
                        URL.revokeObjectURL(audioUrl);
                        
                        // If in conversational mode and TTS enabled, restart listening
                        if (voiceInteractionActive && !conversationStopped) {
                            setTimeout(() => {
                                if (voiceInteractionActive && !isListening && !isAISpeaking) {
                                    startListening();
                                }
                            }, 500); // Brief pause before restarting
                        }
                    };
                    
                    currentAudio.onerror = (e) => {
                        console.error('Audio playback error:', e);
                        isAISpeaking = false;
                        URL.revokeObjectURL(audioUrl);
                    };
                    
                    await currentAudio.play();
                    console.log('TTS audio playing');
                } else {
                    const errorText = await response.text();
                    console.error('ElevenLabs TTS error:', response.status, errorText);
                }
            } catch (error) {
                console.error('TTS error:', error);
                isAISpeaking = false;
            }
        }
        
        // Stop current audio
        function stopAudio() {
            if (currentAudio) {
                currentAudio.pause();
                currentAudio.currentTime = 0;
                isAISpeaking = false;
            }
        }
        
        // Reset conversation
        function resetConversation() {
            if (confirm('Are you sure you want to reset the conversation? This will clear all messages.')) {
                chatMessages.innerHTML = '';
                conversationHistory = [];
                attachedFiles = [];
                window.attachedFiles = attachedFiles;
                updateFileButtonDisplay();
                
                // Generate new session ID
                sessionId = generateSessionId();
                console.log('New session ID after reset:', sessionId);
                
                // Stop any ongoing processes
                if (abortController) {
                    abortController.abort();
                    abortController = null;
                }
                
                stopAudio();
                
                // Reset UI states
                isChatRunning = false;
                sendBtn.classList.remove('stop-mode');
                sendBtn.innerHTML = '➤';
                sendBtn.title = 'Send message';
                sendBtn.disabled = false;
            }
        }
        
        // File handling
        function handleFileSelection() {
            const fileInput = document.getElementById('fileInput');
            const files = Array.from(fileInput.files);
            
            console.log('Files selected:', files.length);
            
            if (files.length === 0) return;
            
            files.forEach(file => {
                console.log('Processing file:', file.name, 'Size:', file.size, 'Type:', file.type);
                
                // Check file size (10MB limit)
                if (file.size > 10 * 1024 * 1024) {
                    alert(`File "${file.name}" is too large. Maximum file size is 10MB.`);
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    const fileData = {
                        name: file.name,
                        type: file.type || 'application/octet-stream',
                        size: file.size,
                        content: e.target.result, // This will be the base64 data URL
                        lastModified: file.lastModified
                    };
                    
                    attachedFiles.push(fileData);
                    window.attachedFiles = attachedFiles;  // Update window reference
                    updateFileButtonDisplay();
                    console.log('File added to attachments:', fileData.name);
                };
                
                reader.onerror = function(e) {
                    console.error('Error reading file:', e);
                    alert(`Error reading file "${file.name}".`);
                };
                
                reader.readAsDataURL(file);
            });
            
            // Clear the input
            fileInput.value = '';
        }
        
        function updateFileButtonDisplay() {
            const fileBtn = document.getElementById('fileBtn');
            if (attachedFiles.length > 0) {
                fileBtn.innerHTML = `📎 ${attachedFiles.length}`;
                fileBtn.title = `${attachedFiles.length} file(s) attached. Click to add more.`;
                fileBtn.style.background = 'linear-gradient(135deg, #4CAF50, #45a049)';
            } else {
                fileBtn.innerHTML = '📎';
                fileBtn.title = 'Attach file';
                fileBtn.style.background = 'linear-gradient(135deg, #FFD700, #FFA500)';
            }
        }
        
        // Voice input with WebKit Speech Recognition
        let silenceTimeout = null;
        let finalTranscript = '';
        let interimTranscript = '';
        
        function initializeVoiceRecognition() {
            if (!('webkitSpeechRecognition' in window)) {
                console.warn('Speech recognition not supported in this browser');
                return false;
            }
            
            recognition = new webkitSpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.lang = 'en-US';
            recognition.maxAlternatives = 1;
            
            recognition.onstart = function() {
                console.log('Speech recognition started');
                recognitionActive = true;
                isListening = true;
                updateVoiceUI();
                
                // Clear any existing timeout
                if (silenceTimeout) {
                    clearTimeout(silenceTimeout);
                    silenceTimeout = null;
                }
            };
            
            recognition.onresult = function(event) {
                finalTranscript = '';
                interimTranscript = '';
                
                // Process all results
                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript;
                    } else {
                        interimTranscript += transcript;
                    }
                }
                
                // Update input field with current transcript
                const displayText = finalTranscript + interimTranscript;
                messageInput.value = displayText;
                
                // If we have final transcript, reset silence timeout
                if (finalTranscript) {
                    console.log('Final transcript received:', finalTranscript);
                    
                    // Reset silence timeout
                    if (silenceTimeout) {
                        clearTimeout(silenceTimeout);
                    }
                    
                    // Set new timeout for silence detection
                    silenceTimeout = setTimeout(() => {
                        console.log('Silence detected, processing speech...');
                        processVoiceInput();
                    }, 2000); // 2 seconds of silence
                }
            };
            
            recognition.onerror = function(event) {
                console.error('Speech recognition error:', event.error);
                
                if (event.error === 'no-speech') {
                    console.log('No speech detected, restarting...');
                    if (voiceInteractionActive && !conversationStopped) {
                        setTimeout(() => {
                            if (!isAISpeaking && voiceInteractionActive) {
                                restartListening();
                            }
                        }, 1000);
                    }
                } else if (event.error === 'network') {
                    console.log('Network error in speech recognition');
                    statusText.textContent = 'Network error. Check your connection.';
                } else {
                    console.log('Speech recognition error, will retry if needed');
                }
                
                recognitionActive = false;
                isListening = false;
                updateVoiceUI();
            };
            
            recognition.onend = function() {
                console.log('Speech recognition ended');
                recognitionActive = false;
                isListening = false;
                updateVoiceUI();
                
                // Clear silence timeout
                if (silenceTimeout) {
                    clearTimeout(silenceTimeout);
                    silenceTimeout = null;
                }
                
                // Auto-restart if in conversational mode and not manually stopped
                if (voiceInteractionActive && !conversationStopped && !isAISpeaking) {
                    console.log('Auto-restarting recognition...');
                    setTimeout(() => {
                        if (voiceInteractionActive && !conversationStopped && !isAISpeaking) {
                            startListening();
                        }
                    }, 500);
                }
            };
            
            return true;
        }
        
        function processVoiceInput() {
            if (silenceTimeout) {
                clearTimeout(silenceTimeout);
                silenceTimeout = null;
            }
            
            const transcript = messageInput.value.trim();
            if (transcript) {
                console.log('Processing voice input:', transcript);
                
                // Stop listening temporarily
                if (recognition && recognitionActive) {
                    recognition.stop();
                }
                
                // Send the message
                sendMessage();
                
                // Clear transcripts
                finalTranscript = '';
                interimTranscript = '';
            }
        }
        
        function startListening() {
            if (!recognition) {
                if (!initializeVoiceRecognition()) {
                    console.error('Cannot initialize voice recognition');
                    return;
                }
            }
            
            if (recognitionActive) {
                console.log('Recognition already active');
                return;
            }
            
            try {
                console.log('Starting voice recognition...');
                recognition.start();
            } catch (error) {
                console.error('Error starting recognition:', error);
                recognitionActive = false;
                isListening = false;
                updateVoiceUI();
            }
        }
        
        function stopListening() {
            if (recognition && recognitionActive) {
                console.log('Stopping voice recognition...');
                recognition.stop();
            }
            
            if (silenceTimeout) {
                clearTimeout(silenceTimeout);
                silenceTimeout = null;
            }
            
            recognitionActive = false;
            isListening = false;
            updateVoiceUI();
        }
        
        function restartListening() {
            console.log('Restarting voice recognition...');
            stopListening();
            setTimeout(() => {
                if (voiceInteractionActive && !conversationStopped) {
                    startListening();
                }
            }, 500);
        }
        
        function updateVoiceUI() {
            if (isListening) {
                speakerIcon.classList.add('listening');
                statusText.classList.add('listening');
                statusText.textContent = 'Listening... Speak now';
                conversationState.textContent = 'Listening';
                conversationState.classList.add('listening');
                conversationState.style.display = 'inline-block';
                
                // Start gentle wave animation
                startVolumeAnimation();
            } else {
                speakerIcon.classList.remove('listening');
                statusText.classList.remove('listening');
                
                if (voiceInteractionActive) {
                    if (isAISpeaking) {
                        statusText.textContent = 'AI is speaking...';
                        conversationState.textContent = 'AI Speaking';
                        conversationState.classList.remove('listening');
                    } else {
                        statusText.textContent = 'Ready to listen. Tap to stop conversational mode.';
                        conversationState.textContent = 'Ready';
                        conversationState.classList.remove('listening');
                    }
                } else {
                    const ttsToggle = document.getElementById('ttsToggle');
                    if (ttsToggle.checked) {
                        statusText.textContent = 'Audio enabled. Tap speaker for conversational mode';
                    } else {
                        statusText.textContent = 'Turn on Audio, then tap speaker for conversational mode';
                    }
                    conversationState.style.display = 'none';
                }
                
                // Stop volume animation
                clearVolumeAnimation();
            }
        }
        
        function startVolumeAnimation() {
            const bars = document.querySelectorAll('.volume-bar');
            bars.forEach(bar => {
                bar.classList.add('wave');
            });
        }
        
        function clearVolumeAnimation() {
            const bars = document.querySelectorAll('.volume-bar');
            bars.forEach(bar => {
                bar.classList.remove('wave', 'active');
            });
        }
        
        // Toggle conversational mode
        function toggleConversationalMode() {
            const ttsToggle = document.getElementById('ttsToggle');
            
            // Check if audio is enabled
            if (!ttsToggle.checked) {
                statusText.textContent = 'Please enable Audio first';
                return;
            }
            
            if (!voiceInteractionActive) {
                // Start conversational mode
                console.log('Starting conversational mode');
                voiceInteractionActive = true;
                conversationStopped = false;
                
                // Initialize voice recognition if not already done
                if (!recognition) {
                    if (!initializeVoiceRecognition()) {
                        console.error('Failed to initialize voice recognition');
                        voiceInteractionActive = false;
                        statusText.textContent = 'Voice recognition not supported';
                        return;
                    }
                }
                
                // Start listening
                startListening();
                
                // Show stop button
                document.getElementById('stopConversationBtn').style.display = 'inline-block';
                
            } else {
                // Stop conversational mode
                console.log('Stopping conversational mode');
                voiceInteractionActive = false;
                conversationStopped = true;
                
                // Stop listening
                stopListening();
                
                // Stop any playing audio
                stopAudio();
                
                // Update UI
                updateVoiceUI();
                
                // Hide stop button
                document.getElementById('stopConversationBtn').style.display = 'none';
            }
        }
        
        // Event Listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Wait a bit for MSAL to load
            setTimeout(() => {
                initialize();
            }, 100);
        });
        
        // Sign in/out button handlers
        signInBtn?.addEventListener('click', signIn);
        signOutBtn?.addEventListener('click', signOut);
        
        // Chat input handlers
        messageInput?.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
        
        sendBtn?.addEventListener('click', sendMessage);
        resetBtn?.addEventListener('click', resetConversation);
        
        // Voice button handler  
        voiceBtn?.addEventListener('click', function() {
            if (!recognition && !initializeVoiceRecognition()) {
                alert('Speech recognition is not supported in your browser.');
                return;
            }
            
            if (isListening) {
                stopListening();
                // Process any current transcript
                if (messageInput.value.trim()) {
                    sendMessage();
                }
            } else {
                startListening();
            }
        });
        
        // Speaker icon for conversational mode
        speakerIcon?.addEventListener('click', toggleConversationalMode);
        
        // Stop conversation button
        document.getElementById('stopConversationBtn')?.addEventListener('click', function() {
            if (voiceInteractionActive) {
                toggleConversationalMode();
            }
        });
        
        // File input handler
        fileBtn?.addEventListener('click', function() {
            document.getElementById('fileInput').click();
        });
        
        document.getElementById('fileInput')?.addEventListener('change', handleFileSelection);
        
        // Personality selector
        document.getElementById('personalitySelector')?.addEventListener('click', function() {
            const overlay = document.getElementById('personalityOverlay');
            overlay.classList.add('show');
        });
        
        // Carousel navigation
        document.getElementById('carouselClose')?.addEventListener('click', function() {
            const overlay = document.getElementById('personalityOverlay');
            overlay.classList.remove('show');
        });
        
        document.getElementById('carouselPrev')?.addEventListener('click', function() {
            navigateCarousel(-1);
        });
        
        document.getElementById('carouselNext')?.addEventListener('click', function() {
            navigateCarousel(1);
        });
        
        // Carousel card click handlers
        document.querySelectorAll('.big-personality-card').forEach((card, index) => {
            card.addEventListener('click', function() {
                const personality = card.getAttribute('data-personality');
                selectPersonality(personality);
            });
        });
        
        function navigateCarousel(direction) {
            const cards = document.querySelectorAll('.big-personality-card');
            const totalCards = cards.length;
            
            currentCarouselRotation += direction * 90;
            
            // Update 3D rotation
            const carousel = document.getElementById('carousel3d');
            carousel.style.transform = `rotateY(${currentCarouselRotation}deg)`;
            
            // Update card visibility classes
            cards.forEach((card, index) => {
                const adjustedIndex = ((index * 90 - currentCarouselRotation) / 90 + totalCards) % totalCards;
                
                card.classList.remove('active', 'side-visible', 'back-hidden');
                
                if (adjustedIndex === 0) {
                    card.classList.add('active');
                } else if (adjustedIndex === 1 || adjustedIndex === 3) {
                    card.classList.add('side-visible');
                } else {
                    card.classList.add('back-hidden');
                }
            });
        }
        
        function selectPersonality(personality) {
            console.log('Selecting personality:', personality);
            
            // Call onDeselect for current profile if it exists
            const currentProfile = aiProfiles[currentAIProfile];
            if (currentProfile && currentProfile.customInterface && currentProfile.customInterface.onDeselect) {
                currentProfile.customInterface.onDeselect();
            }
            
            // Update current profile
            currentAIProfile = personality;
            const newProfile = aiProfiles[personality] || aiProfiles.sage;
            currentWebhook = newProfile.webhook;
            
            // Update UI
            document.getElementById('currentPersonalityName').textContent = newProfile.name;
            document.getElementById('personalityIndicator').textContent = newProfile.role;
            
            // Update avatar in header
            const avatarContainer = document.getElementById('currentPersonalityAvatar');
            avatarContainer.innerHTML = `<img src="${newProfile.robotImage}" alt="${newProfile.name}" onerror="this.style.display='none'; this.parentNode.innerHTML='${newProfile.avatar}';">`;
            
            // Call onSelect for new profile if it exists
            if (newProfile.customInterface && newProfile.customInterface.onSelect) {
                newProfile.customInterface.onSelect();
            }
            
            // Close overlay
            document.getElementById('personalityOverlay').classList.remove('show');
            
            console.log(`Switched to ${newProfile.name} (${newProfile.webhook})`);
        }
        
        // Document portal function
        function openDocumentPortal() {
            window.open('https://saxadvisorygroup.sharepoint.com', '_blank');
        }
        
        // Make some functions globally available
        window.openDocumentPortal = openDocumentPortal;
        window.selectPersonality = selectPersonality;
        window.navigateCarousel = navigateCarousel;
        
        // Close history menu when clicking outside
        document.addEventListener('click', function(event) {
            const historyMenu = document.getElementById('historyMenu');
            const historyBtn = document.getElementById('historyBtn');
            
            // Check if click is outside both menu and button
            if (historyMenuOpen && !historyMenu.contains(event.target) && !historyBtn.contains(event.target)) {
                toggleHistoryMenu();
            }
        });
        
        // Escape key to close history menu
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape' && historyMenuOpen) {
                toggleHistoryMenu();
            }
        });
        
        console.log('MegaMind SAX script loaded successfully');
    </script>
</body>
</html>