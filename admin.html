<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MegaMind Admin - System Configuration</title>
    <!-- cache-bust: v2025-09-23-2248 fix stray else + robust tab switching -->
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="alternate icon" href="/favicon.ico">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f8fafc;
            color: #1e293b;
            line-height: 1.6;
            font-size: 14px;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px 40px;
        }

        .header {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: white;
            padding: 24px 40px;
            margin-bottom: 30px;
            border-bottom: 3px solid #3b82f6;
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .company-logo {
            width: 48px;
            height: 48px;
            background: #3b82f6;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 20px;
            color: white;
        }

        .company-name {
            font-size: 24px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .portal-title {
            font-size: 14px;
            color: #94a3b8;
            font-weight: 400;
            margin-top: 2px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            background: white;
            padding: 10px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid #e2e8f0;
        }

        .tab-btn {
            padding: 12px 24px;
            border: none;
            background: transparent;
            color: #64748b;
            font-weight: 500;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.2s ease;
            font-size: 14px;
        }

        .tab-btn.active {
            background: #3b82f6;
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .admin-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .admin-card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid #e2e8f0;
        }

        .admin-card.full-width {
            grid-column: 1 / -1;
        }

        .admin-card h2 {
            color: #1e293b;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e2e8f0;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            color: #374151;
            font-size: 13px;
            font-weight: 500;
            margin-bottom: 6px;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 13px;
            transition: all 0.2s ease;
            background: white;
            color: #374151;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .form-group textarea {
            min-height: 120px;
            resize: vertical;
        }

        .btn {
            padding: 12px 16px;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-right: 10px;
        }

        .btn-primary {
            background: #3b82f6;
            color: white;
        }

        .btn-primary:hover {
            background: #2563eb;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-danger {
            background: #dc2626;
            color: white;
        }

        .btn-danger:hover {
            background: #b91c1c;
        }

        .btn-warning {
            background: #f59e0b;
            color: white;
        }

        .btn-warning:hover {
            background: #d97706;
        }

        .voice-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 20px;
            background: white;
        }

        .voice-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: #f8fafc;
            border-radius: 6px;
            margin-bottom: 8px;
            transition: all 0.2s ease;
            border: 1px solid #e2e8f0;
        }

        .voice-item:hover {
            background: #f1f5f9;
            border-color: #3b82f6;
        }

        .voice-info {
            flex: 1;
        }

        .voice-name {
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 4px;
        }

        .voice-id {
            font-size: 12px;
            color: #64748b;
            font-family: monospace;
        }

        .voice-actions {
            display: flex;
            gap: 5px;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
        }

        .add-voice-form {
            display: grid;
            grid-template-columns: 1fr 2fr auto;
            gap: 10px;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8fafc;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
        }

        .status-message {
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 20px;
            display: none;
        }

        .status-message.success {
            background: #f0fdf4;
            color: #15803d;
            border: 1px solid #16a34a;
            display: block;
        }

        .status-message.error {
            background: #fef2f2;
            color: #b91c1c;
            border: 1px solid #dc2626;
            display: block;
        }

        .preview-section {
            padding: 20px;
            background: #f8fafc;
            border-radius: 6px;
            margin-top: 20px;
            border: 1px solid #e2e8f0;
        }

        .preview-section h3 {
            color: #333;
            margin-bottom: 15px;
        }

        .preview-text {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 10px;
            resize: vertical;
        }

        .audio-player {
            width: 100%;
            margin-top: 10px;
        }

        .api-key-section {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            border-radius: 6px;
            padding: 16px;
            margin-bottom: 20px;
        }

        .api-key-section h3 {
            color: #92400e;
            margin-bottom: 10px;
            font-weight: 600;
            font-size: 14px;
        }

        .api-key-input {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .api-key-input input {
            flex: 1;
            font-family: monospace;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-item {
            background: #f8fafc;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #e2e8f0;
        }

        .stat-item .value {
            font-size: 24px;
            font-weight: bold;
            color: #3b82f6;
        }

        .stat-item .label {
            font-size: 12px;
            color: #64748b;
            text-transform: uppercase;
            margin-top: 5px;
        }

        /* ElevenLabs Conversation Styles */
        .conversation-container {
            background: #f8fafc;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 30px;
            min-height: 400px;
            position: relative;
            border: 1px solid #e2e8f0;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .waveform-container {
            position: relative;
            height: 120px;
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .waveform {
            display: flex;
            align-items: center;
            gap: 4px;
            height: 60px;
        }

        .wave-bar {
            width: 4px;
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            border-radius: 2px;
            transition: height 0.1s ease;
        }

        .transcript-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 20px;
        }

        .transcript-entry {
            margin-bottom: 15px;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .transcript-speaker {
            font-weight: 600;
            color: #3b82f6;
            margin-bottom: 5px;
        }

        .transcript-speaker.user {
            color: #1e293b;
        }

        .transcript-text {
            color: #495057;
            line-height: 1.6;
        }

        .emotion-indicator {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.85em;
            margin-left: 10px;
            background: #e9ecef;
            color: #495057;
        }

        .conversation-status {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 10px;
            animation: pulse 2s infinite;
        }

        .status-dot.inactive {
            background: #dc3545;
            animation: none;
        }

        .status-dot.connecting {
            background: #ffc107;
        }

        .status-dot.active {
            background: #28a745;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .conversation-controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .slider {
            width: 100%;
            -webkit-appearance: none;
            height: 6px;
            border-radius: 3px;
            background: #dee2e6;
            outline: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #3b82f6;
            cursor: pointer;
        }

        .slider-value {
            display: inline-block;
            margin-left: 10px;
            color: #3b82f6;
            font-weight: 500;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
            margin-left: 10px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.3s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: #3b82f6;
        }

        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }

        .results-container {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid #e2e8f0;
            max-height: 600px;
            overflow-y: auto;
        }

        .results-container h3 {
            color: #1e293b;
            margin-bottom: 15px;
            font-size: 18px;
            font-weight: 600;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .department-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            margin-bottom: 8px;
            background: #f8fafc;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
            transition: all 0.2s ease;
        }
        
        .department-item:hover {
            background: #f1f5f9;
            border-color: #3b82f6;
        }
        
        .department-item.editing {
            background: #fef3c7;
            border-color: #f59e0b;
        }
        
        .department-name {
            font-weight: 500;
            color: #1e293b;
            flex: 1;
        }
        
        .department-input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #3b82f6;
            border-radius: 6px;
            font-size: 13px;
            background: white;
        }
        
        .department-actions {
            display: flex;
            gap: 8px;
        }
        
        .btn-edit {
            background: #3b82f6;
            color: white;
        }
        
        .btn-edit:hover {
            background: #2563eb;
        }
        
        .btn-save {
            background: #10b981;
            color: white;
        }
        
        .btn-save:hover {
            background: #059669;
        }
        
        .btn-cancel {
            background: #64748b;
            color: white;
        }
        
        .btn-cancel:hover {
            background: #475569;
        }
        
        .btn-delete {
            background: #dc2626;
            color: white;
        }
        
        .btn-delete:hover {
            background: #b91c1c;
        }
    </style>
    <script src="js/session-export.js"></script>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="logo-section">
                <div class="company-logo">SAX</div>
                <div>
                    <div class="company-name">SAX Technology Advisors</div>
                    <div class="portal-title">MegaMind Admin Console</div>
                </div>
            </div>
            <div class="header-meta" style="display: flex; gap: 24px; align-items: center;">
                <div style="display: flex; gap: 16px; align-items: center;">
                    <a href="/document-upload.html" style="color: white; text-decoration: none; display: inline-flex; align-items: center; gap: 8px; padding: 8px 16px; border-radius: 6px; background: rgba(59, 130, 246, 0.3); transition: all 0.2s ease; font-size: 13px;">
                        <span style="font-size: 16px;">📁</span>
                        <span>Document Portal</span>
                    </a>
                    <a href="/" style="color: white; text-decoration: none; display: inline-flex; align-items: center; gap: 8px; padding: 8px 16px; border-radius: 6px; background: rgba(255, 215, 0, 0.3); transition: all 0.2s ease; font-size: 13px;">
                        <span style="font-size: 16px;">←</span>
                        <span>Back to MegaMind</span>
                    </a>
                </div>
            </div>
        </div>
    </header>
    
    <div class="container">

        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('voice')">Voice Models</button>
            <button class="tab-btn" onclick="switchTab('index')">🔍 Index Management</button>
            <button class="tab-btn" onclick="switchTab('sessions')">👥 User Sessions</button>
            <button class="tab-btn" onclick="switchTab('api')">API Settings</button>
            <button class="tab-btn" onclick="switchTab('system')">System Info</button>
        </div>

        <!-- Voice Models Tab -->
        <div id="voice-tab" class="tab-content active">
            <div class="admin-grid">
                <div class="admin-card full-width">
                    <h2>ElevenLabs Voice Model Configuration</h2>
                    
                    <div class="status-message" id="voiceStatus"></div>

                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="value" id="voiceCount">0</div>
                            <div class="label">Active Voices</div>
                        </div>
                        <div class="stat-item">
                            <div class="value" id="characterCount">0</div>
                            <div class="label">Characters Used</div>
                        </div>
                        <div class="stat-item">
                            <div class="value" id="quotaRemaining">-</div>
                            <div class="label">Quota Remaining</div>
                        </div>
                    </div>

                    <h3 style="margin-top: 20px; margin-bottom: 15px;">Add New Voice Model</h3>
                    <div class="add-voice-form">
                        <input type="text" id="newVoiceName" placeholder="Display Name (e.g., Sarah)">
                        <input type="text" id="newVoiceId" placeholder="ElevenLabs Voice ID (e.g., EXAVITQu4vr4xnSDxMaL)">
                        <button class="btn btn-primary" onclick="addVoice()">Add Voice</button>
                    </div>

                    <h3 style="margin-bottom: 15px;">Current Voice Models</h3>
                    <div class="voice-list" id="voiceList">
                        <!-- Voice items will be loaded here -->
                    </div>

                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-success" onclick="saveVoiceConfig()">Save Configuration</button>
                        <button class="btn btn-warning" onclick="loadDefaultVoices()">Reset to Defaults</button>
                        <button class="btn btn-primary" onclick="testVoiceAPI()">Test API Connection</button>
                    </div>
                </div>

                <div class="admin-card">
                    <h2>Voice Preview & Testing</h2>
                    <div class="form-group">
                        <label>Select Voice to Test:</label>
                        <select id="testVoiceSelect">
                            <!-- Options will be populated dynamically -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Test Text:</label>
                        <textarea id="testText" class="preview-text" rows="3">Hello! This is a test of the voice synthesis system. How does this voice sound to you?</textarea>
                    </div>
                    <button class="btn btn-primary" onclick="previewVoice()">Generate Preview</button>
                    <audio id="audioPlayer" class="audio-player" controls style="display: none; margin-top: 15px;"></audio>
                </div>

                <div class="admin-card">
                    <h2>Quick Import</h2>
                    <p style="color: #666; margin-bottom: 15px;">Paste a JSON configuration to import multiple voices at once:</p>
                    <div class="form-group">
                        <textarea id="importJson" placeholder='[{"name": "Rachel", "id": "EXAVITQu4vr4xnSDxMaL"}, ...]' rows="5"></textarea>
                    </div>
                    <button class="btn btn-primary" onclick="importVoices()">Import Voices</button>
                </div>
            </div>
        </div>

        <!-- Search Index Tab -->
        <div id="index-tab" class="tab-content">
            <div class="alert alert-success" id="indexSuccessAlert"></div>
            <div class="alert alert-danger" id="indexErrorAlert"></div>
            <div class="alert alert-warning" id="indexWarningAlert"></div>

            <div class="admin-grid">
                <!-- Index Statistics -->
                <div class="admin-card">
                    <h2>📊 Index Statistics</h2>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="value" id="totalDocs">-</div>
                            <div class="label">Total Documents</div>
                        </div>
                        <div class="stat-item">
                            <div class="value" id="indexSize">-</div>
                            <div class="label">Index Size</div>
                        </div>
                        <div class="stat-item">
                            <div class="value" id="lastUpdate">-</div>
                            <div class="label">Last Update</div>
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="refreshStats()">Refresh Stats</button>
                </div>

                <!-- Query Index -->
                <div class="admin-card">
                    <h2>🔍 Query Index</h2>
                    <div class="form-group">
                        <label>Select Index</label>
                        <select id="indexSelector"></select>
                    </div>
                    <div class="form-group">
                        <label>Search Query</label>
                        <input type="text" id="searchQuery" placeholder="Enter search terms or * for all">
                    </div>
                    <div class="form-group">
                        <label>Filter (OData)</label>
                        <input type="text" id="searchFilter" placeholder="e.g., department eq 'IT'">
                    </div>
                    <button class="btn btn-primary" onclick="queryIndex()">Search</button>
                </div>

                <!-- Delete Document -->
                <div class="admin-card">
                    <h2>🗑️ Delete Document</h2>
                    <div class="form-group">
                        <label>Document ID</label>
                        <input type="text" id="deleteDocId" placeholder="Enter document ID to delete">
                    </div>
                    <button class="btn btn-danger" onclick="deleteDocument()">Delete Document</button>
                </div>

                <!-- Bulk Delete -->
                <div class="admin-card">
                    <h2>🗑️ Bulk Delete</h2>
                    <div class="form-group">
                        <label>Document IDs (one per line)</label>
                        <textarea id="bulkDeleteIds" placeholder="Enter document IDs, one per line"></textarea>
                    </div>
                    <button class="btn btn-danger" onclick="bulkDelete()">Delete Selected</button>
                </div>

                <!-- Clear Index -->
                <div class="admin-card">
                    <h2>⚠️ Clear Index</h2>
                    <p style="color: #dc3545; font-size: 13px; margin-bottom: 15px;">
                        Warning: This will delete ALL documents from the index. This action cannot be undone.
                    </p>
                    <div class="form-group">
                        <label>Type "CONFIRM" to proceed</label>
                        <input type="text" id="clearConfirm" placeholder="Type CONFIRM">
                    </div>
                    <button class="btn btn-danger" onclick="clearIndex()">Clear All Documents</button>
                </div>

                <!-- Reindex Documents -->
                <div class="admin-card">
                    <h2>🔄 Reindex Documents</h2>
                    <p style="color: #666; font-size: 13px; margin-bottom: 15px;">
                        Trigger a full reindex of all documents from blob storage.
                    </p>
                    <button class="btn btn-warning" onclick="reindexDocuments()">Start Reindexing</button>
                </div>
                
                <!-- Department Management -->
                <div class="admin-card" style="grid-column: span 2;">
                    <h2>🏢 Department Management</h2>
                    <p style="color: #666; font-size: 13px; margin-bottom: 15px;">
                        Manage departments available for document categorization.
                    </p>
                    
                    <!-- Add New Department -->
                    <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                        <input type="text" id="newDepartmentName" placeholder="Enter new department name" 
                               style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 8px;">
                        <button class="btn btn-primary" onclick="addDepartment()">Add Department</button>
                    </div>
                    
                    <!-- Department List -->
                    <div id="departmentList" style="max-height: 300px; overflow-y: auto; border: 1px solid #eee; border-radius: 8px; padding: 10px;">
                        <div class="loading" id="deptLoading">
                            <div class="spinner"></div>
                            <p style="margin-top: 10px; color: #666;">Loading departments...</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="results-container" id="resultsContainer" style="display: none; margin-top: 20px;">
                <h3>Query Results</h3>
                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <p style="margin-top: 10px; color: #666;">Loading...</p>
                </div>
                <div id="results"></div>
            </div>
        </div>

        <!-- User Sessions Tab -->
        <div id="sessions-tab" class="tab-content">
            <div class="admin-grid">
                <div class="admin-card full-width">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 20px;">
                        <div>
                            <h2 style="margin: 0;">👥 User Conversation Sessions</h2>
                            <p style="color: #666; margin-top: 10px;">View and manage user conversation histories with comprehensive metrics</p>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-success" onclick="exportToExcel()" title="Export data to Excel (by user/date)">
                                📊 Export Excel
                            </button>
                            <button class="btn btn-danger" onclick="exportToPDF()" title="Generate PDF report (by user/date)">
                                📄 Export PDF
                            </button>
                        </div>
                    </div>
                    
                    <div class="form-group" style="display: flex; gap: 10px; align-items: flex-end;">
                        <div style="flex: 1;">
                            <label>Filter by User:</label>
                            <select id="userFilterDropdown" onchange="filterSessionsByUser()">
                                <option value="">All Users</option>
                                <!-- Will be populated dynamically -->
                            </select>
                        </div>
                        <div style="flex: 1;">
                            <label>Or Enter Email:</label>
                            <input type="email" id="sessionUserEmail" placeholder="user@example.com">
                        </div>
                        <div style="flex: 1;">
                            <label>Date Range:</label>
                            <select id="sessionDateRange">
                                <option value="today">Today</option>
                                <option value="week" selected>Last 7 Days</option>
                                <option value="month">Last 30 Days</option>
                                <option value="all">All Time</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="loadUserSessions()">Load Sessions</button>
                        <button class="btn btn-warning" onclick="loadAllRecentSessions()">Recent Activity (All Users)</button>
                    </div>
                    
                    <div class="form-group" style="margin-top: 15px; padding: 15px; background: #fff3cd; border-radius: 8px; display: none;" id="deleteControls">
                        <label style="color: #856404; font-weight: 600; margin-bottom: 10px; display: block;">⚠️ Session Management</label>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <button class="btn btn-danger" onclick="deleteSelectedSessions()" id="deleteSelectedBtn" disabled>
                                🗑️ Delete Selected Sessions
                            </button>
                            <button class="btn btn-danger" onclick="deleteAllUserSessions()" id="deleteUserSessionsBtn">
                                🗑️ Delete All Sessions for Current User
                            </button>
                            <button class="btn btn-danger" onclick="confirmDeleteAllSessions()" style="background: #a00; border-color: #800;">
                                ⚠️ Delete ALL Sessions (All Users)
                            </button>
                            <span id="selectedCount" style="margin-left: auto; color: #666;">0 sessions selected</span>
                        </div>
                    </div>

                    <div class="stats-grid" style="margin-top: 20px;">
                        <div class="stat-item">
                            <div class="value" id="totalSessions">-</div>
                            <div class="label">Total Sessions</div>
                        </div>
                        <div class="stat-item">
                            <div class="value" id="totalMessages">-</div>
                            <div class="label">Total Messages</div>
                        </div>
                        <div class="stat-item">
                            <div class="value" id="activeUsers">-</div>
                            <div class="label">Active Users</div>
                        </div>
                        <div class="stat-item">
                            <div class="value" id="avgSessionLength">-</div>
                            <div class="label">Avg Messages/Session</div>
                        </div>
                    </div>

                    <div id="sessionResults" style="margin-top: 30px; display: none;">
                        <h3 style="margin-bottom: 15px;">Session History</h3>
                        <div id="sessionsList" style="max-height: 600px; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 8px; padding: 15px;">
                            <!-- Sessions will be loaded here -->
                        </div>
                    </div>

                    <div class="loading" id="sessionLoading" style="display: none;">
                        <div class="spinner"></div>
                        <p style="margin-top: 10px; color: #666;">Loading session data...</p>
                    </div>
                </div>

                <div class="admin-card">
                    <h2>📊 Session Analytics</h2>
                    <div id="sessionAnalytics">
                        <p style="color: #999;">Load sessions to view analytics</p>
                    </div>
                </div>

                <div class="admin-card">
                    <h2>🔍 Search Conversations</h2>
                    <div class="form-group">
                        <label>Search Term:</label>
                        <input type="text" id="sessionSearchTerm" placeholder="Search in messages...">
                    </div>
                    <button class="btn btn-primary" onclick="searchSessions()">Search</button>
                    <div id="searchResults" style="margin-top: 15px;">
                        <!-- Search results will appear here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- API Settings Tab -->
        <div id="api-tab" class="tab-content">
            <div class="admin-card full-width">
                <h2>API Configuration</h2>
                
                <div class="api-key-section">
                    <h3>⚠️ ElevenLabs API Key</h3>
                    <p style="color: #856404; font-size: 14px;">Your API key is stored locally in the browser. Never share this key publicly.</p>
                    <div class="api-key-input">
                        <input type="password" id="elevenLabsKey" placeholder="sk_..." value="">
                        <button class="btn btn-primary btn-small" onclick="toggleKeyVisibility()">Show/Hide</button>
                        <button class="btn btn-success btn-small" onclick="saveAPIKey()">Save Key</button>
                    </div>
                </div>

                <div class="form-group">
                    <label>n8n Webhook Base URL:</label>
                    <input type="text" id="webhookUrl" value="https://workflows.saxtechnology.com/webhook/" placeholder="https://workflows.saxtechnology.com/webhook/">
                </div>

                <div class="form-group">
                    <label>Text Summarization Threshold (characters):</label>
                    <input type="number" id="summarizeThreshold" value="500" min="100" max="5000">
                </div>

                <div class="form-group">
                    <label>Max TTS Length (characters):</label>
                    <input type="number" id="maxTTSLength" value="1000" min="100" max="5000">
                </div>

                <button class="btn btn-success" onclick="saveAPISettings()">Save API Settings</button>
            </div>
        </div>

        <!-- System Info Tab -->
        <div id="system-tab" class="tab-content">
            <div class="admin-card full-width">
                <h2>System Information</h2>
                <div id="systemInfo">
                    <!-- System info will be loaded here -->
                </div>
            </div>
        </div>

        <!-- ElevenLabs Conversational AI Tab -->
    </div>

    <script>
        // Admin Console - Voice Management & Index Management Combined

        // Export helpers (by user and date filters)
        function getSessionFilters() {
            const userEmail = (document.getElementById('sessionUserEmail')?.value || '').trim() || document.getElementById('userFilterDropdown')?.value || '';
            const range = document.getElementById('sessionDateRange')?.value || 'week';
            return { userEmail, range };
        }
        function exportToExcel() {
            const { userEmail, range } = getSessionFilters();
            if (!userEmail) { alert('Select or enter a user email first'); return; }
            const url = `https://saxtechconversationlogs.azurewebsites.net/api/SaveConversationLog?action=exportUser&format=xlsx&adminKey=sax-admin-2024&userEmail=${encodeURIComponent(userEmail)}&range=${encodeURIComponent(range)}&code=w_j-EeXYy7G1yfUBkSVvlT5Hhafzg-eCNkaUOkOzzIveAzFu9NTlQw==`;
            window.open(url, '_blank');
        }
        function exportToPDF() {
            const { userEmail, range } = getSessionFilters();
            if (!userEmail) { alert('Select or enter a user email first'); return; }
            const url = `https://saxtechconversationlogs.azurewebsites.net/api/SaveConversationLog?action=exportUser&format=pdf&adminKey=sax-admin-2024&userEmail=${encodeURIComponent(userEmail)}&range=${encodeURIComponent(range)}&code=w_j-EeXYy7G1yfUBkSVvlT5Hhafzg-eCNkaUOkOzzIveAzFu9NTlQw==`;
            window.open(url, '_blank');
        }
        // Fixed userProfile reference and merged all index management features
        
        // Default voice models
        const defaultVoices = [
            { name: 'Rachel', id: 'EXAVITQu4vr4xnSDxMaL' },
            { name: 'Clyde', id: 'onwK4e9ZLuTAKqWW03F9' },
            { name: 'Charlotte', id: 'XB0fDUnXU5powFXDhCwa' },
            { name: 'Bill', id: 'pqHfZKP75CvOlQylNhV4' },
            { name: 'George', id: 'JBFqnCBsd6RMkjVDRZzb' },
            { name: 'Domi', id: 'AZnzlk1XvdvUeBnXmlld' },
            { name: 'Nicole', id: 'piTKgcLEGmPE4e6mEKli' },
            { name: 'Jessie', id: 'Zlb1dXrM653N07WRdFW3' }
        ];

        let voices = [];

        // Load saved configuration on page load
        window.addEventListener('load', () => {
            // Initialize ElevenLabs API key if not set
            if (!localStorage.getItem('elevenlabs_api_key')) {
                localStorage.setItem('elevenlabs_api_key', 'sk_94c95a3f46355ef03ad7cc214059cccfd2c492fc1571a2bf');
                console.log('ElevenLabs API key initialized');
            }
            
            loadVoiceConfig();
            loadAPISettings();
            updateSystemInfo();
            // Load session stats on page load to populate the User Sessions tab
            loadSessionStats();
        });

        function switchTab(tab) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));

            // Show selected tab
            const tabPane = document.getElementById(`${tab}-tab`);
            if (tabPane) tabPane.classList.add('active');

            // Activate the matching button without relying on window.event
            const buttons = Array.from(document.querySelectorAll('.tab-btn'));
            buttons.forEach(btn => {
                const onClick = btn.getAttribute('onclick') || '';
                const isTarget = onClick.includes(`switchTab('${tab}')`) || onClick.includes(`switchTab(\"${tab}\")`);
                if (isTarget) btn.classList.add('active');
            });

            // Special actions for specific tabs
            if (tab === 'system') {
                updateSystemInfo();
            } else if (tab === 'index') {
                // Load departments and refresh stats when switching to index tab
                loadDepartments();
                initIndexSelector();
                refreshStats();
            } else if (tab === 'sessions') {
                // Load session statistics when switching to sessions tab
                loadSessionStats();
            }
        }

        async function loadVoiceConfig() {
            try {
                // Load from Azure Function (centralized storage)
                const response = await fetch('https://saxtechmegamindfunctions.azurewebsites.net/api/ManageVoiceConfig');
                
                if (response.ok) {
                    const config = await response.json();
                    // Ensure all voices have both id and voiceId fields
                    voices = (config.voices || []).map(v => ({
                        name: v.name,
                        id: v.id || v.voiceId,
                        voiceId: v.voiceId || v.id
                    }));
                    showStatus('Loaded cloud configuration (used by all users)', 'success');
                } else {
                    throw new Error('Failed to load from cloud');
                }
            } catch (error) {
                console.error('Failed to load from cloud:', error);
                // Fallback to local storage
                const saved = localStorage.getItem('megamind_voice_config');
                if (saved) {
                    // Ensure all voices have both id and voiceId fields
                    voices = JSON.parse(saved).map(v => ({
                        name: v.name,
                        id: v.id || v.voiceId,
                        voiceId: v.voiceId || v.id
                    }));
                    showStatus('Loaded local configuration (cloud unavailable)', 'error');
                } else {
                    // Ensure default voices have voiceId field
                    voices = defaultVoices.map(v => ({
                        name: v.name,
                        id: v.id,
                        voiceId: v.id
                    }));
                    showStatus('Using default configuration', 'success');
                }
            }
            
            renderVoiceList();
            updateVoiceStats();
        }

        function renderVoiceList() {
            const list = document.getElementById('voiceList');
            const testSelect = document.getElementById('testVoiceSelect');
            
            list.innerHTML = '';
            testSelect.innerHTML = '';
            
            voices.forEach((voice, index) => {
                // Add to list
                const item = document.createElement('div');
                item.className = 'voice-item';
                item.innerHTML = `
                    <div class="voice-info">
                        <div class="voice-name">${voice.name}</div>
                        <div class="voice-id">${voice.id}</div>
                    </div>
                    <div class="voice-actions">
                        <button class="btn btn-small btn-warning" onclick="editVoice(${index})">Edit</button>
                        <button class="btn btn-small btn-danger" onclick="removeVoice(${index})">Remove</button>
                    </div>
                `;
                list.appendChild(item);
                
                // Add to test select
                const option = document.createElement('option');
                option.value = voice.voiceId || voice.id;
                option.textContent = voice.name;
                option.setAttribute('data-voice-id', voice.voiceId || voice.id);
                testSelect.appendChild(option);
            });
        }

        function addVoice() {
            const name = document.getElementById('newVoiceName').value.trim();
            const id = document.getElementById('newVoiceId').value.trim();
            
            if (!name || !id) {
                showStatus('Please enter both name and voice ID', 'error');
                return;
            }
            
            // Check for duplicates
            if (voices.some(v => v.id === id)) {
                showStatus('This voice ID already exists', 'error');
                return;
            }
            
            voices.push({ name, id, voiceId: id });
            renderVoiceList();
            updateVoiceStats();
            
            // Clear inputs
            document.getElementById('newVoiceName').value = '';
            document.getElementById('newVoiceId').value = '';
            
            showStatus(`Voice "${name}" added successfully`, 'success');
        }

        function removeVoice(index) {
            if (confirm(`Remove voice "${voices[index].name}"?`)) {
                voices.splice(index, 1);
                renderVoiceList();
                updateVoiceStats();
                showStatus('Voice removed', 'success');
            }
        }

        function editVoice(index) {
            const voice = voices[index];
            const newName = prompt('Enter new name:', voice.name);
            if (newName && newName.trim()) {
                voices[index].name = newName.trim();
                renderVoiceList();
                showStatus('Voice updated', 'success');
            }
        }

        async function saveVoiceConfig() {
            showStatus('Saving configuration to cloud...', 'success');
            
            try {
                // Save to Azure Function (centralized storage)
                const response = await fetch('https://saxtechmegamindfunctions.azurewebsites.net/api/ManageVoiceConfig', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Admin-Key': 'MegaMind2024$VoiceAdmin',  // Correct admin authentication key
                        'x-user-email': 'admin@saxtechnology.com'  // Admin context doesn't have userProfile
                    },
                    body: JSON.stringify({ 
                        voices: voices.map(v => ({
                            name: v.name,
                            id: v.id || v.voiceId,
                            voiceId: v.voiceId || v.id
                        }))
                    })
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Save response error:', errorText);
                    throw new Error(`Save failed: ${response.status} - ${errorText}`);
                }
                
                const result = await response.json();
                console.log('Save successful:', result);
                
                // Also save locally as backup with voiceId field
                const voicesWithVoiceId = voices.map(v => ({
                    name: v.name,
                    id: v.id || v.voiceId,
                    voiceId: v.voiceId || v.id
                }));
                localStorage.setItem('megamind_voice_config', JSON.stringify(voicesWithVoiceId));
                localStorage.setItem('megamind_voice_config_backup', JSON.stringify(voicesWithVoiceId));
                
                showStatus('Voice configuration saved to cloud for all users!', 'success');
                
            } catch (error) {
                console.error('Failed to save to cloud:', error);
                // Fallback to local storage
                localStorage.setItem('megamind_voice_config', JSON.stringify(voices));
                showStatus('Saved locally (cloud save failed: ' + error.message + ')', 'error');
            }
        }

        function loadDefaultVoices() {
            if (confirm('Reset to default voices? This will override your current configuration.')) {
                voices = [...defaultVoices];
                renderVoiceList();
                updateVoiceStats();
                showStatus('Reset to default voices', 'success');
            }
        }

        function importVoices() {
            const jsonText = document.getElementById('importJson').value.trim();
            if (!jsonText) {
                showStatus('Please enter JSON data to import', 'error');
                return;
            }
            
            try {
                const imported = JSON.parse(jsonText);
                if (!Array.isArray(imported)) {
                    throw new Error('JSON must be an array');
                }
                
                imported.forEach(v => {
                    if (!v.name || (!v.id && !v.voiceId)) {
                        throw new Error('Each voice must have name and id/voiceId');
                    }
                });
                
                // Ensure all imported voices have both id and voiceId fields
                voices = imported.map(v => ({
                    name: v.name,
                    id: v.id || v.voiceId,
                    voiceId: v.voiceId || v.id
                }));
                renderVoiceList();
                updateVoiceStats();
                document.getElementById('importJson').value = '';
                showStatus(`Imported ${imported.length} voices successfully`, 'success');
                
            } catch (e) {
                showStatus('Invalid JSON format: ' + e.message, 'error');
            }
        }

        async function previewVoice() {
            const selectElement = document.getElementById('testVoiceSelect');
            const voiceId = selectElement.value;
            const text = document.getElementById('testText').value;
            const apiKey = localStorage.getItem('elevenlabs_api_key') || 'sk_94c95a3f46355ef03ad7cc214059cccfd2c492fc1571a2bf';
            
            console.log('Preview voice - selected value:', voiceId);
            console.log('Preview voice - select element:', selectElement);
            console.log('Preview voice - all options:', Array.from(selectElement.options).map(o => ({value: o.value, text: o.textContent})));
            
            if (!voiceId || !text) {
                showStatus('Please select a voice and enter text', 'error');
                return;
            }
            
            showStatus('Generating preview...', 'success');
            
            try {
                const response = await fetch(`https://api.elevenlabs.io/v1/text-to-speech/${voiceId}/stream`, {
                    method: 'POST',
                    headers: {
                        'Accept': 'audio/mpeg',
                        'xi-api-key': apiKey,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        text: text.substring(0, 200), // Limit preview length
                        model_id: 'eleven_turbo_v2_5',
                        voice_settings: {
                            stability: 0.5,
                            similarity_boost: 0.75,
                            style: 0.0,
                            use_speaker_boost: true
                        }
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`API Error: ${response.status}`);
                }
                
                const audioBlob = await response.blob();
                const audioUrl = URL.createObjectURL(audioBlob);
                
                const player = document.getElementById('audioPlayer');
                player.src = audioUrl;
                player.style.display = 'block';
                player.play();
                
                showStatus('Preview generated successfully', 'success');
                
            } catch (error) {
                showStatus('Preview failed: ' + error.message, 'error');
            }
        }

        async function testVoiceAPI() {
            const apiKey = localStorage.getItem('elevenlabs_api_key') || 'sk_94c95a3f46355ef03ad7cc214059cccfd2c492fc1571a2bf';
            
            showStatus('Testing API connection...', 'success');
            
            try {
                const response = await fetch('https://api.elevenlabs.io/v1/user', {
                    headers: {
                        'xi-api-key': apiKey
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`API Error: ${response.status}`);
                }
                
                const data = await response.json();
                const remaining = data.subscription.character_limit - data.subscription.character_count;
                
                document.getElementById('characterCount').textContent = data.subscription.character_count.toLocaleString();
                document.getElementById('quotaRemaining').textContent = remaining.toLocaleString();
                
                showStatus('API connection successful!', 'success');
                
            } catch (error) {
                showStatus('API test failed: ' + error.message, 'error');
            }
        }

        function updateVoiceStats() {
            document.getElementById('voiceCount').textContent = voices.length;
        }

        function saveAPIKey() {
            const key = document.getElementById('elevenLabsKey').value.trim();
            if (key) {
                localStorage.setItem('elevenlabs_api_key', key);
                showStatus('API key saved', 'success');
            }
        }

        function toggleKeyVisibility() {
            const input = document.getElementById('elevenLabsKey');
            input.type = input.type === 'password' ? 'text' : 'password';
        }

        function saveAPISettings() {
            const settings = {
                webhookUrl: document.getElementById('webhookUrl').value,
                summarizeThreshold: document.getElementById('summarizeThreshold').value,
                maxTTSLength: document.getElementById('maxTTSLength').value
            };
            
            localStorage.setItem('megamind_api_settings', JSON.stringify(settings));
            showStatus('API settings saved', 'success');
        }

        function loadAPISettings() {
            const saved = localStorage.getItem('megamind_api_settings');
            if (saved) {
                const settings = JSON.parse(saved);
                document.getElementById('webhookUrl').value = settings.webhookUrl || 'https://workflows.saxtechnology.com/webhook/';
                document.getElementById('summarizeThreshold').value = settings.summarizeThreshold || 500;
                document.getElementById('maxTTSLength').value = settings.maxTTSLength || 1000;
            }
            
            // Load API key if saved
            const apiKey = localStorage.getItem('elevenlabs_api_key');
            if (apiKey) {
                document.getElementById('elevenLabsKey').value = apiKey;
            } else {
                // Set default API key
                const defaultKey = 'sk_94c95a3f46355ef03ad7cc214059cccfd2c492fc1571a2bf';
                localStorage.setItem('elevenlabs_api_key', defaultKey);
                document.getElementById('elevenLabsKey').value = defaultKey;
            }
        }

        function updateSystemInfo() {
            const info = document.getElementById('systemInfo');
            info.innerHTML = `
                <p><strong>Browser:</strong> ${navigator.userAgent}</p>
                <p><strong>Language:</strong> ${navigator.language}</p>
                <p><strong>Platform:</strong> ${navigator.platform}</p>
                <p><strong>Screen:</strong> ${window.screen.width}x${window.screen.height}</p>
                <p><strong>Local Storage Used:</strong> ${Object.keys(localStorage).length} items</p>
                <p><strong>Session Storage Used:</strong> ${Object.keys(sessionStorage).length} items</p>
                <p><strong>Last Updated:</strong> ${new Date().toLocaleString()}</p>
            `;
        }

        function showStatus(message, type) {
            const status = document.getElementById('voiceStatus');
            status.textContent = message;
            status.className = `status-message ${type}`;
            
            setTimeout(() => {
                status.className = 'status-message';
            }, 5000);
        }

        // Index Management Functions
        const INDEX_CONFIG = {
            searchEndpoint: 'https://saxmegamind-search.search.windows.net',
            searchApiKey: 'sZf5MvolOU8wqcM0sb1jI8XhICcOrTCfSIRl44vLmMAzSeA34CDO',
            indexName: localStorage.getItem('megamind_selected_index') || 'sop-documents',
            functionUrl: 'https://saxtechmegamindfunctions.azurewebsites.net/api',
            functionKey: 'zM5jG96cEf8xys3BptLRhgMoKAh9Ots6avbBOLuTGhSrAzFuxCpucw=='
        };

        // Provide index list management via localStorage (fallback defaults)
        function getIndexList() {
            try {
                const saved = localStorage.getItem('megamind_indexes');
                if (saved) {
                    const parsed = JSON.parse(saved);
                    if (Array.isArray(parsed) && parsed.length) return parsed;
                }
            } catch {}
            return [
                { name: 'sop-documents', label: 'sop-documents' },
                { name: 'ld-documents', label: 'ld-documents' },
                { name: 'auditorpublic', label: 'auditorpublic' },
                { name: 'ustaxpublic', label: 'ustaxpublic' },
                { name: 'audit-tax-documents', label: 'audit-tax-documents' }
            ];
        }

        function initIndexSelector() {
            const list = getIndexList();
            const sel = document.getElementById('indexSelector');
            if (!sel) return;
            sel.innerHTML = '';
            list.forEach(idx => {
                const opt = document.createElement('option');
                opt.value = idx.name;
                opt.textContent = idx.label || idx.name;
                if (idx.name === INDEX_CONFIG.indexName) opt.selected = true;
                sel.appendChild(opt);
            });
            sel.addEventListener('change', () => {
                INDEX_CONFIG.indexName = sel.value;
                localStorage.setItem('megamind_selected_index', sel.value);
                refreshStats();
            });
        }

        function showIndexAlert(type, message) {
            const alertMap = {
                'success': 'indexSuccessAlert',
                'error': 'indexErrorAlert', 
                'warning': 'indexWarningAlert'
            };
            
            // Hide all alerts
            Object.values(alertMap).forEach(id => {
                const elem = document.getElementById(id);
                if (elem) elem.classList.remove('show');
            });
            
            // Show the specific alert
            const alertId = alertMap[type];
            const alert = document.getElementById(alertId);
            if (alert) {
                alert.textContent = message;
                alert.classList.add('show');
                setTimeout(() => {
                    alert.classList.remove('show');
                }, 5000);
            }
        }

        // Helper function to format date to EST timezone
        function formatDateToEST(dateString) {
            if (!dateString) return '--';
            
            try {
                const date = new Date(dateString);
                const options = {
                    timeZone: 'America/New_York',
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: true
                };
                
                const formatter = new Intl.DateTimeFormat('en-US', options);
                const formatted = formatter.format(date);
                
                // Add EST/EDT label
                const isDST = date.getMonth() >= 2 && date.getMonth() <= 10;
                const timezone = isDST ? 'EDT' : 'EST';
                
                return `${formatted} ${timezone}`;
            } catch (error) {
                console.error('Error formatting date:', error);
                return dateString;
            }
        }

        async function refreshStats() {
            try {
                const selEl = document.getElementById('indexSelector');
                const currentIndex = (selEl && selEl.value) ? selEl.value : INDEX_CONFIG.indexName;
                INDEX_CONFIG.indexName = currentIndex; // keep in sync

// 1) Document count via SWA API, fallback to Function App
                let totalDocs = 0;
                try {
const statsResponse = await fetch(`/api/documents-search/${currentIndex}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ search: '*', query: '*', top: 0, indexName: currentIndex })
                    });
                    if (statsResponse.ok) {
                        const statsData = await statsResponse.json();
                        totalDocs = statsData['@odata.count'] || (statsData.value ? statsData.value.length : 0) || 0;
                    } else {
                        throw new Error(`SWA API returned ${statsResponse.status}`);
                    }
                } catch (e) {
                    // Fallback to Function App
                    try {
                        const fbStats = await fetch(`${INDEX_CONFIG.functionUrl}/documents/search`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'x-functions-key': INDEX_CONFIG.functionKey
                            },
                            body: JSON.stringify({ search: '*', query: '*', top: 0, indexName: currentIndex })
                        });
                        if (fbStats.ok) {
                            const statsData = await fbStats.json();
                            totalDocs = statsData['@odata.count'] || (statsData.value ? statsData.value.length : 0) || 0;
                        } else {
                            throw new Error(`FunctionApp API returned ${fbStats.status}`);
                        }
                    } catch (fe) {
                        console.error('Both SWA and FunctionApp stats failed:', e?.message || e, fe?.message || fe);
                    }
                }
                document.getElementById('totalDocs').textContent = totalDocs;
                const sizeInMB = (totalDocs * 50 / 1024).toFixed(1);
                document.getElementById('indexSize').textContent = `${sizeInMB} MB`;

// 2) Recent doc date via SWA API, fallback to Function App
                let documents = [];
                try {
const searchResponse = await fetch(`/api/documents-search/${currentIndex}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            search: '*',
                            query: '*',
                            top: 10,
orderby: 'modifiedDate desc, metadata_storage_last_modified desc, uploadDate desc, createdDate desc',
select: 'uploadDate,createdDate,modifiedDate,lastModified,metadata_storage_last_modified',
                            indexName: currentIndex
                        })
                    });
                    if (searchResponse.ok) {
                        const searchData = await searchResponse.json();
                        documents = searchData.value || searchData.results || [];
                    } else {
                        throw new Error(`SWA API returned ${searchResponse.status}`);
                    }
                } catch (e) {
                    try {
                        const fbRecent = await fetch(`${INDEX_CONFIG.functionUrl}/documents/search`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'x-functions-key': INDEX_CONFIG.functionKey
                            },
                            body: JSON.stringify({
                                search: '*',
                                query: '*',
                                top: 10,
orderby: 'modifiedDate desc, metadata_storage_last_modified desc, uploadDate desc, createdDate desc',
select: 'uploadDate,createdDate,modifiedDate,lastModified,metadata_storage_last_modified',
                                indexName: currentIndex
                            })
                        });
                        if (fbRecent.ok) {
                            const searchData = await fbRecent.json();
                            documents = searchData.value || searchData.results || [];
                        } else {
                            throw new Error(`FunctionApp API returned ${fbRecent.status}`);
                        }
                    } catch (fe) {
                        console.error('Both SWA and FunctionApp recent-docs failed:', e?.message || e, fe?.message || fe);
                    }
                }

                if (documents && documents.length > 0) {
                    let mostRecentDate = null;
                    documents.forEach(doc => {
const dates = [doc.uploadDate, doc.createdDate, doc.modifiedDate, doc.lastModified, doc.metadata_storage_last_modified].filter(d => d);
                        dates.forEach(dateStr => {
                            const date = new Date(dateStr);
                            if (!mostRecentDate || date > mostRecentDate) {
                                mostRecentDate = date;
                            }
                        });
                    });
                    if (mostRecentDate) {
                        const formatted = formatDateToEST(mostRecentDate.toISOString());
                        document.getElementById('lastUpdate').textContent = formatted;
                    } else {
                        document.getElementById('lastUpdate').textContent = '--';
                    }
                } else {
                    document.getElementById('lastUpdate').textContent = 'No documents';
                }

                showIndexAlert('success', 'Statistics refreshed successfully');
            } catch (error) {
                showIndexAlert('error', 'Error fetching statistics: ' + error.message);
                document.getElementById('lastUpdate').textContent = 'Error';
            }
        }

        async function queryIndex() {
            const query = document.getElementById('searchQuery').value || '*';
            const filter = document.getElementById('searchFilter').value;
            const selEl = document.getElementById('indexSelector');
            const currentIndex = (selEl && selEl.value) ? selEl.value : INDEX_CONFIG.indexName;
            INDEX_CONFIG.indexName = currentIndex; // ensure in sync
            // Fetch all results with paging (1000/page)
            
            document.getElementById('resultsContainer').style.display = 'block';
            document.getElementById('loading').classList.add('show');
            document.getElementById('results').innerHTML = '';
            
            try {
                const pageSize = 1000; // Azure Search max per request
                let allDocs = [];
                let seenIds = new Set();
                let skip = 0;
                let page = 0;
                let got = 0;
                do {
                    page++;
let response;
                    try {
response = await fetch(`/api/documents-search/${currentIndex}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                query: query,
                                search: query,
                                filter: filter,
                                top: pageSize,
                                skip: skip,
                                indexName: currentIndex,
                                select: 'id,title,fileName,department,documentType,uploadDate,createdDate,lastModified,metadata_storage_last_modified,author,fileSize,status,vectorized,chunkCount,chunks,conversionMethod,contentHash,contentLength,metadata,content,totalCharacters'
                            })
                        });
                        if (!response.ok) throw new Error('SWA search failed');
                    } catch (e) {
                        response = await fetch(`${INDEX_CONFIG.functionUrl}/documents/search`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'x-functions-key': INDEX_CONFIG.functionKey
                            },
                            body: JSON.stringify({
                                query: query,
                                search: query,
                                filter: filter,
                                top: pageSize,
                                skip: skip,
                                indexName: currentIndex,
                                select: 'id,title,fileName,department,documentType,uploadDate,createdDate,lastModified,metadata_storage_last_modified,author,fileSize,status,vectorized,chunkCount,chunks,conversionMethod,contentHash,contentLength,metadata,content,totalCharacters'
                            })
                        });
                        if (!response.ok) throw new Error('FunctionApp search failed');
                    }
                    const data = await response.json();
                    const docs = data.results || data.value || [];
                    got = docs.length;

                    // Append only new docs by id
                    const before = allDocs.length;
                    docs.forEach(d => {
                        const id = d.id || `${d.fileName}-${d.uploadDate || d.createdDate || ''}`;
                        if (!seenIds.has(id)) {
                            seenIds.add(id);
                            allDocs.push(d);
                        }
                    });

                    skip += got;
                    // Safety break to avoid endless loop or no-growth
                    if (page > 50) break;
                    if (allDocs.length === before && got > 0 && skip > 0) break;
                } while (got === pageSize);

                const documents = allDocs;
                    
                    // Debug: Log first document to see structure
                    if (documents.length > 0) {
                        console.log('Sample document structure:', documents[0]);
                        console.log('Document keys:', Object.keys(documents[0]));
                        if (documents[0].metadata) {
                            console.log('Metadata structure:', documents[0].metadata);
                        }
                        if (documents[0].chunks) {
                            console.log('Chunks structure:', documents[0].chunks);
                        }
                    }
                    
                    displayResults(documents);
                    showIndexAlert('success', `Found ${documents.length} documents in ${currentIndex}`);
            } catch (error) {
                showIndexAlert('error', 'Search error: ' + error.message);
            } finally {
                document.getElementById('loading').classList.remove('show');
            }
        }

        function displayResults(documents) {
            const resultsDiv = document.getElementById('results');
            
            if (!documents || documents.length === 0) {
                resultsDiv.innerHTML = '<p style="color: #666;">No documents found</p>';
                return;
            }
            
            // Create a detailed table display
            resultsDiv.innerHTML = `
                <table style="width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 13px;">
                    <thead>
                        <tr style="background: #f5f5f5; border-bottom: 2px solid #ddd;">
                            <th style="padding: 10px; text-align: left;">Title/File</th>
                            <th style="padding: 10px; text-align: left;">Department</th>
                            <th style="padding: 10px; text-align: left;">Type</th>
                            <th style="padding: 10px; text-align: left;">Index Method</th>
                            <th style="padding: 10px; text-align: center;">Size</th>
                            <th style="padding: 10px; text-align: center;">Vectorized</th>
                            <th style="padding: 10px; text-align: left;">Upload Date</th>
                            <th style="padding: 10px; text-align: center;">Chunk #</th>
                            <th style="padding: 10px; text-align: center;">Chunk Size</th>
                            <th style="padding: 10px; text-align: center;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${documents.map(doc => {
                            // Format file size
                            const formatSize = (bytes) => {
                                if (!bytes || bytes === 0) return '-';
                                const k = 1024;
                                const sizes = ['B', 'KB', 'MB', 'GB'];
                                const i = Math.floor(Math.log(bytes) / Math.log(k));
                                return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
                            };
                            
                            // Format date to EST
                            const formatDate = (dateStr) => {
                                if (!dateStr) return 'N/A';
                                try {
                                    const date = new Date(dateStr);
                                    const options = {
                                        timeZone: 'America/New_York',
                                        year: 'numeric',
                                        month: '2-digit',
                                        day: '2-digit',
                                        hour: '2-digit',
                                        minute: '2-digit',
                                        hour12: true
                                    };
                                    return new Intl.DateTimeFormat('en-US', options).format(date);
                                } catch (e) {
                                    return dateStr;
                                }
                            };
                            
                            // Determine indexing method
                            let indexMethod = 'Standard';
                            
                            // First check if there's OCR text indicating OCR processing
                            if (doc.ocrText && doc.ocrText.trim().length > 0) {
                                indexMethod = 'OCR';
                            } else if (doc.conversionMethod) {
                                indexMethod = doc.conversionMethod;
                            } else if (doc.fileName) {
                                // Infer method from file extension
                                const ext = doc.fileName.toLowerCase().split('.').pop();
                                if (['jpg', 'jpeg', 'png', 'gif', 'bmp'].includes(ext)) {
                                    indexMethod = 'OCR';
                                } else if (['xlsx', 'xls', 'csv'].includes(ext)) {
                                    indexMethod = 'Excel';
                                } else if (['pdf'].includes(ext)) {
                                    indexMethod = 'PDF Extract';
                                } else if (['docx', 'doc'].includes(ext)) {
                                    indexMethod = 'Word Extract';
                                } else if (['txt', 'md'].includes(ext)) {
                                    indexMethod = 'Text';
                                }
                            }
                            
                            // Status override for Active documents
                            if (doc.status === 'Active' || doc.status === 'indexed') {
                                if (indexMethod === 'Standard') {
                                    indexMethod = 'Indexed';
                                }
                            }
                            
                            const methodColor = indexMethod === 'OCR' ? '#9333ea' : 
                                              indexMethod === 'Excel' ? '#16a34a' : 
                                              indexMethod === 'PDF Extract' ? '#0891b2' :
                                              indexMethod === 'Word Extract' ? '#0369a1' :
                                              indexMethod === 'Text' ? '#059669' :
                                              indexMethod === 'Indexed' ? '#3b82f6' :
                                              indexMethod === 'Active' ? '#3b82f6' : '#6b7280';
                            
                            // Check if this is a chunk (ID contains _chunk_)
                            const isChunk = doc.id && doc.id.includes('_chunk_');
                            let chunkNumber = '-';
                            let documentId = doc.id;
                            
                            if (isChunk) {
                                const parts = doc.id.split('_chunk_');
                                documentId = parts[0];
                                chunkNumber = parts[1] ? parseInt(parts[1]) : '-';
                            }
                            
                            return `
                            <tr style="border-bottom: 1px solid #eee;">
                                <td style="padding: 10px;">
                                    <strong>${doc.title || doc.fileName || 'Untitled'}</strong>
                                    <br>
                                    <small style="color: #666;">${doc.fileName || ''}</small>
                                    <br>
                                    <small style="color: #999; font-size: 11px;">ID: ${doc.id}</small>
                                    ${isChunk ? `<br><small style="color: #667eea; font-size: 11px;">📄 Document Chunk</small>` : ''}
                                </td>
                                <td style="padding: 10px;">${doc.department || 'N/A'}</td>
                                <td style="padding: 10px;">${doc.documentType || 'N/A'}</td>
                                <td style="padding: 10px;">
                                    <span style="padding: 2px 8px; background: ${methodColor}; color: white; border-radius: 4px; font-size: 11px;">
                                        ${indexMethod}
                                    </span>
                                </td>
                                <td style="padding: 10px; text-align: center;">${formatSize(doc.fileSize)}</td>
                                <td style="padding: 10px; text-align: center;">
                                    ${(doc.vectorized === true || doc.status === 'indexed' || doc.status === 'Active' || (doc.content && doc.content.length > 0)) ? 
                                        '<span style="color: #16a34a; font-weight: bold;">✓</span>' : 
                                        '<span style="color: #dc2626;">✗</span>'}
                                </td>
                                <td style="padding: 10px; font-size: 11px;">${formatDate(doc.uploadDate || doc.createdDate)}</td>
                                <td style="padding: 10px; text-align: center;">
                                    ${isChunk && chunkNumber !== '-' ? 
                                        `<span style="background: #e0e7ff; color: #3730a3; padding: 2px 6px; border-radius: 4px; font-size: 11px; font-weight: bold;">#${chunkNumber}</span>` : 
                                        (() => {
                                            // For non-chunk documents, show chunk count if available
                                            let chunkCount = 0;
                                            if (doc.chunkCount) {
                                                chunkCount = doc.chunkCount;
                                            } else if (doc.chunks && Array.isArray(doc.chunks)) {
                                                chunkCount = doc.chunks.length;
                                            } else if (doc.chunks && typeof doc.chunks === 'number') {
                                                chunkCount = doc.chunks;
                                            } else if (doc.metadata && doc.metadata.chunks) {
                                                chunkCount = doc.metadata.chunks;
                                            }
                                            
                                            return chunkCount > 0 ? 
                                                `<span style="background: #e0e7ff; color: #3730a3; padding: 2px 6px; border-radius: 4px; font-size: 11px;">${chunkCount} chunks</span>` : 
                                                '<span style="color: #999;">-</span>';
                                        })()}
                                </td>
                                <td style="padding: 10px; text-align: center;">
                                    ${(() => {
                                        // Calculate total character count from various sources
                                        let charCount = 0;
                                        
                                        // Debug log for first few documents
                                        if (documents.indexOf(doc) < 2) {
                                            console.log(`Document ${doc.id || doc.fileName}:`, {
                                                contentLength: doc.contentLength,
                                                totalCharacters: doc.totalCharacters,
                                                contentType: doc.content ? typeof doc.content : 'no content',
                                                contentSize: doc.content ? (typeof doc.content === 'string' ? doc.content.length : 'not string') : 'none',
                                                chunksType: doc.chunks ? typeof doc.chunks : 'no chunks',
                                                metadata: doc.metadata
                                            });
                                        }
                                        
                                        // For chunks, always use the actual content length
                                        if (isChunk && doc.content && typeof doc.content === 'string') {
                                            charCount = doc.content.length;
                                        }
                                        // Priority order for character count sources (non-chunks)
                                        else if (doc.totalCharacters && doc.totalCharacters > 0) {
                                            charCount = doc.totalCharacters;
                                        }
                                        else if (doc.contentLength && doc.contentLength > 0) {
                                            charCount = doc.contentLength;
                                        }
                                        else if (doc.metadata) {
                                            if (doc.metadata.totalCharacters && doc.metadata.totalCharacters > 0) {
                                                charCount = doc.metadata.totalCharacters;
                                            } else if (doc.metadata.contentLength && doc.metadata.contentLength > 0) {
                                                charCount = doc.metadata.contentLength;
                                            } else if (doc.metadata.characterCount && doc.metadata.characterCount > 0) {
                                                charCount = doc.metadata.characterCount;
                                            } else if (doc.metadata.totalChars && doc.metadata.totalChars > 0) {
                                                charCount = doc.metadata.totalChars;
                                            }
                                        }
                                        // Check if we have content field (non-chunk documents)
                                        else if (doc.content && !isChunk) {
                                            if (typeof doc.content === 'string') {
                                                charCount = doc.content.length;
                                            } else if (Array.isArray(doc.content)) {
                                                charCount = doc.content.reduce((total, item) => {
                                                    if (typeof item === 'string') {
                                                        return total + item.length;
                                                    } else if (item && item.content) {
                                                        return total + item.content.length;
                                                    } else if (item && item.text) {
                                                        return total + item.text.length;
                                                    }
                                                    return total;
                                                }, 0);
                                            }
                                        }
                                        // Check if chunks contain the actual content
                                        else if (doc.chunks) {
                                            // Chunks might be a number (count) or array
                                            if (typeof doc.chunks === 'number' && doc.fileSize) {
                                                // Estimate based on file size if chunks is just a count
                                                // Rough estimate: assume average of 1000 chars per chunk
                                                charCount = doc.chunks * 1000;
                                            } else if (Array.isArray(doc.chunks) && doc.chunks.length > 0) {
                                                // Try to extract content from chunks
                                                charCount = doc.chunks.reduce((total, chunk) => {
                                                    if (typeof chunk === 'string') {
                                                        return total + chunk.length;
                                                    } else if (chunk && chunk.content) {
                                                        return total + chunk.content.length;
                                                    } else if (chunk && chunk.text) {
                                                        return total + chunk.text.length;
                                                    }
                                                    return total;
                                                }, 0);
                                            }
                                        }
                                        
                                        // If still no character count but we have fileSize, estimate
                                        if (charCount === 0 && doc.fileSize && doc.fileSize > 0) {
                                            // Very rough estimate: text files are about 1 byte per character
                                            // PDFs and other formats have overhead, so divide by factor
                                            const ext = (doc.fileName || '').toLowerCase().split('.').pop();
                                            if (ext === 'txt' || ext === 'md') {
                                                charCount = doc.fileSize;
                                            } else if (ext === 'pdf') {
                                                charCount = Math.floor(doc.fileSize * 0.7); // PDFs have ~30% overhead
                                            } else if (ext === 'docx' || ext === 'doc') {
                                                charCount = Math.floor(doc.fileSize * 0.5); // Word docs have more overhead
                                            } else {
                                                charCount = Math.floor(doc.fileSize * 0.6); // Default estimate
                                            }
                                        }
                                        
                                        return charCount > 0 ? 
                                            `<span style="background: #fef3c7; color: #92400e; padding: 2px 6px; border-radius: 4px; font-size: 11px;">${charCount.toLocaleString()}</span>` :
                                            '<span style="color: #999;">-</span>';
                                    })()}
                                </td>
                                <td style="padding: 10px; text-align: center;">
                                    <button class="btn btn-danger" style="padding: 4px 10px; font-size: 11px;" 
                                            onclick="deleteDocumentById('${doc.id}')">Delete</button>
                                </td>
                            </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
                <div style="margin-top: 20px; padding: 10px; background: #f9f9f9; border-radius: 4px;">
                    <strong>Total Results:</strong> ${documents.length} ${documents.some(d => d.id && d.id.includes('_chunk_')) ? 'chunks' : 'documents'}
                    ${documents.some(d => d.id && d.id.includes('_chunk_')) ? 
                        `<br><small style="color: #666;">💡 Tip: These are individual document chunks. Each chunk is approximately 3,000 characters for optimal vector search.</small>` : ''}
                </div>
            `;
        }

        async function deleteDocument() {
            const docId = document.getElementById('deleteDocId').value.trim();
            
            if (!docId) {
                showIndexAlert('warning', 'Please enter a document ID');
                return;
            }
            
            if (!confirm(`Are you sure you want to delete document ${docId}?`)) {
                return;
            }
            
            await deleteDocumentById(docId);
        }

        async function deleteDocumentById(docId) {
            try {
                const response = await fetch(
                    `${INDEX_CONFIG.functionUrl}/documents/delete`,
                    {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'x-functions-key': INDEX_CONFIG.functionKey
                        },
                        body: JSON.stringify({ documentIds: [docId] })
                    }
                );
                
                if (response.ok) {
                    let result;
                    try {
                        const responseText = await response.text();
                        if (responseText) {
                            result = JSON.parse(responseText);
                        } else {
                            result = { message: 'Document deleted successfully' };
                        }
                    } catch (parseError) {
                        result = { message: `Document ${docId} deleted successfully` };
                    }
                    
                    showIndexAlert('success', result.message || `Document ${docId} deleted successfully`);
                    
                    // Clear the delete input if it exists
                    const deleteInput = document.getElementById('deleteDocId');
                    if (deleteInput) {
                        deleteInput.value = '';
                    }
                    
                    // Refresh stats
                    setTimeout(() => {
                        refreshStats();
                    }, 500);
                    
                    // Refresh search results if visible
                    if (document.getElementById('resultsContainer').style.display === 'block') {
                        queryIndex();
                    }
                } else {
                    const errorText = await response.text();
                    let errorMessage = 'Delete operation failed';
                    try {
                        const errorData = JSON.parse(errorText);
                        errorMessage = errorData.message || errorMessage;
                    } catch (e) {
                        errorMessage = errorText || errorMessage;
                    }
                    throw new Error(errorMessage);
                }
            } catch (error) {
                showIndexAlert('error', 'Delete error: ' + error.message);
            }
        }

        async function bulkDelete() {
            const idsText = document.getElementById('bulkDeleteIds').value.trim();
            
            if (!idsText) {
                showIndexAlert('warning', 'Please enter document IDs');
                return;
            }
            
            const ids = idsText.split('\n').map(id => id.trim()).filter(id => id);
            
            if (!confirm(`Are you sure you want to delete ${ids.length} documents?`)) {
                return;
            }
            
            try {
                const response = await fetch(
                    `${INDEX_CONFIG.functionUrl}/documents/delete`,
                    {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'x-functions-key': INDEX_CONFIG.functionKey
                        },
                        body: JSON.stringify({
                            documentIds: ids
                        })
                    }
                );
                
                if (response.ok) {
                    const result = await response.json();
                    showIndexAlert('success', result.summary || `${ids.length} documents deleted successfully`);
                    document.getElementById('bulkDeleteIds').value = '';
                    setTimeout(refreshStats, 500);
                } else {
                    throw new Error('Bulk delete failed');
                }
            } catch (error) {
                showIndexAlert('error', 'Bulk delete error: ' + error.message);
            }
        }

        async function clearIndex() {
            const confirmation = document.getElementById('clearConfirm').value;
            
            if (confirmation !== 'CONFIRM') {
                showIndexAlert('warning', 'Please type CONFIRM to proceed');
                return;
            }
            
            if (!confirm('This will delete ALL documents from the index. Are you absolutely sure?')) {
                return;
            }
            
            try {
                const response = await fetch(
                    `${INDEX_CONFIG.functionUrl}/index/maintenance`,
                    {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'x-functions-key': INDEX_CONFIG.functionKey
                        },
                        body: JSON.stringify({
                            operation: 'clear',
                            confirm: true
                        })
                    }
                );
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        showIndexAlert('success', result.message || 'Index cleared successfully');
                        document.getElementById('clearConfirm').value = '';
                        setTimeout(refreshStats, 500);
                    } else {
                        showIndexAlert('warning', result.message || 'Operation failed');
                    }
                } else {
                    throw new Error('Failed to clear index');
                }
            } catch (error) {
                showIndexAlert('error', 'Clear index error: ' + error.message);
            }
        }

        async function reindexDocuments() {
            if (!confirm('This will trigger a full reindex. Continue?')) {
                return;
            }
            
            showIndexAlert('warning', 'Reindexing functionality requires Azure Function implementation');
        }

        // Department Management Functions
        let departments = [];
        
        function loadDepartments() {
            const savedDepts = localStorage.getItem('megamind_departments');
            if (savedDepts) {
                departments = JSON.parse(savedDepts);
            } else {
                departments = [
                    { id: 1, name: 'IT' },
                    { id: 2, name: 'HR' },
                    { id: 3, name: 'Finance' },
                    { id: 4, name: 'Operations' },
                    { id: 5, name: 'Sales' },
                    { id: 6, name: 'Marketing' },
                    { id: 7, name: 'Legal' },
                    { id: 8, name: 'Executive' },
                    { id: 9, name: 'Customer Service' },
                    { id: 10, name: 'R&D' }
                ];
                saveDepartments();
            }
            displayDepartments();
        }
        
        function saveDepartments() {
            localStorage.setItem('megamind_departments', JSON.stringify(departments));
        }
        
        function displayDepartments() {
            const listDiv = document.getElementById('departmentList');
            
            if (departments.length === 0) {
                listDiv.innerHTML = '<p style="color: #666; text-align: center;">No departments configured</p>';
                return;
            }
            
            listDiv.innerHTML = departments.map(dept => `
                <div class="department-item" id="dept-${dept.id}">
                    <span class="department-name" id="dept-name-${dept.id}">${dept.name}</span>
                    <div class="department-actions">
                        <button class="btn-small btn-edit" onclick="editDepartment(${dept.id})">Edit</button>
                        <button class="btn-small btn-delete" onclick="deleteDepartment(${dept.id})">Delete</button>
                    </div>
                </div>
            `).join('');
        }
        
        function addDepartment() {
            const input = document.getElementById('newDepartmentName');
            const name = input.value.trim();
            
            if (!name) {
                showIndexAlert('warning', 'Please enter a department name');
                return;
            }
            
            if (departments.some(d => d.name.toLowerCase() === name.toLowerCase())) {
                showIndexAlert('warning', 'Department already exists');
                return;
            }
            
            const newDept = {
                id: Math.max(...departments.map(d => d.id), 0) + 1,
                name: name
            };
            
            departments.push(newDept);
            saveDepartments();
            displayDepartments();
            input.value = '';
            showIndexAlert('success', `Department "${name}" added successfully`);
        }
        
        function editDepartment(id) {
            const dept = departments.find(d => d.id === id);
            if (!dept) return;
            
            const newName = prompt('Edit department name:', dept.name);
            if (newName && newName.trim()) {
                dept.name = newName.trim();
                saveDepartments();
                displayDepartments();
                showIndexAlert('success', 'Department updated successfully');
            }
        }
        
        function deleteDepartment(id) {
            const dept = departments.find(d => d.id === id);
            if (!dept) return;
            
            if (confirm(`Delete department "${dept.name}"?`)) {
                departments = departments.filter(d => d.id !== id);
                saveDepartments();
                displayDepartments();
                showIndexAlert('success', 'Department deleted successfully');
            }
        }

        // User Sessions Functions
        // Variables are already declared in admin-session-fixes.js:
        // let allLoadedSessions = [];
        // let selectedSessions = new Set();
        // let currentFilteredUser = null;
        async function loadSessionStats() {
            try {
                // Use wildcard fetch to compute stats client-side (avoids server aggregate limitations)
                const response = await fetch('https://saxtechconversationlogs.azurewebsites.net/api/SaveConversationLog?action=get&email=*&range=month&limit=500&code=w_j-EeXYy7G1yfUBkSVvlT5Hhafzg-eCNkaUOkOzzIveAzFu9NTlQw==');
                if (!response.ok) throw new Error('stats fetch failed');
                const data = await response.json();
                const sessions = data.sessions || [];
                const totalSessions = sessions.length;
                const totalMessages = sessions.reduce((sum, s) => sum + ((s.conversation||[]).length), 0);
                const uniqueUsers = new Set(sessions.map(s => s.userEmail).filter(Boolean)).size;
                const avgSessionLength = totalSessions ? (totalMessages/totalSessions).toFixed(1) : '0';
                document.getElementById('totalSessions').textContent = totalSessions.toString();
                document.getElementById('totalMessages').textContent = totalMessages.toString();
                document.getElementById('activeUsers').textContent = uniqueUsers.toString();
                document.getElementById('avgSessionLength').textContent = avgSessionLength;
                if (sessions.length > 0) {
                    const metrics = calculateAggregateMetrics(sessions);
                    updateMetricsDisplay(metrics);
                }
            } catch (error) {
                console.error('Failed to load session stats:', error);
            }
        }
        
        function calculateAggregateMetrics(sessions) {
            let totalTokens = 0;
            let totalConfidence = 0;
            let confidenceCount = 0;
            const modelsUsed = new Set();
            const toolsUsed = new Set();
            let voiceSessionCount = 0;
            
            sessions.forEach(session => {
                const metrics = session.metrics || {};
                totalTokens += metrics.totalTokens || 0;
                if (metrics.avgConfidence) {
                    totalConfidence += metrics.avgConfidence;
                    confidenceCount++;
                }
                (metrics.modelsUsed || []).forEach(model => modelsUsed.add(model));
                (metrics.toolsUsed || []).forEach(tool => toolsUsed.add(tool));
                if (metrics.voiceAgentUsed) voiceSessionCount++;
            });
            
            return {
                totalTokens,
                avgConfidence: confidenceCount > 0 ? (totalConfidence / confidenceCount * 100).toFixed(1) : 'N/A',
                uniqueModels: modelsUsed.size,
                uniqueTools: toolsUsed.size,
                voiceSessionCount
            };
        }
        
        function updateMetricsDisplay(metrics) {
            // Add metrics to the stats grid if elements exist
            const statsGrid = document.querySelector('.stats-grid');
            if (statsGrid && metrics.totalTokens > 0) {
                // Check if additional metric elements already exist
                if (!document.getElementById('totalTokensUsed')) {
                    statsGrid.innerHTML += `
                        <div class="stat-item">
                            <div class="value" id="totalTokensUsed">${metrics.totalTokens.toLocaleString()}</div>
                            <div class="label">Total Tokens</div>
                        </div>
                        <div class="stat-item">
                            <div class="value" id="avgConfidenceScore">${metrics.avgConfidence}%</div>
                            <div class="label">Avg Confidence</div>
                        </div>
                    `;
                }
            }
        }

        async function loadUserSessions() {
            const userEmail = document.getElementById('sessionUserEmail').value.trim() || 
                            document.getElementById('userFilterDropdown').value;
            const dateRange = document.getElementById('sessionDateRange').value;
            
            if (!userEmail) {
                showStatus('Please enter a user email address or select from dropdown', 'error');
                return;
            }
            
            currentFilteredUser = userEmail;

            document.getElementById('sessionLoading').style.display = 'block';
            document.getElementById('sessionResults').style.display = 'none';

            try {
                const response = await fetch(`https://saxtechconversationlogs.azurewebsites.net/api/SaveConversationLog?action=get&email=${encodeURIComponent(userEmail)}&range=${dateRange}&code=w_j-EeXYy7G1yfUBkSVvlT5Hhafzg-eCNkaUOkOzzIveAzFu9NTlQw==`, {
                    headers: {
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    displaySessions(data.sessions || []);
                    updateSessionAnalytics(data.sessions || []);
                } else {
                    throw new Error('Failed to load sessions');
                }
            } catch (error) {
                console.error('Error loading sessions:', error);
                showStatus('Failed to load user sessions: ' + error.message, 'error');
            } finally {
                document.getElementById('sessionLoading').style.display = 'none';
            }
        }

        async function deleteSelectedSessions() {
            const selected = Array.from(selectedSessions);
            if (selected.length === 0) {
                showStatus('No sessions selected', 'error');
                return;
            }
            
            if (!confirm(`Delete ${selected.length} selected session(s)? This action cannot be undone.`)) {
                return;
            }
            
            try {
                for (const sessionId of selected) {
                    await fetch('https://saxtechconversationlogs.azurewebsites.net/api/SaveConversationLog?code=w_j-EeXYy7G1yfUBkSVvlT5Hhafzg-eCNkaUOkOzzIveAzFu9NTlQw==', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            action: 'delete',
                            sessionId: sessionId
                        })
                    });
                }
                showStatus(`${selected.length} session(s) deleted successfully`, 'success');
                selectedSessions.clear();
                loadUserSessions(); // Reload the list
            } catch (error) {
                showStatus('Failed to delete sessions: ' + error.message, 'error');
            }
        }
        
        async function deleteAllUserSessions() {
            const userEmail = currentFilteredUser || document.getElementById('sessionUserEmail').value.trim();
            
            if (!userEmail) {
                showStatus('Please select a user first', 'error');
                return;
            }
            
            if (!confirm(`Delete ALL sessions for user ${userEmail}? This action cannot be undone.`)) {
                return;
            }
            
            try {
                const response = await fetch('https://saxtechconversationlogs.azurewebsites.net/api/SaveConversationLog?code=w_j-EeXYy7G1yfUBkSVvlT5Hhafzg-eCNkaUOkOzzIveAzFu9NTlQw==', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'deleteAll',
                        userEmail: userEmail
                    })
                });
                
                if (response.ok) {
                    showStatus(`All sessions for ${userEmail} deleted successfully`, 'success');
                    document.getElementById('sessionsList').innerHTML = '';
                    document.getElementById('sessionResults').style.display = 'none';
                } else {
                    throw new Error('Failed to delete sessions');
                }
            } catch (error) {
                showStatus('Failed to delete user sessions: ' + error.message, 'error');
            }
        }
        
        async function confirmDeleteAllSessions() {
            const confirmText = prompt('Type "DELETE ALL" to permanently delete ALL sessions for ALL users:');
            
            if (confirmText !== 'DELETE ALL') {
                showStatus('Deletion cancelled', 'warning');
                return;
            }
            
            try {
                const response = await fetch('https://saxtechconversationlogs.azurewebsites.net/api/SaveConversationLog?code=w_j-EeXYy7G1yfUBkSVvlT5Hhafzg-eCNkaUOkOzzIveAzFu9NTlQw==', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'deleteAllGlobal',
                        confirm: true
                    })
                });
                
                if (response.ok) {
                    showStatus('All sessions for all users deleted successfully', 'success');
                    document.getElementById('sessionsList').innerHTML = '';
                    document.getElementById('sessionResults').style.display = 'none';
                    loadSessionStats(); // Refresh stats
                } else {
                    throw new Error('Failed to delete all sessions');
                }
            } catch (error) {
                showStatus('Failed to delete all sessions: ' + error.message, 'error');
            }
        }
        
        async function loadAllRecentSessions() {
            document.getElementById('sessionLoading').style.display = 'block';
            document.getElementById('sessionResults').style.display = 'none';

            try {
                const response = await fetch('https://saxtechconversationlogs.azurewebsites.net/api/SaveConversationLog?action=recent&limit=50&code=w_j-EeXYy7G1yfUBkSVvlT5Hhafzg-eCNkaUOkOzzIveAzFu9NTlQw==', {
                    headers: {
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    displaySessions(data.sessions || [], true);
                    updateSessionAnalytics(data.sessions || []);
                } else {
                    throw new Error('Failed to load recent sessions');
                }
            } catch (error) {
                console.error('Error loading recent sessions:', error);
                showStatus('Failed to load recent sessions: ' + error.message, 'error');
            } finally {
                document.getElementById('sessionLoading').style.display = 'none';
            }
        }

        function displaySessions(sessions, showUser = false) {
            const container = document.getElementById('sessionsList');
            
            // Store sessions for export functionality
            if (window.storeSessionData) {
                window.storeSessionData(sessions);
            }
            
            if (!sessions || sessions.length === 0) {
                container.innerHTML = '<p style="color: #999; text-align: center;">No sessions found</p>';
                document.getElementById('sessionResults').style.display = 'block';
                return;
            }

            let html = '';
            sessions.forEach(session => {
                const timestamp = new Date(session.timestamp).toLocaleString();
                const messages = session.conversation || [];
                const messageCount = messages.length;
                const metrics = session.metrics || {};
                const metadata = session.metadata || {};
                
                // Calculate session duration
                let duration = 'N/A';
                if (metadata.sessionStartTime && metadata.sessionEndTime) {
                    const start = new Date(metadata.sessionStartTime);
                    const end = new Date(metadata.sessionEndTime);
                    const durationMs = end - start;
                    const minutes = Math.floor(durationMs / 60000);
                    const seconds = Math.floor((durationMs % 60000) / 1000);
                    duration = `${minutes}m ${seconds}s`;
                }
                
                html += `
                    <div style="border: 1px solid #e0e0e0; border-radius: 8px; padding: 15px; margin-bottom: 15px; background: #f9f9f9;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <div>
                                ${showUser ? `<strong>User:</strong> ${session.userEmail || 'Unknown'}<br>` : ''}
                                <strong>Session:</strong> ${session.sessionId || 'N/A'}<br>
                                <small style="color: #666;">${timestamp}</small>
                                ${metadata.aiProfile ? `<br><small style="color: #667eea;">AI: ${metadata.aiProfile}</small>` : ''}
                            </div>
                            <div style="text-align: right;">
                                <span style="background: #667eea; color: white; padding: 3px 8px; border-radius: 12px; font-size: 12px;">
                                    ${messageCount} messages
                                </span>
                                ${metrics.totalTokens ? `<br><span style="background: #fbbf24; color: #333; padding: 3px 8px; border-radius: 12px; font-size: 12px; margin-top: 5px; display: inline-block;">${metrics.totalTokens} tokens</span>` : ''}
                            </div>
                        </div>
                        
                        <!-- Metrics Bar -->
                        ${(metrics.totalTokens || metrics.modelsUsed?.length || metrics.toolsUsed?.length) ? `
                        <div style="display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: wrap;">
                            ${duration !== 'N/A' ? `<span style="background: #e0f2fe; color: #075985; padding: 4px 8px; border-radius: 6px; font-size: 12px;">🕰️ ${duration}</span>` : ''}
                            ${metrics.modelsUsed?.length ? `<span style="background: #f3e8ff; color: #6b21a8; padding: 4px 8px; border-radius: 6px; font-size: 12px;">🤖 ${metrics.modelsUsed.join(', ')}</span>` : ''}
                            ${metrics.avgConfidence ? `<span style="background: #dcfce7; color: #166534; padding: 4px 8px; border-radius: 6px; font-size: 12px;">🎯 ${(metrics.avgConfidence * 100).toFixed(0)}% confidence</span>` : ''}
                            ${metrics.toolsUsed?.length ? `<span style="background: #fed7aa; color: #9a3412; padding: 4px 8px; border-radius: 6px; font-size: 12px;">🔧 ${metrics.toolsUsed.length} tools</span>` : ''}
                            ${metrics.indexQueries > 0 ? `<span style="background: #fecaca; color: #991b1b; padding: 4px 8px; border-radius: 6px; font-size: 12px;">🔍 ${metrics.indexQueries} searches</span>` : ''}
                            ${metrics.voiceAgentUsed ? `<span style="background: #c7d2fe; color: #3730a3; padding: 4px 8px; border-radius: 6px; font-size: 12px;">🎤 Voice: ${metrics.voiceAgentName || 'Used'}</span>` : ''}
                        </div>
                        ` : ''}
                        
                        <div style="max-height: 200px; overflow-y: auto; border-top: 1px solid #e0e0e0; padding-top: 10px;">
                `;
                
                messages.forEach((msg, idx) => {
                    const isUser = msg.role === 'user';
                    html += `
                        <div style="margin-bottom: 10px; ${isUser ? 'text-align: right;' : 'text-align: left;'}">
                            <div style="
                                display: inline-block;
                                max-width: 70%;
                                padding: 8px 12px;
                                border-radius: 12px;
                                background: ${isUser ? '#667eea' : '#e0e0e0'};
                                color: ${isUser ? 'white' : '#333'};
                            ">
                                <small style="font-weight: bold;">${isUser ? 'User' : 'Assistant'}</small><br>
                                ${msg.content}
                            </div>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
            document.getElementById('sessionResults').style.display = 'block';
        }

        function updateSessionAnalytics(sessions) {
            if (!sessions || sessions.length === 0) {
                document.getElementById('sessionAnalytics').innerHTML = '<p style="color: #999;">No data to analyze</p>';
                return;
            }

            // Calculate analytics
            const totalMessages = sessions.reduce((sum, s) => sum + (s.conversation?.length || 0), 0);
            const avgLength = (totalMessages / sessions.length).toFixed(1);
            const uniqueDays = new Set(sessions.map(s => new Date(s.timestamp).toDateString())).size;
            
            // Time distribution
            const hourDistribution = {};
            sessions.forEach(s => {
                const hour = new Date(s.timestamp).getHours();
                hourDistribution[hour] = (hourDistribution[hour] || 0) + 1;
            });

            const peakHour = Object.entries(hourDistribution).sort((a, b) => b[1] - a[1])[0];

            let analyticsHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div>
                        <strong>Total Sessions:</strong> ${sessions.length}
                    </div>
                    <div>
                        <strong>Avg Messages/Session:</strong> ${avgLength}
                    </div>
                    <div>
                        <strong>Active Days:</strong> ${uniqueDays}
                    </div>
                    <div>
                        <strong>Peak Hour:</strong> ${peakHour ? `${peakHour[0]}:00 (${peakHour[1]} sessions)` : 'N/A'}
                    </div>
                </div>
            `;

            document.getElementById('sessionAnalytics').innerHTML = analyticsHTML;
        }

        // Store session data for export
        // currentSessionsData is declared in admin-session-management.js
        window.storeSessionData = function(sessions) {
            currentSessionsData = sessions;
        };
        
        // Export to Excel
        function exportToExcel() {
            if (!currentSessionsData || currentSessionsData.length === 0) {
                showStatus('No data to export. Please load sessions first.', 'error');
                return;
            }
            
            // Create CSV content
            let csv = 'User Email,Session ID,Timestamp,AI Profile,Messages Count,Total Tokens,Duration,Tools Used,Confidence\n';
            
            currentSessionsData.forEach(session => {
                const metrics = session.metrics || {};
                const metadata = session.metadata || {};
                const messages = session.conversation || [];
                
                // Calculate duration
                let duration = '';
                if (metadata.sessionStartTime && metadata.sessionEndTime) {
                    const durationMs = new Date(metadata.sessionEndTime) - new Date(metadata.sessionStartTime);
                    duration = Math.floor(durationMs / 60000) + ' minutes';
                }
                
                csv += `"${session.userEmail || 'N/A'}",`;
                csv += `"${session.sessionId || 'N/A'}",`;
                csv += `"${session.timestamp || 'N/A'}",`;
                csv += `"${metadata.aiProfile || 'default'}",`;
                csv += `${messages.length},`;
                csv += `${metrics.totalTokens || 0},`;
                csv += `"${duration}",`;
                csv += `"${(metrics.toolsUsed || []).join(', ')}",`;
                csv += `${metrics.avgConfidence ? (metrics.avgConfidence * 100).toFixed(0) + '%' : 'N/A'}\n`;
            });
            
            // Download CSV
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'megamind_sessions_' + new Date().toISOString().split('T')[0] + '.csv';
            a.click();
            window.URL.revokeObjectURL(url);
            
            showStatus('Excel export completed', 'success');
        }
        
        // Export to PDF
        function exportToPDF() {
            if (!currentSessionsData || currentSessionsData.length === 0) {
                showStatus('No data to export. Please load sessions first.', 'error');
                return;
            }
            
            // Create HTML content for PDF
            let html = `
                <html>
                <head>
                    <title>MegaMind Session Report</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; }
                        h1 { color: #667eea; }
                        .session { border: 1px solid #e0e0e0; padding: 15px; margin-bottom: 20px; page-break-inside: avoid; }
                        .header { background: #f9f9f9; padding: 10px; margin-bottom: 10px; }
                        .message { padding: 5px 10px; margin: 5px 0; border-radius: 5px; }
                        .user-msg { background: #e8eaf6; text-align: right; }
                        .bot-msg { background: #f0f0f0; }
                    </style>
                </head>
                <body>
                    <h1>SAX MegaMind Session Report</h1>
                    <p>Generated: ${new Date().toLocaleString()}</p>
                    <p>Total Sessions: ${currentSessionsData.length}</p>
                    <hr>
            `;
            
            currentSessionsData.forEach(session => {
                const messages = session.conversation || [];
                html += `
                    <div class="session">
                        <div class="header">
                            <strong>User:</strong> ${session.userEmail || 'N/A'}<br>
                            <strong>Session:</strong> ${session.sessionId || 'N/A'}<br>
                            <strong>Date:</strong> ${new Date(session.timestamp).toLocaleString()}<br>
                            <strong>Messages:</strong> ${messages.length}
                        </div>
                `;
                
                messages.forEach(msg => {
                    const className = msg.role === 'user' ? 'user-msg' : 'bot-msg';
                    html += `<div class="message ${className}"><strong>${msg.role}:</strong> ${msg.content}</div>`;
                });
                
                html += '</div>';
            });
            
            html += '</body></html>';
            
            // Open in new window for printing
            const printWindow = window.open('', '_blank');
            printWindow.document.write(html);
            printWindow.document.close();
            printWindow.print();
            
            showStatus('PDF export window opened. Use print dialog to save as PDF.', 'success');
        }
        
        async function searchSessions() {
            const searchTerm = document.getElementById('sessionSearchTerm').value.trim();
            
            if (!searchTerm) {
                showStatus('Please enter a search term', 'error');
                return;
            }

            document.getElementById('searchResults').innerHTML = '<p>Searching...</p>';

            try {
                const response = await fetch(`https://saxtechconversationlogs.azurewebsites.net/api/SaveConversationLog?action=search&query=${encodeURIComponent(searchTerm)}&code=w_j-EeXYy7G1yfUBkSVvlT5Hhafzg-eCNkaUOkOzzIveAzFu9NTlQw==`, {
                    headers: {
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const matches = data.matches || [];
                    
                    if (matches.length === 0) {
                        document.getElementById('searchResults').innerHTML = '<p style="color: #999;">No matches found</p>';
                    } else {
                        let html = `<p><strong>${matches.length} matches found:</strong></p>`;
                        matches.forEach(match => {
                            html += `
                                <div style="background: #f9f9f9; padding: 8px; border-radius: 6px; margin-bottom: 8px;">
                                    <strong>${match.userEmail}</strong> - ${new Date(match.timestamp).toLocaleDateString()}<br>
                                    <small style="color: #666;">"...${match.excerpt}..."</small>
                                </div>
                            `;
                        });
                        document.getElementById('searchResults').innerHTML = html;
                    }
                } else {
                    throw new Error('Search failed');
                }
            } catch (error) {
                console.error('Search error:', error);
                document.getElementById('searchResults').innerHTML = '<p style="color: red;">Search failed</p>';
            }
        }
    </script>
    <script src="admin-session-management.js"></script>
</body>
</html>
