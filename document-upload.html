<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SAX Document Portal</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="alternate icon" href="/favicon.ico">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f8fafc;
            color: #1e293b;
            line-height: 1.6;
            font-size: 14px;
        }

        .header {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: white;
            padding: 24px 40px;
            border-bottom: 3px solid #3b82f6;
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .company-logo {
            width: 48px;
            height: 48px;
            background: #3b82f6;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 20px;
            color: white;
        }

        .company-name {
            font-size: 24px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .portal-title {
            font-size: 14px;
            color: #94a3b8;
            font-weight: 400;
            margin-top: 2px;
        }

        .header-meta {
            text-align: right;
            font-size: 12px;
            color: #94a3b8;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 32px 40px;
            display: grid;
            grid-template-columns: 380px 1fr;
            gap: 32px;
            min-height: calc(100vh - 120px);
        }

        .sidebar {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            height: fit-content;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
        }

        .sidebar-header {
            padding: 20px 24px;
            border-bottom: 1px solid #e2e8f0;
            background: #f8fafc;
            border-radius: 12px 12px 0 0;
        }

        .sidebar-title {
            font-size: 16px;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 4px;
        }

        .sidebar-subtitle {
            font-size: 12px;
            color: #64748b;
        }

        .form-section {
            padding: 24px;
        }

        .notice-banner {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 24px;
        }

        .notice-header {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            margin-bottom: 8px;
        }

        .notice-icon {
            color: #d97706;
            font-size: 16px;
            margin-top: 1px;
        }

        .notice-title {
            font-weight: 600;
            color: #92400e;
            font-size: 13px;
        }

        .notice-text {
            color: #92400e;
            font-size: 12px;
            line-height: 1.5;
            margin-left: 24px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #374151;
            font-size: 13px;
        }

        .required {
            color: #dc2626;
        }

        .form-select, .form-input, .form-textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 13px;
            transition: all 0.2s ease;
            background: white;
            color: #374151;
        }

        .form-select:focus, .form-input:focus, .form-textarea:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .form-textarea {
            resize: vertical;
            min-height: 80px;
        }

        .file-upload-section {
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            padding: 24px;
            text-align: center;
            background: #fafafa;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .file-upload-section:hover {
            border-color: #3b82f6;
            background: #f8fafc;
        }

        .file-upload-section.dragover {
            border-color: #3b82f6;
            background: #eff6ff;
        }

        .upload-icon {
            width: 48px;
            height: 48px;
            background: #f1f5f9;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 12px;
            color: #64748b;
            font-size: 20px;
        }

        .upload-text {
            font-weight: 500;
            color: #374151;
            margin-bottom: 4px;
        }

        .upload-subtext {
            color: #64748b;
            font-size: 12px;
        }

        .file-input {
            display: none;
        }

        .selected-file {
            margin-top: 12px;
            padding: 12px;
            background: #f0fdf4;
            border: 1px solid #16a34a;
            border-radius: 6px;
            display: none;
            text-align: left;
        }

        .file-info {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #15803d;
            font-size: 12px;
            font-weight: 500;
        }

        .btn-primary {
            width: 100%;
            background: #3b82f6;
            color: white;
            border: none;
            padding: 12px 16px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-primary:hover {
            background: #2563eb;
        }

        .btn-primary:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }

        .main-content {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
        }

        .content-header {
            padding: 20px 24px;
            border-bottom: 1px solid #e2e8f0;
            background: #f8fafc;
            border-radius: 12px 12px 0 0;
        }

        .content-title {
            font-size: 18px;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 4px;
        }

        .content-subtitle {
            font-size: 13px;
            color: #64748b;
        }

        .explorer-container {
            padding: 24px;
            display: none;
        }

        .explorer-controls {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            gap: 16px;
        }

        .search-container {
            flex: 1;
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 8px 12px 8px 36px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 13px;
        }

        .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #9ca3af;
            font-size: 14px;
        }

        .stats-panel {
            display: flex;
            gap: 24px;
            align-items: center;
            font-size: 12px;
            color: #64748b;
        }

        .folder-grid {
            display: grid;
            gap: 16px;
        }

        .folder-card {
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            overflow: hidden;
            background: white;
        }

        .folder-header {
            background: #f8fafc;
            padding: 12px 16px;
            border-bottom: 1px solid #e2e8f0;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: background-color 0.2s ease;
        }

        .folder-header:hover {
            background: #f1f5f9;
        }

        .folder-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .folder-icon {
            color: #64748b;
            font-size: 16px;
            transition: transform 0.2s ease;
        }

        .folder-card.expanded .folder-icon {
            transform: rotate(90deg);
        }

        .folder-name {
            font-weight: 500;
            color: #374151;
            font-size: 14px;
        }

        .folder-count {
            font-size: 12px;
            color: #64748b;
            background: #f1f5f9;
            padding: 2px 8px;
            border-radius: 12px;
        }

        .folder-content {
            display: none;
            padding: 16px;
        }

        .folder-card.expanded .folder-content {
            display: block;
        }

        .document-list {
            display: grid;
            gap: 12px;
        }

        .document-item {
            display: grid;
            grid-template-columns: auto 1fr auto;
            gap: 12px;
            padding: 12px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            align-items: center;
            transition: all 0.2s ease;
            background: #fafafa;
        }

        .document-item:hover {
            border-color: #3b82f6;
            background: #f8fafc;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .doc-type-icon {
            width: 32px;
            height: 32px;
            background: #3b82f6;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 10px;
            font-weight: 600;
        }

        .pdf { background: #dc2626; }
        .docx { background: #2563eb; }
        .xlsx { background: #059669; }
        .txt { background: #7c3aed; }

        .document-info {
            min-width: 0;
        }

        .document-title {
            font-weight: 500;
            color: #1e293b;
            font-size: 13px;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .document-meta {
            display: flex;
            gap: 16px;
            font-size: 11px;
            color: #64748b;
        }

        .document-description {
            font-size: 11px;
            color: #64748b;
            margin-top: 4px;
            line-height: 1.4;
        }

        .document-actions {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            padding: 6px 12px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            background: white;
            color: #374151;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .action-btn:hover {
            border-color: #3b82f6;
            color: #3b82f6;
        }

        .btn-preview:hover {
            background: #eff6ff;
        }

        .btn-download:hover {
            background: #f0fdf4;
            border-color: #059669;
            color: #059669;
        }

        .hidden {
            display: none;
        }

        .existing-sops {
            margin-top: 16px;
        }

        .sop-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            background: #fafafa;
        }

        .sop-item {
            padding: 10px 12px;
            border-bottom: 1px solid #e5e7eb;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 12px;
        }

        .sop-item:hover {
            background: #f8fafc;
        }

        .sop-item.selected {
            background: #eff6ff;
            border-color: #3b82f6;
            color: #1d4ed8;
        }

        .sop-item:last-child {
            border-bottom: none;
        }

        .additional-info {
            display: none;
        }

        .progress-bar {
            width: 100%;
            height: 4px;
            background: #e5e7eb;
            border-radius: 2px;
            overflow: hidden;
            margin-top: 12px;
            display: none;
        }

        .progress-fill {
            height: 100%;
            background: #3b82f6;
            width: 0%;
            transition: width 0.3s ease;
        }

        .success-message {
            background: #f0fdf4;
            border: 1px solid #16a34a;
            color: #15803d;
            padding: 12px;
            border-radius: 6px;
            margin-top: 12px;
            display: none;
            text-align: center;
            font-size: 12px;
            font-weight: 500;
        }

        .empty-state {
            text-align: center;
            padding: 48px 24px;
            color: #64748b;
        }

        .empty-icon {
            width: 64px;
            height: 64px;
            background: #f1f5f9;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 16px;
            font-size: 24px;
            color: #94a3b8;
        }

        .empty-title {
            font-weight: 500;
            margin-bottom: 8px;
            color: #374151;
        }

        .empty-text {
            font-size: 13px;
            line-height: 1.5;
        }

        @media (max-width: 1200px) {
            .container {
                grid-template-columns: 1fr;
                gap: 24px;
            }
            
            .header-content {
                flex-direction: column;
                gap: 12px;
                text-align: center;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            
            .header {
                padding: 16px 20px;
            }
            
            .explorer-controls {
                flex-direction: column;
                align-items: stretch;
            }
        }
    </style>
</head>
<body>
    <a href="/" class="back-to-chat" style="position: fixed; top: 20px; left: 20px; background: linear-gradient(135deg, #FFD700, #FFA500); color: #1a1a1a; padding: 10px 20px; border-radius: 25px; text-decoration: none; font-weight: 600; font-size: 14px; transition: all 0.3s ease; z-index: 1000; box-shadow: 0 4px 15px rgba(0,0,0,0.2);">← Back to MegaMind</a>
    
    <header class="header">
        <div class="header-content">
            <div class="logo-section">
                <div class="company-logo">SAX</div>
                <div>
                    <div class="company-name">SAX Technology Advisors</div>
                    <div class="portal-title">Document Management Portal</div>
                </div>
            </div>
            <div class="header-meta" style="display: flex; gap: 24px; align-items: center;">
                <div style="display: flex; gap: 16px; padding: 8px 16px; background: rgba(255,255,255,0.1); border-radius: 8px;">
                    <div style="text-align: center;">
                        <div style="font-size: 20px; font-weight: bold; color: #FFD700;" id="totalDocCount">0</div>
                        <div style="font-size: 10px; text-transform: uppercase; opacity: 0.8;">Documents</div>
                    </div>
                    <div style="text-align: center; border-left: 1px solid rgba(255,255,255,0.2); padding-left: 16px;">
                        <div style="font-size: 20px; font-weight: bold; color: #FFD700;" id="totalIndexSize">0 MB</div>
                        <div style="font-size: 10px; text-transform: uppercase; opacity: 0.8;">Index Size</div>
                    </div>
                    <div style="text-align: center; border-left: 1px solid rgba(255,255,255,0.2); padding-left: 16px;">
                        <div style="font-size: 20px; font-weight: bold; color: #FFD700;" id="lastIndexUpdate">--</div>
                        <div style="font-size: 10px; text-transform: uppercase; opacity: 0.8;">Last Update</div>
                    </div>
                    <div style="text-align: center; border-left: 1px solid rgba(255,255,255,0.2); padding-left: 16px;">
                        <div style="font-size: 20px; font-weight: bold; color: #FFD700;" id="vectorizedCount">0</div>
                        <div style="font-size: 10px; text-transform: uppercase; opacity: 0.8;">Vectorized</div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div class="container">
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-title">Document Upload</div>
                <div class="sidebar-subtitle">Standard Operating Procedures</div>
            </div>
            
            <div class="form-section">
                <div class="notice-banner">
                    <div class="notice-header">
                        <span class="notice-icon">⚠</span>
                        <span class="notice-title">COMPLIANCE NOTICE</span>
                    </div>
                    <div class="notice-text">
                        This portal is restricted to internal SAX documentation. Third-party materials require IT department approval prior to upload. Ensure compliance with data retention policies.
                    </div>
                </div>

                <form id="sopUploadForm">
                    <div class="form-group">
                        <label class="form-label" for="department">
                            Department <span class="required">*</span>
                        </label>
                        <select class="form-select" id="department" required>
                            <option value="">Select Department</option>
                            <option value="A&A">Audit & Advisory</option>
                            <option value="Finance">Finance</option>
                            <option value="HR">Human Resources</option>
                            <option value="Leadership">Leadership</option>
                            <option value="Marketing/Business Development">Marketing & Business Development</option>
                            <option value="Operations">Operations</option>
                            <option value="Shared Services">Shared Services</option>
                            <option value="Tax">Tax Services</option>
                            <option value="Transaction Advisory">Transaction Advisory</option>
                            <option value="Wealth Management">Wealth Management</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="sopType">
                            Document Type <span class="required">*</span>
                        </label>
                        <select class="form-select" id="sopType" required>
                            <option value="">Select Type</option>
                            <option value="Process Documentation">Process Documentation</option>
                            <option value="Policy Guidelines">Policy Guidelines</option>
                            <option value="Technical Procedures">Technical Procedures</option>
                            <option value="Compliance Procedures">Compliance Procedures</option>
                            <option value="Training Materials">Training Materials</option>
                            <option value="Quality Standards">Quality Standards</option>
                            <option value="Emergency Procedures">Emergency Procedures</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="updateType">
                            Action Type <span class="required">*</span>
                        </label>
                        <select class="form-select" id="updateType" required>
                            <option value="">Select Action</option>
                            <option value="new">New Document</option>
                            <option value="update">Update Existing</option>
                        </select>
                    </div>

                    <div id="existingSOPs" class="form-group existing-sops hidden">
                        <label class="form-label">Select Document to Update <span class="required">*</span></label>
                        <div class="sop-list" id="sopList">
                            <!-- Existing SOPs will be populated here -->
                        </div>
                        <input type="hidden" id="selectedSOPId" name="selectedSOPId">
                    </div>

                    <div id="additionalInfo" class="additional-info">
                        <div class="form-group">
                            <label class="form-label" for="sopTitle">
                                Document Title <span class="required">*</span>
                            </label>
                            <input type="text" class="form-input" id="sopTitle" placeholder="Enter document title">
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="sopDescription">Description</label>
                            <textarea class="form-textarea" id="sopDescription" placeholder="Brief description of document purpose and scope"></textarea>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="keywords">Keywords</label>
                            <input type="text" class="form-input" id="keywords" placeholder="Comma-separated keywords for search">
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="version">Version</label>
                            <input type="text" class="form-input" id="version" placeholder="1.0" value="1.0">
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">
                            Document File <span class="required">*</span>
                        </label>
                        <div class="file-upload-section" id="fileUploadArea">
                            <div class="upload-icon">📄</div>
                            <div class="upload-text">Select or drop file here</div>
                            <div class="upload-subtext">PDF, DOC, DOCX, TXT, XLS, XLSX formats supported</div>
                            <input type="file" class="file-input" id="fileInput" accept=".pdf,.doc,.docx,.txt,.xls,.xlsx">
                        </div>
                        <div class="selected-file" id="selectedFile">
                            <div class="file-info">
                                <span>📄</span>
                                <span id="fileName"></span>
                                <span style="margin-left: auto; color: #16a34a;">✓</span>
                            </div>
                        </div>
                    </div>

                    <button type="submit" class="btn-primary" id="submitBtn">
                        Upload Document
                    </button>
                    
                    <div class="progress-bar" id="progressBar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>

                    <div class="success-message" id="successMessage">
                        Document uploaded successfully and indexed for AI retrieval.
                    </div>
                </form>
            </div>
        </aside>

        <main class="main-content">
            <div class="content-header">
                <div class="content-title">Document Repository</div>
                <div class="content-subtitle">Browse and manage departmental documentation</div>
            </div>
            
            <div id="emptyState" class="empty-state">
                <div class="empty-icon">📁</div>
                <div class="empty-title">Welcome to Document Repository</div>
                <div class="empty-text">
                    <p style="margin-bottom: 12px;">Choose a department from the <strong style="color: #3b82f6;">dropdown menu in the sidebar</strong> to view documents.</p>
                    <p style="font-size: 12px; color: #94a3b8;">Documents will auto-load in a moment, or you can select a department now.</p>
                </div>
            </div>

            <div id="explorerContainer" class="explorer-container">
                <div class="explorer-controls">
                    <div class="search-container">
                        <input type="text" class="search-input" id="searchInput" placeholder="Search documents...">
                        <span class="search-icon">🔍</span>
                    </div>
                    <div class="stats-panel">
                        <span id="documentCount">0 documents</span>
                        <span>•</span>
                        <span id="lastUpdated">Last updated: --</span>
                    </div>
                </div>
                
                <div id="folderGrid" class="folder-grid">
                    <!-- Dynamic content will be loaded here -->
                </div>
            </div>
        </main>
    </div>

    <script>
        // API Configuration - Azure Function endpoints and n8n webhook
        const API_CONFIG = {
            baseUrl: 'https://saxtechmegamindfunctions.azurewebsites.net/api',
            functionKey: 'zM5jG96cEf8xys3BptLRhgMoKAh9Ots6avbBOLuTGhSrAzFuxCpucw==', // Function key for authentication
            endpoints: {
                listDocuments: '/documents/list',
                uploadDocument: '/documents/upload',
                deleteDocument: '/documents/delete',
                downloadDocument: '/documents/download',
                previewDocument: '/documents/preview',
                searchDocuments: '/documents/search'
            },
            blobStorage: {
                containerName: 'saxdocuments',
                baseUrl: 'https://saxmegamind.blob.core.windows.net'
            },
            n8n: {
                webhookUrl: 'https://workflows.saxtechnology.com/webhook/sop-document-upload',
                enabled: true  // Toggle to enable/disable n8n integration
            }
        };

        // DOM elements
        const departmentSelect = document.getElementById('department');
        const sopTypeSelect = document.getElementById('sopType');
        const updateTypeSelect = document.getElementById('updateType');
        const existingSOPsDiv = document.getElementById('existingSOPs');
        const sopList = document.getElementById('sopList');
        const selectedSOPIdInput = document.getElementById('selectedSOPId');
        const additionalInfoDiv = document.getElementById('additionalInfo');
        const fileUploadArea = document.getElementById('fileUploadArea');
        const fileInput = document.getElementById('fileInput');
        const selectedFileDiv = document.getElementById('selectedFile');
        const fileName = document.getElementById('fileName');
        const form = document.getElementById('sopUploadForm');
        const submitBtn = document.getElementById('submitBtn');
        const progressBar = document.getElementById('progressBar');
        const progressFill = document.getElementById('progressFill');
        const successMessage = document.getElementById('successMessage');
        
        // Document explorer elements
        const emptyState = document.getElementById('emptyState');
        const explorerContainer = document.getElementById('explorerContainer');
        const searchInput = document.getElementById('searchInput');
        const documentCount = document.getElementById('documentCount');
        const lastUpdated = document.getElementById('lastUpdated');
        const folderGrid = document.getElementById('folderGrid');

        // Event listeners
        updateTypeSelect.addEventListener('change', handleUpdateTypeChange);
        departmentSelect.addEventListener('change', function() {
            loadDepartmentDocuments();
            loadExistingSOPs();
        });
        sopTypeSelect.addEventListener('change', loadExistingSOPs);
        fileUploadArea.addEventListener('click', () => fileInput.click());
        fileUploadArea.addEventListener('dragover', handleDragOver);
        fileUploadArea.addEventListener('dragleave', handleDragLeave);
        fileUploadArea.addEventListener('drop', handleDrop);
        fileInput.addEventListener('change', handleFileSelect);
        form.addEventListener('submit', handleFormSubmit);
        searchInput.addEventListener('input', handleSearch);
        
        // Load index statistics on page load
        loadIndexStatistics();
        
        // Auto-load all documents on page load
        setTimeout(() => {
            loadAllDocuments();
        }, 500);

        function loadDepartmentDocuments() {
            const department = departmentSelect.value;
            
            if (!department) {
                // Load all documents if no department selected
                loadAllDocuments();
                return;
            }

            // Filter already loaded documents by department
            filterDocumentsByDepartment(department);
        }
        
        function loadAllDocuments() {
            // Show loading state
            emptyState.style.display = 'none';
            explorerContainer.style.display = 'block';
            documentCount.textContent = '0 documents';
            lastUpdated.textContent = 'Last updated: --';
            folderGrid.innerHTML = '<div style="text-align: center; padding: 40px; color: #64748b;">Loading all documents...</div>';

            // Fetch all documents
            fetchAllDocuments()
                .then(data => {
                    if (!data || !data.departments || Object.keys(data.departments).length === 0) {
                        showEmptyRepository();
                        return;
                    }

                    // Update stats
                    documentCount.textContent = `${data.stats.totalDocuments || 0} documents across ${Object.keys(data.departments).length} departments`;
                    lastUpdated.textContent = `Last updated: ${data.stats.lastUpdated || '--'}`;
                    
                    // Store all documents for filtering
                    window.allDocumentsData = data;
                    
                    // Build department structure
                    buildDepartmentStructure(data.departments);
                })
                .catch(error => {
                    console.error('Error loading documents:', error);
                    showEmptyRepository();
                });
        }
        
        function filterDocumentsByDepartment(department) {
            if (!window.allDocumentsData) {
                loadAllDocuments();
                return;
            }
            
            const filteredDepartments = {};
            if (window.allDocumentsData.departments[department]) {
                filteredDepartments[department] = window.allDocumentsData.departments[department];
            }
            
            if (Object.keys(filteredDepartments).length > 0) {
                const totalDocs = Object.values(filteredDepartments).reduce((sum, folders) => {
                    return sum + Object.values(folders).reduce((s, docs) => s + docs.length, 0);
                }, 0);
                
                documentCount.textContent = `${totalDocs} documents in ${department}`;
                buildDepartmentStructure(filteredDepartments);
            } else {
                showEmptyDepartment(department);
            }
        }

        async function fetchAllDocuments() {
            try {
                // Query Azure AI Search for all documents
                const searchUrl = 'https://saxmegamind-search.search.windows.net/indexes/sop-documents/docs/search?api-version=2023-11-01';
                const response = await fetch(searchUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'api-key': 'sZf5MvolOU8wqcM0sb1jI8XhICcOrTCfSIRl44vLmMAzSeA34CDO'
                    },
                    body: JSON.stringify({
                        search: '*',
                        select: 'id,title,fileName,documentType,description,createdDate,lastModified,department,fileSize,version,contentHash,author,status,keywords,tags',
                        top: 1000
                    })
                });

                if (!response.ok) {
                    throw new Error(`Azure Search HTTP ${response.status}: ${response.statusText}`);
                }

                const searchResults = await response.json();
                
                // Transform search results into department > folder structure
                const departments = {};
                let totalDocuments = 0;
                let lastUpdated = '--';
                
                // Azure AI Search returns results in 'value' array
                const documents = searchResults.value || [];
                
                if (documents && documents.length > 0) {
                    // Group documents by department, then by documentType
                    documents.forEach(doc => {
                        const deptName = doc.department || 'General';
                        const folderName = doc.documentType || 'General';
                        
                        if (!departments[deptName]) {
                            departments[deptName] = {};
                        }
                        if (!departments[deptName][folderName]) {
                            departments[deptName][folderName] = [];
                        }
                        
                        departments[deptName][folderName].push({
                            id: doc.id,
                            title: doc.title || doc.fileName,
                            description: doc.description || '',
                            lastModified: doc.lastModified || doc.createdDate,
                            uploadDate: doc.createdDate,
                            type: folderName.substring(0, 3).toUpperCase(),
                            author: doc.author || 'SAX User',
                            size: doc.fileSize || null,
                            version: doc.version || '1.0',
                            department: doc.department,
                            sha256Hash: doc.contentHash,  // Use contentHash field and alias it as sha256Hash
                            contentHash: doc.contentHash,
                            status: doc.status,
                            keywords: doc.keywords,
                            tags: doc.tags,
                            indexed: doc.status === 'indexed' || doc.status === 'completed'
                        });
                        totalDocuments++;
                    });
                    
                    // Get the most recent update date
                    const dates = documents.filter(d => d.lastModified || d.createdDate)
                                          .map(d => new Date(d.lastModified || d.createdDate));
                    if (dates.length > 0) {
                        const mostRecent = new Date(Math.max(...dates));
                        lastUpdated = mostRecent.toLocaleDateString();
                    }
                }
                
                return {
                    departments: departments,
                    stats: {
                        totalDocuments: totalDocuments,
                        lastUpdated: lastUpdated
                    }
                };
            } catch (error) {
                console.error('Azure Search query failed:', error);
                // Return empty structure if search fails
                return {
                    departments: {},
                    stats: {
                        totalDocuments: 0,
                        lastUpdated: '--'
                    }
                };
            }
        }

        function showEmptyDepartment(department) {
            folderGrid.innerHTML = `
                <div style="text-align: center; padding: 40px; color: #64748b;">
                    <div style="font-size: 24px; margin-bottom: 12px;">📁</div>
                    <div style="font-weight: 500; margin-bottom: 8px;">No Documents Found</div>
                    <div style="font-size: 13px;">No documents have been uploaded to the ${department} department yet.</div>
                </div>
            `;
            documentCount.textContent = '0 documents';
            lastUpdated.textContent = 'Last updated: --';
        }
        
        function showEmptyRepository() {
            folderGrid.innerHTML = `
                <div style="text-align: center; padding: 40px; color: #64748b;">
                    <div style="font-size: 24px; margin-bottom: 12px;">📁</div>
                    <div style="font-weight: 500; margin-bottom: 8px;">No Documents in Repository</div>
                    <div style="font-size: 13px;">Start by uploading documents using the form on the left.</div>
                </div>
            `;
            documentCount.textContent = '0 documents';
            lastUpdated.textContent = 'Last updated: --';
        }
        
        function buildDepartmentStructure(departments) {
            folderGrid.innerHTML = '';
            
            if (!departments || Object.keys(departments).length === 0) {
                showEmptyRepository();
                return;
            }
            
            // Create a section for each department
            Object.keys(departments).sort().forEach(deptName => {
                const deptSection = document.createElement('div');
                deptSection.className = 'department-section';
                deptSection.style.cssText = 'margin-bottom: 32px; border: 1px solid #e5e7eb; border-radius: 8px; padding: 16px;';
                
                // Department header
                const deptHeader = document.createElement('h3');
                deptHeader.style.cssText = 'margin: 0 0 16px 0; color: #1f2937; font-size: 16px; font-weight: 600; padding-bottom: 12px; border-bottom: 1px solid #e5e7eb;';
                deptHeader.innerHTML = `🏫 ${deptName} Department`;
                deptSection.appendChild(deptHeader);
                
                // Create folder structure for this department
                const folders = departments[deptName];
                const folderContainer = document.createElement('div');
                folderContainer.className = 'folder-grid';
                
                Object.keys(folders).sort().forEach(folderName => {
                    const documents = folders[folderName] || [];
                    
                    const folderCard = document.createElement('div');
                    folderCard.className = 'folder-card expanded'; // Start expanded
                    
                    const folderHeader = document.createElement('div');
                    folderHeader.className = 'folder-header';
                    folderHeader.innerHTML = `
                        <div class="folder-info">
                            <span class="folder-icon">▼</span>
                            <span class="folder-name">${folderName}</span>
                        </div>
                        <span class="folder-count">${documents.length}</span>
                    `;
                    
                    const folderContent = document.createElement('div');
                    folderContent.className = 'folder-content';
                    
                    const documentList = document.createElement('div');
                    documentList.className = 'document-list';
                    
                    if (documents.length === 0) {
                        documentList.innerHTML = `
                            <div style="text-align: center; padding: 20px; color: #94a3b8; font-size: 13px;">
                                No documents in this category yet.
                            </div>
                        `;
                    } else {
                        documents.forEach(doc => {
                            const docItem = createDocumentItem(doc);
                            documentList.appendChild(docItem);
                        });
                    }
                    
                    folderContent.appendChild(documentList);
                    
                    // Toggle folder expand/collapse
                    folderHeader.addEventListener('click', () => {
                        folderCard.classList.toggle('expanded');
                        const icon = folderHeader.querySelector('.folder-icon');
                        icon.textContent = folderCard.classList.contains('expanded') ? '▼' : '▶';
                    });
                    
                    folderCard.appendChild(folderHeader);
                    folderCard.appendChild(folderContent);
                    folderContainer.appendChild(folderCard);
                });
                
                deptSection.appendChild(folderContainer);
                folderGrid.appendChild(deptSection);
            });
        }

        function buildFolderStructure(folders) {
            folderGrid.innerHTML = '';
            
            if (!folders || Object.keys(folders).length === 0) {
                folderGrid.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #64748b;">
                        <div style="font-size: 24px; margin-bottom: 12px;">📁</div>
                        <div style="font-weight: 500; margin-bottom: 8px;">No Document Categories</div>
                        <div style="font-size: 13px;">No document categories have been created for this department yet.</div>
                    </div>
                `;
                return;
            }
            
            Object.keys(folders).forEach(folderName => {
                const documents = folders[folderName] || [];
                
                const folderCard = document.createElement('div');
                folderCard.className = 'folder-card';
                
                const folderHeader = document.createElement('div');
                folderHeader.className = 'folder-header';
                folderHeader.innerHTML = `
                    <div class="folder-info">
                        <span class="folder-icon">▶</span>
                        <span class="folder-name">${folderName}</span>
                    </div>
                    <span class="folder-count">${documents.length}</span>
                `;
                
                const folderContent = document.createElement('div');
                folderContent.className = 'folder-content';
                
                const documentList = document.createElement('div');
                documentList.className = 'document-list';
                
                if (documents.length === 0) {
                    documentList.innerHTML = `
                        <div style="text-align: center; padding: 20px; color: #94a3b8; font-size: 13px;">
                            No documents in this category yet.
                        </div>
                    `;
                } else {
                    // Add documents to folder
                    documents.forEach(doc => {
                        const docItem = createDocumentItem(doc);
                        documentList.appendChild(docItem);
                    });
                }
                
                folderContent.appendChild(documentList);
                
                // Toggle folder expand/collapse
                folderHeader.addEventListener('click', () => {
                    folderCard.classList.toggle('expanded');
                });
                
                folderCard.appendChild(folderHeader);
                folderCard.appendChild(folderContent);
                folderGrid.appendChild(folderCard);
            });
        }

        function createDocumentItem(doc) {
            const docDiv = document.createElement('div');
            docDiv.className = 'document-item';
            docDiv.setAttribute('data-search', `${doc.title} ${doc.description || ''} ${doc.author || ''}`.toLowerCase());
            docDiv.setAttribute('data-department', doc.department || '');
            
            // Determine file type and icon
            const fileExt = doc.title ? doc.title.split('.').pop().toLowerCase() : '';
            const typeInfo = getFileTypeInfo(fileExt);
            
            // Format file size
            const fileSize = doc.size ? formatFileSize(doc.size) : '';
            
            // Format dates
            const uploadDate = doc.uploadDate ? new Date(doc.uploadDate).toLocaleDateString() : null;
            const modifiedDate = doc.lastModified ? new Date(doc.lastModified).toLocaleDateString() : uploadDate || '';
            
            // Build metadata items
            const metaItems = [];
            if (modifiedDate) {
                metaItems.push(`<span class="meta-item"><span style="font-size: 10px;">📅</span> ${modifiedDate}</span>`);
            }
            if (fileSize) {
                metaItems.push(`<span class="meta-item"><span style="font-size: 10px;">📦</span> ${fileSize}</span>`);
            }
            
            // Add indexing status
            if (doc.indexed !== false) {
                metaItems.push(`<span class="meta-item indexed"><span style="font-size: 10px;">✓</span> Indexed</span>`);
            } else {
                metaItems.push(`<span class="meta-item processing"><span style="font-size: 10px;">⟳</span> Processing</span>`);
            }
            
            // Add vectorization status
            if (doc.vectorized) {
                metaItems.push(`<span class="meta-item indexed"><span style="font-size: 10px;">🧮</span> Vectorized</span>`);
            }
            
            // Add chunk count if available
            if (doc.chunkCount) {
                metaItems.push(`<span class="meta-item chunks"><span style="font-size: 10px;">📑</span> ${doc.chunkCount} chunks</span>`);
            }
            
            // Add conversion method if available
            if (doc.conversionMethod) {
                const methodIcon = doc.conversionMethod === 'OCR' ? '👁️' : doc.conversionMethod === 'Excel' ? '📊' : '📄';
                metaItems.push(`<span class="meta-item"><span style="font-size: 10px;">${methodIcon}</span> ${doc.conversionMethod}</span>`);
            }
            
            // Add department if available
            if (doc.department) {
                metaItems.push(`<span class="meta-item"><span style="font-size: 10px;">🏢</span> ${doc.department}</span>`);
            }
            
            docDiv.innerHTML = `
                <div class="doc-type-icon ${typeInfo.class}" style="background: ${typeInfo.gradient};">
                    <span style="color: white; font-size: 24px;">${typeInfo.icon}</span>
                    ${doc.vectorized ? '<div class="vectorized-badge" style="position: absolute; top: -4px; right: -4px; width: 16px; height: 16px; background: #10b981; border: 2px solid white; border-radius: 50%;">✓</div>' : ''}
                </div>
                <div class="document-info" style="flex: 1;">
                    <div class="document-title" style="font-weight: 600; color: #1e293b; margin-bottom: 4px;">${doc.title}</div>
                    <div class="document-meta" style="display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 6px;">
                        ${metaItems.join('')}
                    </div>
                    <div class="document-description" style="font-size: 12px; color: #64748b; line-height: 1.4;">${doc.description || 'No description available'}</div>
                </div>
                <div class="document-actions" style="display: flex; gap: 8px; align-items: center;">
                    <button class="action-btn btn-preview" onclick="previewDocument('${doc.id}', '${doc.title}', '${fileExt}')" style="padding: 6px 12px; background: white; border: 1px solid #d1d5db; border-radius: 6px; cursor: pointer; font-size: 12px; color: #374151;">
                        <span style="margin-right: 4px;">👁️</span> Preview
                    </button>
                    <button class="action-btn btn-download" onclick="downloadDocument('${doc.id}', '${doc.title}')" style="padding: 6px 12px; background: white; border: 1px solid #d1d5db; border-radius: 6px; cursor: pointer; font-size: 12px; color: #374151;">
                        <span style="margin-right: 4px;">⬇️</span> Download
                    </button>
                    <button class="btn-delete" onclick="deleteDocument('${doc.id}', '${doc.title}')" style="width: 32px; height: 32px; background: #fef2f2; border: 1px solid #fecaca; border-radius: 6px; cursor: pointer; color: #dc2626; display: flex; align-items: center; justify-content: center;" title="Delete document">
                        <span style="font-size: 16px;">🗑️</span>
                    </button>
                </div>
            `;
            
            return docDiv;
        }

        async function handleSearch() {
            const searchTerm = searchInput.value.trim();
            
            if (searchTerm.length < 2) {
                // If search term is too short, just reload current department
                loadDepartmentDocuments();
                return;
            }
            
            try {
                // Search across all documents in Azure AI Search
                const searchUrl = 'https://saxmegamind-search.search.windows.net/indexes/sop-documents/docs/search?api-version=2023-11-01';
                const response = await fetch(searchUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'api-key': 'sZf5MvolOU8wqcM0sb1jI8XhICcOrTCfSIRl44vLmMAzSeA34CDO'
                    },
                    body: JSON.stringify({
                        search: searchTerm,
                        searchMode: 'any',
                        select: 'id,title,fileName,documentType,description,uploadDate,department',
                        top: 50,
                        orderby: 'uploadDate desc'
                    })
                });
                
                if (response.ok) {
                    const searchResults = await response.json();
                    
                    // Clear current display
                    folderGrid.innerHTML = '';
                    
                    if (searchResults.value && searchResults.value.length > 0) {
                        // Group search results by department
                        const groupedResults = {};
                        searchResults.value.forEach(doc => {
                            const dept = doc.department || 'General';
                            if (!groupedResults[dept]) {
                                groupedResults[dept] = [];
                            }
                            groupedResults[dept].push(doc);
                        });
                        
                        // Display grouped results
                        Object.keys(groupedResults).forEach(dept => {
                            const deptDiv = document.createElement('div');
                            deptDiv.className = 'search-results-group';
                            deptDiv.innerHTML = `<h3 style="margin: 10px 0; color: #1e293b;">${dept}</h3>`;
                            
                            groupedResults[dept].forEach(doc => {
                                const docItem = createDocumentItem({
                                    id: doc.id,
                                    title: doc.title || doc.fileName,
                                    description: doc.description || '',
                                    lastModified: new Date(doc.uploadDate).toLocaleDateString(),
                                    type: (doc.documentType || 'DOC').substring(0, 3).toUpperCase(),
                                    author: 'SAX User',
                                    size: 'N/A',
                                    version: '1.0'
                                });
                                deptDiv.appendChild(docItem);
                            });
                            
                            folderGrid.appendChild(deptDiv);
                        });
                        
                        documentCount.textContent = `${searchResults.value.length} results found`;
                    } else {
                        folderGrid.innerHTML = `
                            <div style="text-align: center; padding: 40px; color: #64748b;">
                                <div style="font-size: 24px; margin-bottom: 12px;">🔍</div>
                                <div style="font-weight: 500; margin-bottom: 8px;">No Results Found</div>
                                <div style="font-size: 13px;">No documents match your search term "${searchTerm}"</div>
                            </div>
                        `;
                        documentCount.textContent = '0 results';
                    }
                }
            } catch (error) {
                console.error('Search failed:', error);
                folderGrid.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #dc2626;">
                        <div style="font-size: 24px; margin-bottom: 12px;">⚠️</div>
                        <div style="font-weight: 500;">Search Error</div>
                        <div style="font-size: 13px;">Unable to search documents at this time</div>
                    </div>
                `;
            }
        }

        function previewDocument(docId, title, fileType = 'pdf', fileSize = null) {
            // Prevent default action
            event.preventDefault();
            event.stopPropagation();
            
            console.log('Preview document:', docId, title);
            
            // Extract file extension from title if not provided
            if (!fileType && title) {
                const ext = title.split('.').pop().toLowerCase();
                fileType = ext || 'pdf';
            }
            
            // For now, show a message that preview is not available
            // In production, this would open a preview modal or redirect to Azure Blob Storage
            alert(`Document Preview\n\nTitle: ${title}\nType: ${fileType.toUpperCase()}\nID: ${docId}\n\nNote: Direct preview is currently not available. Please use the Download button to view the document locally.`);
            
            // Alternative: Try to construct Azure Blob URL if we have enough info
            // const blobUrl = `${API_CONFIG.blobStorage.baseUrl}/${API_CONFIG.blobStorage.containerName}/${docId}`;
            // window.open(blobUrl, '_blank');
        }
        
        function downloadDocument(docId, title) {
            // Prevent default action
            event.preventDefault();
            event.stopPropagation();
            
            console.log('Download document:', docId, title);
            
            // Call Azure Function to get download URL
            const downloadUrl = `${API_CONFIG.baseUrl}${API_CONFIG.endpoints.downloadDocument}?id=${docId}`;
            
            // Create a temporary link and trigger download
            const link = document.createElement('a');
            link.href = downloadUrl;
            link.download = title;
            link.target = '_blank';
            
            // Add function key as query parameter for authentication
            const urlWithAuth = `${downloadUrl}&code=${API_CONFIG.functionKey}`;
            link.href = urlWithAuth;
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            // Show success message
            console.log(`Downloading: ${title}`);
        }
        
        function showPDFViewer(docId, title) {
            // Future implementation for embedded PDF viewer
            // This could open a modal with an iframe or use PDF.js
            window.open(`${API_CONFIG.baseUrl}${API_CONFIG.endpoints.previewDocument}?id=${docId}`, '_blank');
        }
        
        // Helper function to get file type info
        function getFileTypeInfo(ext) {
            const types = {
                'pdf': { icon: '📄', class: 'pdf', gradient: 'linear-gradient(135deg, #ff6b6b 0%, #ff4444 100%)' },
                'doc': { icon: '📘', class: 'word', gradient: 'linear-gradient(135deg, #2185d0 0%, #1e5bb8 100%)' },
                'docx': { icon: '📘', class: 'word', gradient: 'linear-gradient(135deg, #2185d0 0%, #1e5bb8 100%)' },
                'xls': { icon: '📊', class: 'excel', gradient: 'linear-gradient(135deg, #21ba45 0%, #16ab39 100%)' },
                'xlsx': { icon: '📊', class: 'excel', gradient: 'linear-gradient(135deg, #21ba45 0%, #16ab39 100%)' },
                'txt': { icon: '📓', class: 'text', gradient: 'linear-gradient(135deg, #fbbd08 0%, #f2711c 100%)' },
                'csv': { icon: '📋', class: 'text', gradient: 'linear-gradient(135deg, #fbbd08 0%, #f2711c 100%)' },
                'json': { icon: '🕹️', class: 'text', gradient: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' },
                'xml': { icon: '🎯', class: 'text', gradient: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' },
                'jpg': { icon: '🎨', class: 'image', gradient: 'linear-gradient(135deg, #a333c8 0%, #9627ba 100%)' },
                'jpeg': { icon: '🎨', class: 'image', gradient: 'linear-gradient(135deg, #a333c8 0%, #9627ba 100%)' },
                'png': { icon: '🎨', class: 'image', gradient: 'linear-gradient(135deg, #a333c8 0%, #9627ba 100%)' },
                'gif': { icon: '🎨', class: 'image', gradient: 'linear-gradient(135deg, #a333c8 0%, #9627ba 100%)' },
                'bmp': { icon: '🎨', class: 'image', gradient: 'linear-gradient(135deg, #a333c8 0%, #9627ba 100%)' }
            };
            
            return types[ext] || { icon: '📁', class: 'unknown', gradient: 'linear-gradient(135deg, #767676 0%, #616161 100%)' };
        }
        
        // Helper function to format file size
        function formatFileSize(bytes) {
            if (!bytes || bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        // Load index statistics
        async function loadIndexStatistics() {
            try {
                // Query Azure Search for total document count
                const searchUrl = 'https://saxmegamind-search.search.windows.net/indexes/sop-documents/docs/search?api-version=2023-11-01';
                const response = await fetch(searchUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'api-key': 'sZf5MvolOU8wqcM0sb1jI8XhICcOrTCfSIRl44vLmMAzSeA34CDO'
                    },
                    body: JSON.stringify({
                        search: '*',
                        count: true,
                        top: 0
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const totalDocs = data['@odata.count'] || 0;
                    
                    // Update statistics in header
                    document.getElementById('totalDocCount').textContent = totalDocs.toLocaleString();
                    
                    // Estimate index size (rough calculation based on doc count)
                    const avgDocSize = 50; // KB average
                    const totalSizeMB = (totalDocs * avgDocSize / 1024).toFixed(1);
                    document.getElementById('totalIndexSize').textContent = `${totalSizeMB} MB`;
                    
                    // Set last update to now
                    const now = new Date();
                    const timeStr = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                    document.getElementById('lastIndexUpdate').textContent = timeStr;
                    
                    // Estimate vectorized count (for now, assume 80% are vectorized)
                    const vectorized = Math.floor(totalDocs * 0.8);
                    document.getElementById('vectorizedCount').textContent = vectorized.toLocaleString();
                }
            } catch (error) {
                console.error('Failed to load index statistics:', error);
            }
        }
        
        // Delete document function
        async function deleteDocument(docId, title) {
            // Prevent default action
            event.preventDefault();
            event.stopPropagation();
            
            // Confirm deletion
            if (!confirm(`Are you sure you want to delete "${title}"?\n\nThis action cannot be undone.`)) {
                return;
            }
            
            try {
                // First, try to delete from Azure Search index
                const searchUrl = `https://saxmegamind-search.search.windows.net/indexes/sop-documents/docs/index?api-version=2023-11-01`;
                const searchResponse = await fetch(searchUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'api-key': 'sZf5MvolOU8wqcM0sb1jI8XhICcOrTCfSIRl44vLmMAzSeA34CDO'
                    },
                    body: JSON.stringify({
                        value: [{
                            "@search.action": "delete",
                            "id": docId
                        }]
                    })
                });
                
                if (searchResponse.ok) {
                    // Show success message
                    alert(`Document "${title}" has been deleted successfully from the index.`);
                    
                    // Try to also delete from Azure Function if endpoint exists
                    try {
                        const deleteUrl = `${API_CONFIG.baseUrl}${API_CONFIG.endpoints.deleteDocument}`;
                        await fetch(deleteUrl, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'x-functions-key': API_CONFIG.functionKey
                            },
                            body: JSON.stringify({
                                id: docId,
                                fileName: title
                            })
                        });
                    } catch (err) {
                        console.log('Azure Function delete failed, but index deletion succeeded');
                    }
                    
                    // Refresh the document list
                    loadDepartmentDocuments();
                    
                    // Refresh statistics
                    loadIndexStatistics();
                } else {
                    const errorData = await searchResponse.text();
                    throw new Error(`Failed to delete document: ${errorData}`);
                }
            } catch (error) {
                console.error('Delete error:', error);
                alert(`Failed to delete document "${title}".\n\nError: ${error.message}`);
            }
        }

        // Removed duplicate downloadDocument function

        function handleUpdateTypeChange() {
            const updateType = updateTypeSelect.value;
            
            if (updateType === 'update') {
                existingSOPsDiv.classList.remove('hidden');
                additionalInfoDiv.classList.add('additional-info');
                loadExistingSOPs();
            } else if (updateType === 'new') {
                existingSOPsDiv.classList.add('hidden');
                additionalInfoDiv.classList.remove('additional-info');
                additionalInfoDiv.style.display = 'block';
                document.getElementById('sopTitle').required = true;
            } else {
                existingSOPsDiv.classList.add('hidden');
                additionalInfoDiv.style.display = 'none';
                document.getElementById('sopTitle').required = false;
            }
        }

        function loadExistingSOPs() {
            const department = departmentSelect.value;
            const sopType = sopTypeSelect.value;
            const updateType = updateTypeSelect.value;

            if (updateType === 'update' && department && sopType) {
                // Call Azure Function to get existing SOPs for this department/type
                fetchExistingSOPs(department, sopType)
                    .then(sops => {
                        displaySOPs(sops);
                    })
                    .catch(error => {
                        console.error('Error loading existing SOPs:', error);
                        displaySOPs([]);
                    });
            }
        }

        async function fetchExistingSOPs(department, sopType) {
            try {
                // Query Azure AI Search directly
                const searchUrl = 'https://saxmegamind-search.search.windows.net/indexes/sop-documents/docs/search?api-version=2023-11-01';
                const response = await fetch(searchUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'api-key': 'sZf5MvolOU8wqcM0sb1jI8XhICcOrTCfSIRl44vLmMAzSeA34CDO'
                    },
                    body: JSON.stringify({
                        search: '*',
                        filter: `department eq '${department.replace(/'/g, "''")}' and documentType eq '${sopType.replace(/'/g, "''")}}'`,
                        select: 'id,title,fileName,uploadDate',
                        top: 50,
                        orderby: 'uploadDate desc'
                    })
                });

                if (!response.ok) {
                    throw new Error(`Search API HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                // Azure AI Search returns results in 'value' array
                return data.value ? data.value.map(doc => ({
                    id: doc.id,
                    title: doc.title || doc.fileName,
                    lastModified: doc.uploadDate ? new Date(doc.uploadDate).toLocaleDateString() : 'Unknown'
                })) : [];
            } catch (error) {
                console.error('Document search failed:', error);
                return [];
            }
        }

        function displaySOPs(sops) {
            sopList.innerHTML = '';
            
            if (!sops || sops.length === 0) {
                sopList.innerHTML = '<div class="sop-item" style="color: #64748b;">No existing documents found</div>';
                return;
            }

            sops.forEach(sop => {
                const sopItem = document.createElement('div');
                sopItem.className = 'sop-item';
                sopItem.innerHTML = `
                    <div style="font-weight: 500;">${sop.title}</div>
                    <div style="font-size: 11px; color: #64748b; margin-top: 2px;">Modified: ${sop.lastModified || 'Unknown'}</div>
                `;
                sopItem.addEventListener('click', () => selectSOP(sop, sopItem));
                sopList.appendChild(sopItem);
            });
        }

        function selectSOP(sop, element) {
            document.querySelectorAll('.sop-item').forEach(item => item.classList.remove('selected'));
            element.classList.add('selected');
            selectedSOPIdInput.value = sop.id;
            additionalInfoDiv.style.display = 'block';
            additionalInfoDiv.classList.remove('additional-info');
            document.getElementById('sopTitle').value = sop.title;
            document.getElementById('sopTitle').required = false;
        }

        function handleDragOver(e) {
            e.preventDefault();
            fileUploadArea.classList.add('dragover');
        }

        function handleDragLeave(e) {
            e.preventDefault();
            fileUploadArea.classList.remove('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            fileUploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                fileInput.files = files;
                displaySelectedFile(files[0]);
            }
        }

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                displaySelectedFile(file);
            }
        }

        function displaySelectedFile(file) {
            const fileSize = formatFileSize(file.size);
            fileName.textContent = `${file.name} (${fileSize})`;
            selectedFileDiv.style.display = 'block';
            fileUploadArea.style.display = 'none';
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function handleFormSubmit(e) {
            e.preventDefault();
            
            if (!validateForm()) {
                return;
            }

            submitBtn.disabled = true;
            submitBtn.textContent = 'Processing...';
            progressBar.style.display = 'block';

            // Prepare form data for Azure Function
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            formData.append('department', departmentSelect.value);
            formData.append('sopType', sopTypeSelect.value);
            formData.append('updateType', updateTypeSelect.value);
            formData.append('title', document.getElementById('sopTitle').value || '');
            formData.append('description', document.getElementById('sopDescription').value || '');
            formData.append('keywords', document.getElementById('keywords').value || '');
            formData.append('version', document.getElementById('version').value || '1.0');
            
            if (updateTypeSelect.value === 'update') {
                formData.append('existingDocId', selectedSOPIdInput.value);
            }

            // Upload to Azure Function
            uploadDocument(formData)
                .then(response => {
                    completeUpload();
                    // Refresh the document explorer if a department is selected
                    if (departmentSelect.value) {
                        loadDepartmentDocuments();
                    }
                })
                .catch(error => {
                    console.error('Upload failed:', error);
                    handleUploadError(error);
                });
        }

        async function uploadDocument(formData) {
            try {
                // Upload directly to n8n webhook (which handles Azure storage and indexing)
                const file = formData.get('file');
                
                // Validate file exists
                if (!file || file.size === 0) {
                    throw new Error('No file selected or file is empty');
                }
                
                console.log('File details:', {
                    name: file.name,
                    type: file.type,
                    size: file.size
                });
                
                // Convert file to base64
                const fileContent = await fileToBase64(file);
                
                // Validate base64 content
                if (!fileContent || fileContent.length === 0) {
                    throw new Error('Failed to convert file to base64');
                }
                
                console.log('Base64 content generated, length:', fileContent.length);
                
                // Calculate file hash for deduplication
                const fileHash = await window.documentEnhancements?.calculateSHA256(file) || null;
                
                // Create the payload with both structures for compatibility
                const n8nPayload = {
                    // Flat structure for backward compatibility
                    fileName: file.name,
                    fileContent: fileContent,
                    mimeType: file.type || 'application/octet-stream',
                    department: formData.get('department') || 'General',
                    documentType: formData.get('sopType') || 'SOP',
                    title: formData.get('title') || file.name,
                    description: formData.get('description') || '',
                    keywords: formData.get('keywords') || '',
                    // Nested structure as expected by the n8n workflow
                    file: {
                        name: file.name,
                        type: file.type || 'application/octet-stream',
                        size: file.size,
                        content: fileContent
                    },
                    metadata: {
                        department: formData.get('department'),
                        documentType: formData.get('sopType'),
                        title: formData.get('title') || file.name,
                        description: formData.get('description') || '',
                        keywords: formData.get('keywords') || '',
                        version: formData.get('version') || '1.0',
                        updateType: formData.get('updateType'),
                        existingDocId: formData.get('existingDocId') || null,
                        uploadedBy: 'SAX Portal User',
                        uploadDate: new Date().toISOString(),
                        source: 'SAX Document Portal',
                        sha256Hash: fileHash,
                        contentHash: fileHash  // Include both for compatibility
                    }
                };
                
                console.log('Uploading document to n8n workflow...');
                console.log('Payload structure:', {
                    hasFile: !!n8nPayload.file,
                    hasFileContent: !!n8nPayload.file.content,
                    fileContentLength: n8nPayload.file.content ? n8nPayload.file.content.length : 0,
                    hasMetadata: !!n8nPayload.metadata
                });
                
                const response = await fetch(API_CONFIG.n8n.webhookUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(n8nPayload)
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('n8n webhook error response:', errorText);
                    throw new Error(`n8n webhook failed: HTTP ${response.status} - ${errorText}`);
                }
                
                const result = await response.json();
                console.log('Document uploaded successfully:', result);
                return result;
            } catch (error) {
                console.error('Upload failed:', error);
                throw error;
            }
        }
        
        async function triggerN8nWorkflow(formData, azureResult) {
            // Convert FormData to JSON for n8n webhook
            const file = formData.get('file');
            const fileContent = await fileToBase64(file);
            
            const n8nPayload = {
                file: {
                    name: file.name,
                    type: file.type,
                    size: file.size,
                    content: fileContent,
                    contentType: file.type || 'application/octet-stream'
                },
                metadata: {
                    department: formData.get('department'),
                    documentType: formData.get('sopType'),
                    title: formData.get('title') || file.name,
                    description: formData.get('description') || '',
                    keywords: formData.get('keywords') || '',
                    version: formData.get('version') || '1.0',
                    updateType: formData.get('updateType'),
                    existingDocId: formData.get('existingDocId') || null,
                    uploadedBy: 'SAX Portal User', // You can replace with actual user info
                    uploadDate: new Date().toISOString(),
                    source: 'SAX Document Portal',
                    azureBlobUrl: azureResult.blobUrl || null,
                    azureDocumentId: azureResult.documentId || null
                },
                indexing: {
                    indexName: 'sop-documents',
                    generateEmbeddings: true,
                    extractEntities: true
                }
            };
            
            const n8nResponse = await fetch(API_CONFIG.n8n.webhookUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(n8nPayload)
            });
            
            if (!n8nResponse.ok) {
                throw new Error(`n8n webhook failed: HTTP ${n8nResponse.status}`);
            }
            
            return await n8nResponse.json();
        }
        
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                // Validate file input
                if (!file) {
                    reject(new Error('No file provided to convert'));
                    return;
                }
                
                if (file.size === 0) {
                    reject(new Error('File is empty'));
                    return;
                }
                
                // Check file size limit (e.g., 10MB)
                const maxSize = 10 * 1024 * 1024; // 10MB in bytes
                if (file.size > maxSize) {
                    reject(new Error(`File size exceeds 10MB limit. File size: ${(file.size / 1024 / 1024).toFixed(2)}MB`));
                    return;
                }
                
                const reader = new FileReader();
                
                reader.onload = () => {
                    try {
                        const result = reader.result;
                        
                        // Validate result
                        if (!result || typeof result !== 'string') {
                            reject(new Error('Failed to read file content'));
                            return;
                        }
                        
                        // Check if it's a data URL
                        if (!result.includes(',')) {
                            reject(new Error('Invalid data URL format'));
                            return;
                        }
                        
                        // Remove the data:*/*;base64, prefix
                        const base64 = result.split(',')[1];
                        
                        // Validate base64 content
                        if (!base64 || base64.length === 0) {
                            reject(new Error('Failed to extract base64 content'));
                            return;
                        }
                        
                        console.log('Base64 conversion successful:', {
                            originalSize: file.size,
                            base64Length: base64.length,
                            mimeType: file.type
                        });
                        
                        resolve(base64);
                    } catch (error) {
                        reject(new Error(`Base64 conversion error: ${error.message}`));
                    }
                };
                
                reader.onerror = (error) => {
                    console.error('FileReader error:', error);
                    reject(new Error(`Failed to read file: ${error}`));
                };
                
                // Start reading the file
                try {
                    reader.readAsDataURL(file);
                } catch (error) {
                    reject(new Error(`Failed to start reading file: ${error.message}`));
                }
            });
        }

        function handleUploadError(error) {
            submitBtn.disabled = false;
            submitBtn.textContent = 'Upload Document';
            progressBar.style.display = 'none';
            progressFill.style.width = '0%';
            
            alert(`Upload failed: ${error.message}\n\nPlease try again or contact IT support if the problem persists.`);
        }

        function validateForm() {
            const department = departmentSelect.value;
            const sopType = sopTypeSelect.value;
            const updateType = updateTypeSelect.value;
            const file = fileInput.files[0];

            // Check file first with better UX
            if (!file) {
                alert('Please select a file to upload.');
                fileUploadArea.scrollIntoView({ behavior: 'smooth', block: 'center' });
                // Highlight the upload area briefly
                fileUploadArea.style.border = '2px solid #dc2626';
                setTimeout(() => {
                    fileUploadArea.style.border = '';
                }, 2000);
                return false;
            }

            if (!department) {
                alert('Please select a department.');
                departmentSelect.focus();
                return false;
            }

            if (!sopType) {
                alert('Please select a document type.');
                sopTypeSelect.focus();
                return false;
            }

            if (!updateType) {
                alert('Please select an action type (New Document or Update Existing).');
                updateTypeSelect.focus();
                return false;
            }

            if (updateType === 'update' && !selectedSOPIdInput.value) {
                alert('Please select an existing document to update.');
                existingSOPsDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
                return false;
            }

            if (updateType === 'new' && !document.getElementById('sopTitle').value.trim()) {
                alert('Please provide a title for the new document.');
                document.getElementById('sopTitle').focus();
                return false;
            }

            return true;
        }

        // Authentication helper functions - implement based on your Azure AD setup
        async function getAccessToken() {
            // Implement your Azure AD authentication logic here
            // This could use MSAL.js or your existing authentication system
            // return await msalInstance.acquireTokenSilent({...});
            throw new Error('Authentication not implemented - configure Azure AD integration');
        }

        // Utility function to get file extension icon
        function getFileTypeClass(filename) {
            const extension = filename.split('.').pop().toLowerCase();
            switch (extension) {
                case 'pdf': return 'pdf';
                case 'docx': 
                case 'doc': return 'docx';
                case 'xlsx':
                case 'xls': return 'xlsx';
                case 'txt': return 'txt';
                default: return 'pdf';
            }
        }

        function completeUpload() {
            submitBtn.style.display = 'none';
            progressBar.style.display = 'none';
            progressFill.style.width = '100%';
            successMessage.style.display = 'block';
            
            setTimeout(() => {
                form.reset();
                selectedFileDiv.style.display = 'none';
                fileUploadArea.style.display = 'block';
                existingSOPsDiv.classList.add('hidden');
                additionalInfoDiv.style.display = 'none';
                successMessage.style.display = 'none';
                submitBtn.style.display = 'block';
                submitBtn.disabled = false;
                submitBtn.textContent = 'Upload Document';
                progressFill.style.width = '0%';
            }, 3000);
        }
    </script>
    <!-- Document Preview Module -->
    <script src="js/document-preview.js"></script>
    <!-- Document Enhancements Module -->
    <script src="js/document-enhancements.js"></script>
    <script>
        // Initialize document enhancements after DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            if (!window.documentEnhancements) {
                window.documentEnhancements = new DocumentEnhancements();
                window.documentEnhancements.loadSavedDepartments();
                window.documentEnhancements.addDepartmentFilter();
            }
        });
    </script>
</body>
</html>
