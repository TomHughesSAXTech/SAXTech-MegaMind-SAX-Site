<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SAX Technology Advisors - Document Management Portal</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Arial', sans-serif; background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); min-height: 100vh; color: #333; display: flex; }
        .main-container { display: flex; width: 100%; min-height: 100vh; }
        .sidebar { width: 350px; background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-right: 1px solid rgba(0, 0, 0, 0.1); padding: 30px; overflow-y: auto; box-shadow: 2px 0 20px rgba(0, 0, 0, 0.1); }
        .main-content { flex: 1; padding: 30px; overflow-y: auto; }
        .header { text-align: center; margin-bottom: 30px; }
        .logo { font-size: 28px; font-weight: bold; color: #1e3c72; margin-bottom: 10px; }
        .subtitle { color: #666; font-size: 14px; line-height: 1.4; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #333; font-size: 14px; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; transition: all 0.3s ease; background: white; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: #1e3c72; box-shadow: 0 0 0 3px rgba(30, 60, 114, 0.1); }
        .form-group textarea { resize: vertical; min-height: 80px; }
        .file-upload-area { border: 2px dashed #ccc; border-radius: 10px; padding: 30px; text-align: center; transition: all 0.3s ease; background: rgba(248, 249, 250, 0.8); margin: 20px 0; }
        .file-upload-area.dragover { border-color: #1e3c72; background: rgba(30, 60, 114, 0.05); }
        .file-upload-area i { font-size: 48px; color: #ccc; margin-bottom: 15px; }
        .file-upload-area p { color: #666; margin-bottom: 15px; line-height: 1.5; }
        .file-input { display: none; }
        .file-input-label { display: inline-block; padding: 12px 24px; background: #1e3c72; color: white; border-radius: 6px; cursor: pointer; transition: all 0.3s ease; font-weight: 500; }
        .file-input-label:hover { background: #2a5298; transform: translateY(-2px); box-shadow: 0 4px 15px rgba(30, 60, 114, 0.3); }
        .upload-btn { width: 100%; padding: 15px; background: linear-gradient(45deg, #1e3c72, #2a5298); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; margin-top: 20px; }
        .upload-btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(30, 60, 114, 0.4); }
        .upload-btn:disabled { background: #ccc; cursor: not-allowed; transform: none; box-shadow: none; }
        .selected-file { background: rgba(30, 60, 114, 0.1); border: 2px solid #1e3c72; border-radius: 8px; padding: 15px; margin: 15px 0; display: flex; align-items: center; justify-content: space-between; }
        .file-info { display: flex; align-items: center; gap: 10px; }
        .file-info i { color: #1e3c72; font-size: 18px; }
        .file-details { flex: 1; }
        .file-name { font-weight: 600; color: #333; margin-bottom: 2px; }
        .file-size { color: #666; font-size: 12px; }
        .remove-file { background: #dc3545; color: white; border: none; border-radius: 4px; padding: 6px 10px; cursor: pointer; font-size: 12px; transition: all 0.3s ease; }
        .remove-file:hover { background: #c82333; }
        .upload-progress { margin-top: 20px; display: none; }
        .progress-bar { width: 100%; height: 8px; background: #e0e0e0; border-radius: 4px; overflow: hidden; margin-bottom: 10px; }
        .progress-fill { height: 100%; background: linear-gradient(45deg, #28a745, #34ce57); width: 0%; transition: width 0.3s ease; border-radius: 4px; }
        .progress-text { text-align: center; font-size: 14px; color: #666; font-weight: 500; }
        .upload-steps { margin-top: 15px; display: none; }
        .step { display: flex; align-items: center; padding: 8px 0; font-size: 13px; color: #666; }
        .step i { width: 20px; margin-right: 10px; color: #ccc; }
        .step.active i { color: #ffc107; animation: pulse 1.5s infinite; }
        .step.completed i { color: #28a745; }
        .step.error i { color: #dc3545; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .alert { padding: 12px 16px; border-radius: 6px; margin: 15px 0; font-size: 14px; line-height: 1.4; }
        .alert-success { background: rgba(40, 167, 69, 0.1); border: 1px solid rgba(40, 167, 69, 0.3); color: #155724; }
        .alert-error { background: rgba(220, 53, 69, 0.1); border: 1px solid rgba(220, 53, 69, 0.3); color: #721c24; }
        .alert-info { background: rgba(23, 162, 184, 0.1); border: 1px solid rgba(23, 162, 184, 0.3); color: #0c5460; }
        .compliance-notice { background: rgba(255, 193, 7, 0.1); border: 1px solid rgba(255, 193, 7, 0.3); color: #856404; padding: 15px; border-radius: 8px; margin-bottom: 20px; font-size: 12px; line-height: 1.5; }
        .compliance-notice h4 { margin-bottom: 8px; font-size: 13px; font-weight: 600; }
        .content-header { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-radius: 12px; padding: 25px; margin-bottom: 25px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1); }
        .content-title { font-size: 32px; font-weight: 700; color: #1e3c72; margin-bottom: 10px; }
        .content-subtitle { color: #666; font-size: 16px; line-height: 1.5; }
        .repository-browser { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-radius: 12px; padding: 25px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1); }
        .browser-controls { display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; }
        .search-input { flex: 1; min-width: 250px; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; }
        .department-filter { min-width: 180px; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; }
        .refresh-btn { padding: 12px 20px; background: #28a745; color: white; border: none; border-radius: 8px; cursor: pointer; transition: all 0.3s ease; font-weight: 500; }
        .refresh-btn:hover { background: #218838; transform: translateY(-1px); }
        .documents-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; margin-top: 20px; }
        .document-card { background: white; border-radius: 10px; padding: 20px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); transition: all 0.3s ease; border: 1px solid #e0e0e0; }
        .document-card:hover { transform: translateY(-3px); box-shadow: 0 6px 25px rgba(0, 0, 0, 0.15); }
        .document-header { display: flex; align-items: center; margin-bottom: 15px; }
        .document-icon { width: 40px; height: 40px; border-radius: 8px; display: flex; align-items: center; justify-content: center; margin-right: 12px; font-size: 16px; color: white; }
        .document-icon.pdf { background: #dc3545; } .document-icon.doc { background: #0d6efd; } .document-icon.xls { background: #198754; } .document-icon.ppt { background: #fd7e14; } .document-icon.txt { background: #6c757d; } .document-icon.default { background: #6f42c1; }
        .document-title { font-weight: 600; font-size: 16px; color: #333; margin-bottom: 5px; }
        .document-department { font-size: 12px; color: #666; background: #f8f9fa; padding: 2px 8px; border-radius: 12px; }
        .document-description { color: #666; font-size: 14px; line-height: 1.4; margin: 12px 0; }
        .document-meta { display: flex; justify-content: space-between; align-items: center; margin-top: 15px; font-size: 12px; color: #888; }
        .document-actions { display: flex; gap: 8px; flex-wrap: wrap; }
        .action-btn { padding: 6px 12px; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; transition: all 0.3s ease; text-decoration: none; display: inline-flex; align-items: center; gap: 4px; white-space: nowrap; }
        .action-btn.download { background: #17a2b8; color: white; }
        .action-btn.preview { background: #6c757d; color: white; }
        .action-btn:hover { transform: translateY(-1px); opacity: 0.9; }
        /* Modal styles */
        .modal { position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); display: none; }
        .modal-content { background: #fff; margin: 2% auto; padding: 20px; border-radius: 10px; width: 90%; max-width: 1200px; max-height: 90vh; overflow-y: auto; position: relative; text-align: center; }
        .loading { text-align: center; padding: 40px; color: #666; }
        .loading { text-align: center; padding: 40px; color: #666; }
        .loading i { font-size: 32px; margin-bottom: 15px; animation: spin 2s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .empty-state { text-align: center; padding: 60px 20px; color: #666; }
        .empty-state i { font-size: 64px; color: #ddd; margin-bottom: 20px; }
        .empty-state h3 { font-size: 20px; margin-bottom: 10px; color: #333; }
        @media (max-width: 768px) { .main-container { flex-direction: column; } .sidebar { width: 100%; order: 2; } .main-content { order: 1; padding: 20px; } .browser-controls { flex-direction: column; } .search-input, .department-filter { min-width: auto; } .documents-grid { grid-template-columns: 1fr; } .content-title { font-size: 24px; } }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="sidebar">
            <div class="header">
                <div class="logo"><i class="fas fa-file-alt"></i> SAX Tech</div>
                <div class="subtitle">Standard Operating Procedure<br>Document Management Portal</div>
            </div>
            <div class="compliance-notice">
                <h4><i class="fas fa-shield-alt"></i> Compliance Notice</h4>
                By uploading documents, you confirm they comply with company policies, contain no confidential client information without proper authorization, and meet data retention requirements.
            </div>
            <form id="uploadForm">
                <div class="form-group">
                    <label for="department">Department <span style="color: #dc3545;">*</span></label>
                    <select id="department" name="department" required>
                        <option value="">Select Department</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="documentType">Document Type <span style="color: #dc3545;">*</span></label>
                    <select id="documentType" name="documentType" required>
                        <option value="">Select Document Type</option>
                        <option value="SOP">Standard Operating Procedure</option>
                        <option value="Policy">Company Policy</option>
                        <option value="Process">Process Documentation</option>
                        <option value="Guideline">Guidelines & Best Practices</option>
                        <option value="Form">Forms & Templates</option>
                        <option value="Manual">User Manual</option>
                        <option value="Procedure">Work Instruction</option>
                        <option value="Checklist">Checklist</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="actionType">Action Type <span style="color: #dc3545;">*</span></label>
                    <select id="actionType" name="actionType" required>
                        <option value="">Select Action</option>
                        <option value="new">New Document</option>
                        <option value="update">Update Existing Document</option>
                    </select>
                </div>
                <div class="form-group" id="existingWrap" style="display:none;">
                    <label for="existingDoc">Existing Document</label>
                    <select id="existingDoc">
                        <option value="">Select a document to update</option>
                    </select>
                </div>
                <div id="metaSection">
                    <div class="form-group">
                        <label for="title">Document Title <span style="color: #dc3545;">*</span></label>
                        <input type="text" id="title" name="title" required maxlength="200" placeholder="Enter a clear, descriptive title">
                    </div>
                    <div class="form-group">
                        <label for="description">Description <span style="color: #dc3545;">*</span></label>
                        <textarea id="description" name="description" required maxlength="1000" placeholder="Provide a detailed description of the document's purpose and contents"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="keywords">Keywords <span style="color: #dc3545;">*</span></label>
                        <input type="text" id="keywords" name="keywords" required placeholder="Enter comma-separated keywords for searchability">
                    </div>
                    <div class="form-group">
                        <label for="version">Version</label>
                        <input type="text" id="version" name="version" placeholder="e.g., 1.0, 2.1">
                    </div>
                </div>
                <div class="file-upload-area" id="fileUploadArea">
                    <i class="fas fa-cloud-upload-alt"></i>
                    <p><strong>Drag and drop your document here</strong></p>
                    <p>or</p>
                    <label for="fileInput" class="file-input-label"><i class="fas fa-folder-open"></i> Browse Files</label>
                    <input type="file" id="fileInput" class="file-input" accept=".pdf,.doc,.docx,.ppt,.pptx,.xls,.xlsx,.txt">
                    <p style="margin-top: 15px; font-size: 12px; color: #888;">Supported formats: PDF, DOC, DOCX, PPT, PPTX, XLS, XLSX, TXT<br>Maximum file size: 50MB</p>
                </div>
                <div id="selectedFileContainer"></div>
                <button type="submit" class="upload-btn" id="uploadBtn" disabled><i class="fas fa-upload"></i> Upload Document</button>
                <div class="upload-progress" id="uploadProgress">
                    <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
                    <div class="progress-text" id="progressText">Preparing upload...</div>
                    <div class="upload-steps" id="uploadSteps">
                        <div class="step" data-step="hash"><i class="fas fa-fingerprint"></i><span>Calculating file hash...</span></div>
                        <div class="step" data-step="duplicate"><i class="fas fa-search"></i><span>Checking for duplicates...</span></div>
                        <div class="step" data-step="chunk"><i class="fas fa-cut"></i><span>Creating chunks...</span></div>
                        <div class="step" data-step="upload"><i class="fas fa-cloud-upload-alt"></i><span>Uploading to cloud storage...</span></div>
                        <div class="step" data-step="index"><i class="fas fa-database"></i><span>Adding to search index...</span></div>
                        <div class="step" data-step="embeddings"><i class="fas fa-brain"></i><span>Creating AI embeddings...</span></div>
                    </div>
                </div>
                <div id="uploadStatus"></div>
            </form>
        </div>
        <div class="main-content">
            <div class="content-header">
                <h1 class="content-title"><i class="fas fa-archive"></i> Document Repository</h1>
                <p class="content-subtitle">Browse and manage your organization's Standard Operating Procedures and documentation. Use the sidebar to upload new documents or update existing ones.</p>
            </div>
            <div class="repository-browser">
                <div class="browser-controls">
                    <input type="text" class="search-input" id="searchInput" placeholder="Search documents by title, description, or keywords...">
                    <select class="department-filter" id="departmentFilter">
                        <option value="">All Departments</option>
                    </select>
                    <button class="refresh-btn" id="refreshBtn" onclick="loadAll()"><i class="fas fa-sync-alt"></i> Refresh</button>
                </div>
                <div class="documents-grid" id="documentsGrid"></div>
            </div>
        </div>
    </div>
    <div id="uploadModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div id="modalContent"></div>
            <button onclick="closeModal()" style="margin-top: 20px; padding: 10px 20px; background: #1e3c72; color: white; border: none; border-radius: 5px; cursor: pointer;">Close</button>
        </div>
    </div>
    <script>
        const API_BASE_URL = 'https://saxtech-megamind.azurewebsites.net/api';
        const fileInput = document.getElementById('fileInput');
        const fileUploadArea = document.getElementById('fileUploadArea');
        const selectedFileContainer = document.getElementById('selectedFileContainer');
        const uploadBtn = document.getElementById('uploadBtn');
        const uploadForm = document.getElementById('uploadForm');
        const uploadProgress = document.getElementById('uploadProgress');
        const progressFill = document.getElementById('progressFill');
        const progressText = document.getElementById('progressText');
        const uploadSteps = document.getElementById('uploadSteps');
        const uploadStatus = document.getElementById('uploadStatus');
        const documentsGrid = document.getElementById('documentsGrid');
        const searchInput = document.getElementById('searchInput');
        const departmentFilter = document.getElementById('departmentFilter');
        const departmentSelect = document.getElementById('department');
        const actionType = document.getElementById('actionType');
        const existingWrap = document.getElementById('existingWrap');
        const existingDoc = document.getElementById('existingDoc');
        const metaSection = document.getElementById('metaSection');
        let selectedFile = null;
        let uploadInProgress = false;
        let documentsCache = [];
        let knownDepartments = [];

        function populateDepartmentSelects(depts) {
            if (!depts || depts.length === 0) {
                departmentSelect.innerHTML = '<option value="">No departments available</option>';
                departmentFilter.innerHTML = '<option value="">All Departments</option>';
                return;
            }
            const deptOptions = ['<option value="">Select Department</option>'].concat(
                depts.map(d => `<option value="${escapeHtml(d)}">${escapeHtml(d)}</option>`)
            ).join('');
            departmentSelect.innerHTML = deptOptions;
            const filterOpts = ['<option value="">All Departments</option>'].concat(
                depts.map(d => `<option value="${escapeHtml(d)}">${escapeHtml(d)}</option>`)
            ).join('');
            departmentFilter.innerHTML = filterOpts;
        }

        function escapeHtml(s){return String(s).replace(/[&<>"]/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[c]||c));}

        fileInput.addEventListener('change', handleFileSelect);
        fileUploadArea.addEventListener('dragover', handleDragOver);
        fileUploadArea.addEventListener('dragleave', handleDragLeave);
        fileUploadArea.addEventListener('drop', handleFileDrop);
        uploadForm.addEventListener('submit', handleUpload);
        searchInput.addEventListener('input', debounce(filterDocuments, 300));
        departmentFilter.addEventListener('change', filterDocuments);

        actionType.addEventListener('change', async () => {
            const at = actionType.value;
            if (at === 'update') {
                existingWrap.style.display = '';
                if (documentsCache.length === 0) await loadAll();
                refreshExistingDocOptions(departmentSelect.value);
            } else {
                existingWrap.style.display = 'none';
                existingDoc.innerHTML = '<option value="">Select a document to update</option>';
            }
        });

        departmentSelect.addEventListener('change', () => {
            if (actionType.value === 'update') refreshExistingDocOptions(departmentSelect.value);
        });

        existingDoc.addEventListener('change', () => {
            const id = existingDoc.value;
            if (!id) return;
            const doc = documentsCache.find(d => (d.id||d.fileName) === id);
            if (!doc) return;
            document.getElementById('title').value = doc.title || '';
            document.getElementById('description').value = doc.description || '';
            document.getElementById('keywords').value = Array.isArray(doc.keywords)? doc.keywords.join(', ') : (doc.keywords || '');
            document.getElementById('version').value = doc.version || '';
        });

        function refreshExistingDocOptions(dept){
            const opts = ['<option value="">Select a document to update</option>'];
            (documentsCache||[]).filter(d => !dept || d.department === dept).forEach(d => {
                const id = d.id || d.fileName;
                const title = d.title || d.fileName || 'Untitled';
                opts.push(`<option value="${escapeHtml(id)}">${escapeHtml(title)}</option>`);
            });
            existingDoc.innerHTML = opts.join('');
        }

        function handleFileSelect(event){ const file = event.target.files[0]; if (file) validateAndSetFile(file);}
        function handleDragOver(event){ event.preventDefault(); fileUploadArea.classList.add('dragover'); }
        function handleDragLeave(event){ event.preventDefault(); fileUploadArea.classList.remove('dragover'); }
        function handleFileDrop(event){ event.preventDefault(); fileUploadArea.classList.remove('dragover'); const file = event.dataTransfer.files[0]; if (file) validateAndSetFile(file);}

        function validateAndSetFile(file){
            const allowedTypes = ['.pdf','.doc','.docx','.ppt','.pptx','.xls','.xlsx','.txt'];
            const ext='.'+file.name.split('.').pop().toLowerCase();
            if (!allowedTypes.includes(ext)){ showAlert('error','Invalid file type. Please select a supported document format.'); return; }
            const maxSize = 50*1024*1024; if (file.size>maxSize){ showAlert('error','File size exceeds 50MB limit. Please select a smaller file.'); return; }
            selectedFile = file; displaySelectedFile(file); uploadBtn.disabled = false;
        }

        function displaySelectedFile(file){ const fileSize = formatFileSize(file.size); const fileIcon = getFileIcon(file.name); selectedFileContainer.innerHTML = `
            <div class="selected-file">
              <div class="file-info"><i class="${fileIcon}"></i><div class="file-details"><div class="file-name">${file.name}</div><div class="file-size">${fileSize}</div></div></div>
              <button type="button" class="remove-file" onclick="removeFile()"><i class="fas fa-times"></i> Remove</button>
            </div>`; }

        function removeFile(){ selectedFile=null; selectedFileContainer.innerHTML=''; fileInput.value=''; uploadBtn.disabled=true; clearUploadStatus(); }

        function getFileIcon(filename){ const ext=filename.split('.').pop().toLowerCase(); const map={pdf:'fas fa-file-pdf',doc:'fas fa-file-word',docx:'fas fa-file-word',ppt:'fas fa-file-powerpoint',pptx:'fas fa-file-powerpoint',xls:'fas fa-file-excel',xlsx:'fas fa-file-excel',txt:'fas fa-file-alt'}; return map[ext]||'fas fa-file'; }
        function formatFileSize(bytes){ if(bytes===0) return '0 Bytes'; const k=1024; const sizes=['Bytes','KB','MB','GB']; const i=Math.floor(Math.log(bytes)/Math.log(k)); return parseFloat((bytes/Math.pow(k,i)).toFixed(2))+' '+sizes[i]; }

        async function handleUpload(event){
            event.preventDefault();
            if (!selectedFile || uploadInProgress) return;
            const formData = new FormData(uploadForm);
            const requiredFields=['department','documentType','actionType','title','description','keywords'];
            for (const f of requiredFields){ if(!formData.get(f)){ showAlert('error',`Please fill in the ${f.replace(/([A-Z])/g,' $1').toLowerCase()} field.`); return; } }
            if (formData.get('actionType')==='update' && !existingDoc.value){ showAlert('error','Select a document to update'); return; }
            uploadInProgress=true; uploadBtn.disabled=true; uploadProgress.style.display='block'; uploadSteps.style.display='block'; clearUploadStatus();
            try { await processUpload(formData); } catch (e){ console.error('Upload failed:',e); showAlert('error', `Upload failed: ${e.message}`); updateStepStatus('error'); } finally { uploadInProgress=false; uploadBtn.disabled=false; }
        }

        async function processUpload(formData){
            updateStepStatus('hash','active'); updateProgress(10,'Calculating file hash...');
            const fileHash = await calculateFileHash(selectedFile); updateStepStatus('hash','completed');
            updateStepStatus('duplicate','active'); updateProgress(20,'Checking for duplicates...');
            const isDuplicate = await checkDuplicate(fileHash); if (isDuplicate) { throw new Error('A document with identical content already exists in the system.'); } updateStepStatus('duplicate','completed');
            updateStepStatus('chunk','active'); updateProgress(30,'Preparing document chunks...');
            const chunks = await createChunks(selectedFile); updateStepStatus('chunk','completed');
            updateStepStatus('upload','active'); updateProgress(50,'Uploading to cloud storage...');
            const uploadData = { file: selectedFile, hash: fileHash, chunks, metadata: { department: formData.get('department'), documentType: formData.get('documentType'), actionType: formData.get('actionType'), title: formData.get('title'), description: formData.get('description'), keywords: formData.get('keywords'), version: formData.get('version')||'1.0', uploadedAt: new Date().toISOString(), fileSize: selectedFile.size, fileName: selectedFile.name } };
            if (formData.get('actionType')==='update' && existingDoc.value){ uploadData.metadata.documentId = existingDoc.value; }
            const uploadResult = await uploadToCloud(uploadData); updateStepStatus('upload','completed');
            updateStepStatus('index','active'); updateProgress(80,'Adding to search index...'); await addToSearchIndex(uploadResult); updateStepStatus('index','completed');
            updateStepStatus('embeddings','active'); updateProgress(95,'Creating AI embeddings...'); await createEmbeddings(uploadResult); updateStepStatus('embeddings','completed');
            updateProgress(100,'Upload completed successfully!'); showAlert('success','Document uploaded successfully! It is now available in the repository and search index.');
            setTimeout(()=>{ resetForm(); loadAll(); },2000);
        }

        async function calculateFileHash(file){ return new Promise((resolve)=>{ const reader=new FileReader(); reader.onload=async (e)=>{ const ab=e.target.result; const hb=await crypto.subtle.digest('SHA-256',ab); const ha=Array.from(new Uint8Array(hb)); const hx=ha.map(b=>b.toString(16).padStart(2,'0')).join(''); resolve(hx); }; reader.readAsArrayBuffer(file); }); }

        async function checkDuplicate(fileHash){ try{ const r=await fetch(`${API_BASE_URL}/check-duplicate?hash=${fileHash}`,{method:'GET',headers:{'Content-Type':'application/json'}}); if(!r.ok){ console.warn('Duplicate check failed, proceeding'); return false; } const j=await r.json(); return j.isDuplicate||false; } catch(e){ console.warn('Duplicate check error:',e); return false; } }

        async function createChunks(file){ return [{ id:1, content:`Document: ${file.name}`, page:1, length:file.size }]; }

        async function uploadToCloud(uploadData){ const fd=new FormData(); fd.append('file',uploadData.file); fd.append('metadata',JSON.stringify(uploadData.metadata)); fd.append('hash',uploadData.hash); fd.append('chunks',JSON.stringify(uploadData.chunks)); const res=await fetchWithRetry(`${API_BASE_URL}/documents/upload-json-enhanced`,{ method:'POST', body:fd }); if(!res.ok){ const t=await res.text(); throw new Error(`Upload failed: ${res.status} - ${t}`);} return await res.json(); }

        async function addToSearchIndex(result){ try{ const r=await fetchWithRetry(`${API_BASE_URL}/search-index/add`,{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(result)}); if(!r.ok){ console.warn('Search index update failed'); } } catch(e){ console.warn('Search index error:',e);} }
        async function createEmbeddings(result){ try{ const r=await fetchWithRetry(`${API_BASE_URL}/embeddings/create`,{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(result)}); if(!r.ok){ console.warn('Embeddings creation failed'); } } catch(e){ console.warn('Embeddings error:',e);} }

        async function fetchWithRetry(url,options,maxRetries=3){ for(let i=0;i<maxRetries;i++){ try{ const res=await fetch(url,options); if(res.ok||i===maxRetries-1) return res; await new Promise(r=>setTimeout(r,1000*(i+1))); } catch(e){ if(i===maxRetries-1) throw e; await new Promise(r=>setTimeout(r,1000*(i+1))); } } }

        function updateStepStatus(step,status){ const el=document.querySelector(`[data-step="${step}"]`); if(el){ el.className=`step ${status}`; } }
        function updateProgress(pct,text){ progressFill.style.width=`${pct}%`; progressText.textContent=text; }
        function resetForm(){ uploadForm.reset(); removeFile(); uploadProgress.style.display='none'; uploadSteps.style.display='none'; document.querySelectorAll('.step').forEach(s=>s.className='step'); updateProgress(0,'Preparing upload...'); }
        function showAlert(type,message){ const d=document.createElement('div'); d.className=`alert alert-${type}`; d.innerHTML=`<i class="fas fa-${type==='success'?'check-circle':type==='error'?'exclamation-circle':'info-circle'}"></i> ${message}`; uploadStatus.appendChild(d); setTimeout(()=>{ if(d.parentNode) d.parentNode.removeChild(d); },5000);}
        function clearUploadStatus(){ uploadStatus.innerHTML=''; }

        function fromSearchValueToDocs(value){
            const map = new Map();
            for (const c of value || []) {
                const id = c.documentId || c.id || c.fileId;
                if (!id) continue;
                if (!map.has(id)) {
                    map.set(id, {
                        id,
                        title: c.title || c.fileName || `Document ${id}`,
                        description: c.description || '',
                        department: c.department || '',
                        keywords: Array.isArray(c.keywords) ? c.keywords : [],
                        uploadedAt: c.uploadDate || c.uploadedAt || null,
                        fileName: c.fileName || '',
                        fileSize: c.fileSize || 0
                    });
                }
            }
            return Array.from(map.values());
        }

        async function robustFetchDocuments(){
            const attempts = [
                { m:'POST', u:`${API_BASE_URL}/documents/search`,          b:{ query:'*', top:1000 } },
                { m:'POST', u:`${API_BASE_URL}/search/documents`,          b:{ query:'*', top:1000 } },
                { m:'GET',  u:`${API_BASE_URL}/documents` },
                { m:'GET',  u:`${API_BASE_URL}/documents/list` },
                { m:'GET',  u:`${API_BASE_URL}/documents-search?all=true` },
                { m:'POST', u:`${API_BASE_URL}/documents-search`,          b:{ query:'*', top:1000 } },
                { m:'GET',  u:`${API_BASE_URL}/documents/search?all=true` },
                { m:'GET',  u:`${API_BASE_URL}/search/documents?all=true` }
            ];
            for (const a of attempts){
                try {
                    const opts = a.m==='POST' ? { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(a.b||{}) } : { method:'GET' };
                    const res = await fetch(a.u, opts);
                    if (res.ok){
                        const data = await res.json();
                        if (Array.isArray(data)) return data;
                        if (Array.isArray(data.value)) return fromSearchValueToDocs(data.value);
                        if (Array.isArray(data.results)) return fromSearchValueToDocs(data.results);
                        if (Array.isArray(data.items)) return data.items;
                        if (Array.isArray(data.documents)) return data.documents;
                        if (data.documents) return data.documents;
                    }
                } catch (e) { /* try next */ }
            }
            return [];
        }

        async function fetchConfigDepartments(){
            // Try blob-based config first
            try {
                const qs = `containerName=${encodeURIComponent('megamind-config')}&blobPath=${encodeURIComponent('departments.json')}`;
                const sas = await fetch(`${API_BASE_URL}/generatesastoken?${qs}`);
                if (sas.ok) {
                    const j = await sas.json().catch(()=>({}));
                    const url = j.blobUrl || j.url || j.sasUrl;
                    if (url) {
                        const r = await fetch(url, { cache: 'no-store' });
                        if (r.ok) {
                            const jb = await r.json();
                            return Array.isArray(jb) ? jb : (jb.departments || []);
                        }
                    }
                }
            } catch {}
            // Fallback to site file
            try {
                const res = await fetch('/config/departments.json', { cache: 'no-store' });
                if (!res.ok) return [];
                const data = await res.json();
                return Array.isArray(data) ? data : (data.departments || []);
            } catch { return []; }
        }

        async function loadAll(){
            documentsGrid.innerHTML=`<div class="loading"><i class="fas fa-spinner"></i><p>Loading documents...</p></div>`;
            const [docs, cfgDepts] = await Promise.all([ robustFetchDocuments(), fetchConfigDepartments() ]);
            documentsCache = docs;
            displayDocuments(documentsCache);
            const uniqueDepts = [...new Set([
                ...(documentsCache||[]).map(d => d.department).filter(Boolean),
                ...(cfgDepts||[]).filter(Boolean)
            ])].sort();
            populateDepartmentSelects(uniqueDepts);
            knownDepartments = uniqueDepts;
            if (actionType.value==='update') refreshExistingDocOptions(departmentSelect.value);
        }

        function displayDocuments(documents){
            const allowed = new Set(['pdf','doc','docx','xls','xlsx','ppt','pptx','txt','csv','mp4','mov','avi','mkv','webm']);
            const filtered = (documents||[]).filter(doc => {
                const fn = (doc.fileName||'').toLowerCase();
                const ext = fn.split('.').pop();
                return fn && allowed.has(ext);
            });
            if(!filtered.length){
                documentsGrid.innerHTML=`<div class=\"empty-state\"><i class=\"fas fa-folder-open\"></i><h3>No Documents Found</h3><p>No supported documents found. Upload PDF, Office, TXT, CSV, or video files.</p></div>`;
                return;
            }
            const html = filtered.map(doc => createDocumentCard(doc)).join('');
            documentsGrid.innerHTML = html;
            filterDocuments();
        }

        function createDocumentCard(doc){ const ext = doc.fileName ? doc.fileName.split('.').pop().toLowerCase() : 'default'; const iconClass = getDocumentIconClass(ext); const dateStr = new Date(doc.uploadedAt || Date.now()).toLocaleDateString(); const sizeStr = formatFileSize(doc.fileSize||0); return `
            <div class="document-card">
                <div class="document-header">
                    <div class="document-icon ${ext}"><i class="${iconClass}"></i></div>
                    <div style="flex:1;">
                        <div class="document-title">${doc.title||'Untitled Document'}</div>
                        <div class="document-department">${doc.department||'Unknown'}</div>
                    </div>
                </div>
                <div class="document-description">${doc.description||'No description available.'}</div>
                <div class="document-meta">
                    <div><div style="margin-bottom:4px;"><i class="fas fa-calendar"></i> ${dateStr}</div><div><i class="fas fa-file"></i> ${sizeStr}</div></div>
                    <div class="document-actions">
                        <a href="#" class="action-btn download" onclick="downloadDocument('${doc.id||doc.fileName}')"><i class="fas fa-download"></i> Download</a>
                        <a href="#" class="action-btn preview" onclick="previewDocument('${doc.id||doc.fileName}','${ext}')"><i class="fas fa-eye"></i> Preview</a>
                        <a href="#" class="action-btn delete" onclick="deleteDocument('${doc.id||doc.fileName}')"><i class="fas fa-trash"></i> Delete</a>
                    </div>
                </div>
            </div>`; }

        function getDocumentIconClass(ext){ const map={ pdf:'fas fa-file-pdf', doc:'fas fa-file-word', docx:'fas fa-file-word', ppt:'fas fa-file-powerpoint', pptx:'fas fa-file-powerpoint', xls:'fas fa-file-excel', xlsx:'fas fa-file-excel', txt:'fas fa-file-alt'}; return map[ext]||'fas fa-file'; }

        async function downloadDocument(documentId){ try{ const safeId = encodeURIComponent(documentId); const r=await fetch(`${API_BASE_URL}/documents/download/${safeId}`,{method:'GET'}); if(!r.ok){ throw new Error('Download failed'); } const blob=await r.blob(); const url=window.URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=documentId; document.body.appendChild(a); a.click(); window.URL.revokeObjectURL(url); document.body.removeChild(a);} catch(e){ console.error('Download failed:',e); alert('Download failed. Please try again.'); } }

        async function deleteDocument(documentId){
            try{
                if(!confirm('Delete this document? This cannot be undone.')) return;
                const safeId = encodeURIComponent(documentId);
                const attempts = [
                    { m:'DELETE', u:`${API_BASE_URL}/documents/delete/${safeId}` },
                    { m:'POST', u:`${API_BASE_URL}/documents/delete`, body: { ids: [documentId] }},
                    { m:'POST', u:`${API_BASE_URL}/documents/delete`, body: { documentIds: [documentId] }}
                ];
                let ok = false;
                for(const a of attempts){
                    try{
                        const res = await fetch(a.u, { method: a.m, headers: a.body ? { 'Content-Type':'application/json' } : undefined, body: a.body ? JSON.stringify(a.body) : undefined });
                        if(res.ok){ ok = true; break; }
                    }catch(e){/* try next */}
                }
                if(!ok){ throw new Error('Delete endpoint not available'); }
                showAlert('success','Document deleted');
                await loadAll();
            }catch(e){
                console.error('Delete failed:', e);
                showAlert('error','Delete failed');
            }
        }

        function getDocById(id){
            return (documentsCache||[]).find(d => (d.id||d.fileName) === id);
        }

        async function checkBlobExists(url){
            // Avoid blocking on CORS: treat unknown as true and let the iframe load
            try { const h = await fetch(url, { method: 'HEAD' }); if (h.ok) return true; } catch(e){ return true; }
            try { const r = await fetch(url, { method: 'GET', headers: { 'Range': 'bytes=0-0' } }); return r.ok; } catch(e){ return true; }
        }

        async function tryGetSasUrl(documentId){
            const doc = getDocById(documentId);
            const candidates = [];
            const fn = (doc?.fileName||'').trim();
            const dept = (doc?.department||'').trim();
            if (doc && doc.blobPath) candidates.push(doc.blobPath);
            if (fn && dept) candidates.push(`${dept}/${fn}`);
            if (fn) candidates.push(fn);
            // Try other known departments for this filename
            (knownDepartments||[]).forEach(d => { if (fn && d && d !== dept) candidates.push(`${d}/${fn}`); });
            // Deduplicate while preserving order
            const seen = new Set();
            const uniq = candidates.filter(p => { if (seen.has(p)) return false; seen.add(p); return true; });

            // Try blobPath candidates first
            for (const p of uniq) {
                const safeBlob = encodeURIComponent(p);
                try{
                    const res = await fetch(`${API_BASE_URL}/generatesastoken?blobPath=${safeBlob}`);
                    if(!res.ok) continue;
                    const data = await res.json().catch(()=>({}));
                    const blobUrl = data.blobUrl || data.sasUrl || data.url;
                    if(blobUrl && await checkBlobExists(blobUrl)) return blobUrl;
                }catch(e){ /* try next */ }
            }

            // Fallback attempts using documentId and legacy routes
            const safeId = encodeURIComponent(documentId);
            const attempts = [
                { m:'GET',  u:`${API_BASE_URL}/generatesastoken?documentId=${safeId}` },
                { m:'POST', u:`${API_BASE_URL}/generatesastoken`,     body:{ documentId } },
                { m:'POST', u:`${API_BASE_URL}/GenerateSASToken`,     body:{ documentId } },
                { m:'POST', u:`${API_BASE_URL}/generate-sas-token`,   body:{ documentId } },
                { m:'POST', u:`${API_BASE_URL}/documents/generate-sas`, body:{ documentId } },
                { m:'POST', u:`${API_BASE_URL}/sas/generate`,         body:{ documentId } },
                { m:'GET',  u:`${API_BASE_URL}/documents/preview/${safeId}` }
            ];
            for (const a of attempts) {
                try{
                    let res;
                    if(a.m==='POST'){
                        res = await fetch(a.u,{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(a.body||{}) });
                    } else {
                        res = await fetch(a.u);
                    }
                    if(!res.ok) continue;
                    const data = await res.json().catch(()=>({}));
                    const blobUrl = data.blobUrl || data.sasUrl || data.url || data.previewUrl || data.downloadUrl;
                    if(blobUrl && await checkBlobExists(blobUrl)) return blobUrl;
                }catch(e){ /* continue */ }
            }
            return null;
        }

        function buildPreviewContent(sasUrl, ext){
            const isPdf = ext==='pdf';
            const isOffice = ['doc','docx','ppt','pptx','xls','xlsx'].includes(ext);
            if(isPdf){
                return `<div style="height:80vh;"><iframe src="${sasUrl}" style="width:100%;height:100%;border:0"></iframe></div>`;
            } else if(isOffice){
                const office = 'https://view.officeapps.live.com/op/view.aspx?src=' + encodeURIComponent(sasUrl);
                return `<div style="height:80vh;"><iframe src="${office}" style="width:100%;height:100%;border:0"></iframe></div>`;
            } else if(ext==='txt'){
                return `<div style="text-align:left;max-height:70vh;overflow:auto;"><iframe src="${sasUrl}" style="width:100%;height:70vh;border:0"></iframe></div>`;
            }
            return `<p>Preview not available. <a href="${sasUrl}" target="_blank" rel="noopener">Open file</a></p>`;
        }

        async function previewDocument(documentId, extHint){
            try{
                showModal('<div class="loading"><i class="fas fa-spinner"></i><p>Generating preview link...</p></div>');
                const sasUrl = await tryGetSasUrl(documentId);
                if(!sasUrl){
                    showModal('<p style="color:#dc3545;">Preview not available for this document.</p>');
                    return;
                }
                const ext = (extHint||'').toLowerCase();
                const content = buildPreviewContent(sasUrl, ext);
                showModal(content);
            } catch(e){
                console.error('Preview failed:',e);
                showModal('<p style="color:#dc3545;">Preview failed. Please try again.</p>');
            }
        }

        function filterDocuments(){ const term = searchInput.value.toLowerCase(); const dept = departmentFilter.value; const cards = document.querySelectorAll('.document-card'); cards.forEach(card=>{ const title=card.querySelector('.document-title')?.textContent?.toLowerCase()||''; const desc=card.querySelector('.document-description')?.textContent?.toLowerCase()||''; const d=card.querySelector('.document-department')?.textContent||''; const match = (!term || title.includes(term) || desc.includes(term)) && (!dept || d===dept); card.style.display = match ? 'block':'none'; }); }

        function debounce(fn,wait){ let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args),wait); }; }

        function showModal(content){ document.getElementById('modalContent').innerHTML = content; document.getElementById('uploadModal').style.display='block'; }
        function closeModal(){ document.getElementById('uploadModal').style.display='none'; }

        document.addEventListener('DOMContentLoaded', function(){ loadAll(); document.addEventListener('keydown', function(event){ if(event.ctrlKey && event.key==='u'){ event.preventDefault(); fileInput.click(); } }); });
        window.onclick = function(event){ const modal=document.getElementById('uploadModal'); if(event.target===modal){ closeModal(); } }
    </script>
</body>
</html>
