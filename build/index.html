<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MegaMind Talk</title>
    <!-- MSAL for Microsoft sign-in -->
    <script src="https://alcdn.msauth.net/browser/2.38.0/js/msal-browser.min.js" crossorigin="anonymous"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #000000 0%, #1a1a1a 25%, #FFD700 50%, #FFA500 75%, #000000 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        /* Authentication overlay */
        .auth-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .auth-card {
            background: linear-gradient(135deg, #2C2C2C 0%, #1F1F1F 50%, #333333 100%);
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            box-shadow: 0 25px 50px rgba(0,0,0,0.5);
            border: 1px solid rgba(255,215,0,0.3);
            max-width: 400px;
            width: 100%;
        }

        .robot-logo {
            margin-bottom: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        /* Robot SVG with floating animation */
        .robot-image {
            width: 120px;
            height: 120px;
            animation: float 3s ease-in-out infinite;
            filter: drop-shadow(0 8px 16px rgba(0,0,0,0.3));
        }
        
        .robot-shadow {
            position: absolute;
            bottom: -15px;
            left: 50%;
            transform: translateX(-50%);
            width: 80px;
            height: 15px;
            background: radial-gradient(ellipse, rgba(0,0,0,0.2) 0%, transparent 70%);
            border-radius: 50%;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        .auth-card h1 {
            color: #FFD700;
            font-size: 32px;
            margin-bottom: 20px;
            letter-spacing: 2px;
        }

        .auth-card p {
            color: #999;
            margin-bottom: 30px;
            font-size: 16px;
        }

        .sign-in-btn {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: #1a1a1a;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .sign-in-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(255,215,0,0.3);
        }

        /* User profile bar */
        .user-profile {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 15px 20px;
            color: white;
            z-index: 100;
            border: 1px solid rgba(255,215,0,0.3);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #FFD700, #FFA500);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #1a1a1a;
        }

        .user-details h3 {
            font-size: 14px;
            margin-bottom: 2px;
        }

        .user-details p {
            font-size: 12px;
            color: #999;
        }

        .sign-out-btn {
            background: transparent;
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 8px 15px;
            border-radius: 15px;
            font-size: 12px;
            cursor: pointer;
            margin-left: 10px;
            transition: all 0.3s ease;
        }

        .sign-out-btn:hover {
            background: rgba(255,255,255,0.1);
        }

        .container {
            display: flex;
            gap: 60px;
            max-width: 1400px;
            width: 100%;
            align-items: center;
            justify-content: center;
        }

        /* iPhone 16 Style Device */
        .iphone-container {
            position: relative;
            width: 320px;
            flex-shrink: 0;
        }

        .iphone {
            width: 320px;
            height: 680px;
            background: linear-gradient(145deg, #3a3a3a, #2a2a2a);
            border-radius: 55px;
            padding: 8px;
            box-shadow: 
                0 30px 60px rgba(0,0,0,0.5),
                0 15px 30px rgba(0,0,0,0.3),
                inset 0 -2px 0 rgba(255,255,255,0.1),
                inset 0 2px 0 rgba(0,0,0,0.8);
            position: relative;
        }

        .screen {
            width: 100%;
            height: calc(100% - 16px);
            background: linear-gradient(180deg, #000000 0%, #0a0a0a 100%);
            border-radius: 47px;
            margin-top: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
            box-shadow: inset 0 0 0 1px rgba(255,255,255,0.1);
        }

        .speaker-icon {
            width: 100px;
            height: 100px;
            border: 3px solid #FFD700;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 30px;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            background: rgba(255,215,0,0.1);
            backdrop-filter: blur(10px);
        }

        .speaker-icon.listening {
            border-color: #00BFFF;
            box-shadow: 0 0 30px rgba(0, 191, 255, 0.6);
            animation: listening 2s infinite;
            background: rgba(0,191,255,0.1);
        }

        @keyframes listening {
            0%, 100% { 
                transform: scale(1);
                box-shadow: 0 0 30px rgba(0, 191, 255, 0.6);
            }
            50% { 
                transform: scale(1.05);
                box-shadow: 0 0 50px rgba(0, 191, 255, 0.8);
            }
        }

        .speaker-icon svg {
            width: 50px;
            height: 50px;
            fill: currentColor;
            color: #FFD700;
        }

        .speaker-icon.listening svg {
            color: #00BFFF;
        }

        .status-text {
            color: #999;
            font-size: 16px;
            text-align: center;
            margin-bottom: 20px;
            font-weight: 500;
            letter-spacing: 1px;
        }

        .status-text.listening {
            color: #00BFFF;
            text-shadow: 0 0 10px rgba(0,191,255,0.5);
        }

        /* Professional Chat Interface */
        .chat-container {
            flex: 1;
            background: linear-gradient(135deg, #2C2C2C 0%, #1F1F1F 50%, #333333 100%);
            border-radius: 25px;
            box-shadow: 
                0 25px 50px rgba(0,0,0,0.3),
                0 10px 20px rgba(0,0,0,0.2),
                inset 0 1px 0 rgba(255,255,255,0.1);
            overflow: hidden;
            max-height: 680px;
            display: flex;
            flex-direction: column;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,215,0,0.2);
        }

        .chat-header {
            background: linear-gradient(135deg, rgba(255,215,0,0.15), rgba(0,0,0,0.3));
            backdrop-filter: blur(10px);
            color: #FFD700;
            padding: 25px;
            text-align: center;
            border-bottom: 1px solid rgba(255,215,0,0.2);
        }

        .chat-header h2 {
            font-size: 28px;
            font-weight: 300;
            letter-spacing: 2px;
            margin-bottom: 5px;
        }

        .chat-header p {
            font-size: 14px;
            opacity: 0.8;
            letter-spacing: 1px;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 25px;
            max-height: 450px;
            background: rgba(255,255,255,0.05);
        }

        .message {
            margin-bottom: 20px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
            animation: messageSlide 0.3s ease;
        }

        @keyframes messageSlide {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-bubble {
            max-width: 75%;
            padding: 15px 20px;
            border-radius: 20px;
            word-wrap: break-word;
            line-height: 1.5;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }

        .message.user .message-bubble {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: #1a1a1a;
            border-bottom-right-radius: 5px;
        }

        .message.bot .message-bubble {
            background: rgba(255,255,255,0.9);
            color: #1a1a1a;
            border-bottom-left-radius: 5px;
            border: 1px solid rgba(255,215,0,0.2);
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: bold;
            flex-shrink: 0;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: #1a1a1a;
        }

        .chat-input-container {
            padding: 25px;
            border-top: 1px solid rgba(255,255,255,0.1);
            background: rgba(0,0,0,0.2);
        }

        .chat-input {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .chat-input input {
            flex: 1;
            background: rgba(255,255,255,0.9);
            border: 1px solid rgba(255,215,0,0.3);
            padding: 15px 20px;
            border-radius: 25px;
            font-size: 16px;
            outline: none;
            transition: all 0.3s ease;
        }

        .chat-input input:focus {
            border-color: #FFD700;
            box-shadow: 0 0 20px rgba(255,215,0,0.3);
        }

        .send-btn, .voice-btn {
            width: 50px;
            height: 50px;
            border: none;
            border-radius: 50%;
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: #1a1a1a;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .send-btn:hover, .voice-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 5px 15px rgba(255,215,0,0.4);
        }

        .voice-btn.recording {
            background: linear-gradient(135deg, #FF4500, #FF6B47);
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .hidden {
            display: none !important;
        }

        /* Responsive design */
        @media (max-width: 1200px) {
            .container {
                flex-direction: column;
                gap: 40px;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            .iphone {
                width: 280px;
                height: 600px;
            }
        }

        /* History panel styles */
        .history-btn {
            position: absolute;
            right: 20px;
            top: 20px;
            background: rgba(255,215,0,0.15);
            color: #FFD700;
            border: 1px solid rgba(255,215,0,0.4);
            padding: 6px 12px;
            border-radius: 14px;
            font-size: 12px;
            cursor: pointer;
        }
        .history-btn:hover { background: rgba(255,215,0,0.25); }

        .history-wrap { position: relative; }
        .history-panel {
            position: absolute;
            right: 0;
            top: 48px;
            width: 360px;
            max-height: 420px;
            overflow-y: auto;
            background: rgba(0,0,0,0.85);
            border: 1px solid rgba(255,215,0,0.3);
            border-radius: 12px;
            box-shadow: 0 12px 30px rgba(0,0,0,0.4);
            padding: 10px;
            display: none;
            z-index: 999;
        }
        .history-panel.active { display: block; }
        .history-item {
            padding: 10px;
            margin: 6px 0;
            border-radius: 8px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,215,0,0.15);
            cursor: pointer;
        }
        .history-item:hover { background: rgba(255,255,255,0.08); }
        .history-item-title { color: #FFD700; font-size: 13px; margin-bottom: 4px; }
        .history-item-time { color: #bbb; font-size: 12px; }
        .history-item-preview { color: #aaa; font-size: 11px; margin-top: 2px; }
        .history-actions { display: flex; gap: 6px; margin-top: 8px; }
        .history-action { font-size: 11px; padding: 5px 8px; border-radius: 6px; border: 1px solid rgba(255,215,0,0.4); background: rgba(255,215,0,0.12); color: #FFD700; cursor: pointer; }
        .history-action:hover { background: rgba(255,215,0,0.2); }
        .history-action.danger { border-color: rgba(255,100,100,0.5); color: #ff7676; background: rgba(255,100,100,0.12); }
        .history-action.danger:hover { background: rgba(255,100,100,0.2); }
        .history-more-wrap { padding: 8px 0 4px; text-align: center; }
        .history-more-btn { font-size: 12px; padding: 6px 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.25); background: rgba(255,255,255,0.08); color: #eee; cursor: pointer; }
        .history-more-btn:hover { background: rgba(255,255,255,0.12); }
    </style>
</head>
<body>
    <!-- Authentication overlay -->
    <div id="authOverlay" class="auth-overlay">
        <div class="auth-card">
            <div class="robot-logo">
                <svg class="robot-image" viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
                    <defs>
                        <linearGradient id="robotGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#FFD700;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#FFA500;stop-opacity:1" />
                        </linearGradient>
                        <filter id="glow">
                            <feGaussianBlur stdDeviation="3" result="coloredBlur"/>
                            <feMerge>
                                <feMergeNode in="coloredBlur"/>
                                <feMergeNode in="SourceGraphic"/>
                            </feMerge>
                        </filter>
                    </defs>
                    <!-- Robot Head -->
                    <circle cx="100" cy="80" r="35" fill="url(#robotGradient)" filter="url(#glow)"/>
                    <!-- Eyes -->
                    <circle cx="90" cy="75" r="6" fill="#000"/>
                    <circle cx="110" cy="75" r="6" fill="#000"/>
                    <circle cx="92" cy="73" r="2" fill="#FFF"/>
                    <circle cx="112" cy="73" r="2" fill="#FFF"/>
                    <!-- Mouth -->
                    <rect x="95" y="88" width="10" height="3" rx="1" fill="#000"/>
                    <!-- Body -->
                    <rect x="75" y="115" width="50" height="60" rx="10" fill="url(#robotGradient)" filter="url(#glow)"/>
                    <!-- Chest Panel -->
                    <rect x="85" y="125" width="30" height="25" rx="5" fill="#333"/>
                    <circle cx="100" cy="135" r="3" fill="#FFD700"/>
                    <rect x="90" y="142" width="20" height="2" fill="#FFD700"/>
                    <!-- Arms -->
                    <rect x="55" y="125" width="15" height="35" rx="7" fill="url(#robotGradient)" filter="url(#glow)"/>
                    <rect x="130" y="125" width="15" height="35" rx="7" fill="url(#robotGradient)" filter="url(#glow)"/>
                    <!-- Hands -->
                    <circle cx="62" cy="167" r="8" fill="url(#robotGradient)"/>
                    <circle cx="137" cy="167" r="8" fill="url(#robotGradient)"/>
                </svg>
                <div class="robot-shadow"></div>
            </div>
            <h1>MegaMind</h1>
            <p>Your AI-powered assistant for SAX Technology Advisors</p>
            <button id="signInBtn" class="sign-in-btn">Sign in with Microsoft</button>
        </div>
    </div>

    <!-- User profile bar -->
    <div id="userProfile" class="user-profile hidden">
        <div class="user-info">
            <div id="userAvatar" class="user-avatar"></div>
            <div class="user-details">
                <h3 id="userName"></h3>
                <p id="userRole"></p>
            </div>
            <button id="signOutBtn" class="sign-out-btn">Sign Out</button>
        </div>
    </div>

    <!-- Main application -->
    <div id="mainApp" class="container hidden">
        <!-- Voice interaction device -->
        <div class="iphone-container">
            <div class="iphone">
                <div class="screen">
                    <!-- Speaker icon and status -->
                    <div class="speaker-icon" id="speakerIcon">
                        <svg viewBox="0 0 24 24">
                            <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>
                        </svg>
                    </div>
                    
                    <div class="status-text" id="statusText">Tap to talk</div>
                </div>
            </div>
        </div>

        <!-- Chat interface -->
        <div class="chat-container">
            <div class="chat-header" style="position: relative;">
                <h2>MegaMind AI</h2>
                <p>Your intelligent assistant</p>
                <div class="history-wrap">
                    <button id="historyBtn" class="history-btn" title="Show conversation history">History</button>
                    <div id="historyPanel" class="history-panel">
                        <div id="historyLoading">Loading sessions...</div>
                        <div id="historyEmpty" style="display:none; color:#bbb; padding:8px;">No sessions found</div>
                        <div id="historyList"></div>
                        <div id="historyMoreWrap" class="history-more-wrap" style="display:none;">
                            <button id="historyLoadMoreBtn" class="history-more-btn">Load more</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="chat-messages" id="chatMessages">
                <!-- Messages will be added here dynamically -->
            </div>
            
            <div class="chat-input-container">
                <div class="chat-input">
                    <input type="text" id="messageInput" placeholder="Type your message or click voice to speak...">
                    <button class="voice-btn" id="voiceBtn">ðŸŽ¤</button>
                    <button class="send-btn" id="sendBtn">âž¤</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ===== MSAL Authentication + Session Persistence =====
        const msalConfig = {
            auth: {
                clientId: "93540af4-ed24-4202-a334-acd7f29bdd4b",
                authority: "https://login.microsoftonline.com/a33e9b66-a6ef-43bf-9702-7cb4301d0a16",
                redirectUri: window.location.origin,
                postLogoutRedirectUri: window.location.origin
            },
            cache: { cacheLocation: "localStorage", storeAuthStateInCookie: true }
        };
        let msalInstance = null;
        let currentAccount = null;
        let userProfile = null;
        let conversationHistory = [];
        window.userSessionId = null;

        const authOverlay = document.getElementById('authOverlay');
        const userProfileDiv = document.getElementById('userProfile');
        const mainApp = document.getElementById('mainApp');
        const userNameEl = document.getElementById('userName');
        const userRoleEl = document.getElementById('userRole');
        const userAvatarEl = document.getElementById('userAvatar');
        const chatMessagesEl = document.getElementById('chatMessages');
        const messageInputEl = document.getElementById('messageInput');

        function showAuthOverlay(){
            authOverlay.classList.remove('hidden');
            userProfileDiv.classList.add('hidden');
            mainApp.classList.add('hidden');
        }
        function showMainApp(){
            authOverlay.classList.add('hidden');
            userProfileDiv.classList.remove('hidden');
            mainApp.classList.remove('hidden');

            // Start a fresh sessionId for this page load (new conversation per refresh)
            try {
                const newSid = 'session_' + Date.now();
                window.userSessionId = newSid;
                sessionStorage.setItem('megamind_sax_session_id', newSid);
                // Clear any prior in-memory history snapshot for a clean start
                conversationHistory = [];
            } catch {}

            // Welcome message only once per load
            if (!sessionStorage.getItem('megamind_demo_welcome')){
                addMessage('bot', "Welcome to MegaMind! I'm your AI assistant. How can I help you today?");
                sessionStorage.setItem('megamind_demo_welcome','1');
            }
        }

        function updateProfileUIFromAccount(account){
            const email = account?.username || account?.idTokenClaims?.preferred_username || '';
            const display = account?.name || email || 'User';
            if (userNameEl) userNameEl.textContent = display;
            if (userRoleEl) userRoleEl.textContent = 'SAX Advisory Group';
            if (userAvatarEl) userAvatarEl.textContent = (display?.[0] || 'U').toUpperCase();
            userProfile = { mail: email, displayName: display };
        }

        async function initializeAuth(){
            if (typeof msal !== 'undefined' && msal.PublicClientApplication){
                msalInstance = new msal.PublicClientApplication(msalConfig);
                await msalInstance.initialize();
                try {
                    const result = await msalInstance.handleRedirectPromise();
                    if (result?.account){ currentAccount = result.account; }
                } catch(e){ console.warn('MSAL redirect handling:', e); }
                const accounts = msalInstance.getAllAccounts();
                if (!currentAccount && accounts.length>0){ currentAccount = accounts[0]; }
                if (currentAccount){
                    updateProfileUIFromAccount(currentAccount);
                    showMainApp();
                } else {
                    showAuthOverlay();
                }
            } else {
                console.error('MSAL script not loaded');
                showAuthOverlay();
            }
        }

        // ===== Conversation persistence (local + Azure Function) =====
        function saveSessionHistory(){
            // Ensure there is a session id for this page load
            if (!window.userSessionId){
                const restored = sessionStorage.getItem('megamind_sax_session_id');
                window.userSessionId = restored || ('session_' + Date.now());
                sessionStorage.setItem('megamind_sax_session_id', window.userSessionId);
            }
            const sid = window.userSessionId;
            const snapshot = { messages: conversationHistory, lastUpdated: new Date().toISOString() };
            try { localStorage.setItem(sid, JSON.stringify(snapshot)); } catch {}
            logToAzureDatabase(sid, conversationHistory);
        }
        async function logToAzureDatabase(sessionId, messages){
            const email = currentAccount?.username || userProfile?.mail;
            if (!email) return; // require identity for cloud persistence
            try {
                const resp = await fetch('https://saxtechconversationlogs.azurewebsites.net/api/SaveConversationLog?code=w_j-EeXYy7G1yfUBkSVvlT5Hhafzg-eCNkaUOkOzzIveAzFu9NTlQw==',{
                    method:'POST',
                    headers:{ 'Content-Type':'application/json' },
                    body: JSON.stringify({
                        action:'save',
                        sessionId,
                        userEmail: email,
                        userName: currentAccount?.name || email,
                        conversation: messages,
                        timestamp: new Date().toISOString(),
                        department: null,
                        location: null,
                        aiProfile: 'default'
                    })
                });
                if (!resp.ok){ console.warn('Failed to save conversation to database:', resp.status); }
            } catch (e){ console.error('Failed to log to Azure database:', e); }
        }

        // ===== Chat UI helpers (unchanged visuals) =====
        function addMessage(sender, message){
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            if (sender === 'user') {
                const initials = (userProfile?.displayName || (currentAccount?.name || 'U')).slice(0,2).toUpperCase();
                avatar.textContent = initials;
            } else {
                avatar.innerHTML = `<svg viewBox="0 0 200 200" style="width: 24px; height: 24px;">
                    <defs>
                        <linearGradient id="botGradient${Date.now()}" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#FFD700;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#FFA500;stop-opacity:1" />
                        </linearGradient>
                    </defs>
                    <circle cx="100" cy="80" r="35" fill="url(#botGradient${Date.now()})"/>
                    <circle cx="90" cy="75" r="6" fill="#000"/>
                    <circle cx="110" cy="75" r="6" fill="#000"/>
                    <circle cx="92" cy="73" r="2" fill="#FFF"/>
                    <circle cx="112" cy="73" r="2" fill="#FFF"/>
                    <rect x="95" y="88" width="10" height="3" rx="1" fill="#000"/>
                    <rect x="75" y="115" width="50" height="60" rx="10" fill="url(#botGradient${Date.now()})"/>
                    <rect x="85" y="125" width="30" height="25" rx="5" fill="#333"/>
                    <circle cx="100" cy="135" r="3" fill="#FFD700"/>
                    <rect x="90" y="142" width="20" height="2" fill="#FFD700"/>
                    <rect x="55" y="125" width="15" height="35" rx="7" fill="url(#botGradient${Date.now()})"/>
                    <rect x="130" y="125" width="15" height="35" rx="7" fill="url(#botGradient${Date.now()})"/>
                    <circle cx="62" cy="167" r="8" fill="url(#botGradient${Date.now()})"/>
                    <circle cx="137" cy="167" r="8" fill="url(#botGradient${Date.now()})"/>
                </svg>`;
            }
            const bubble = document.createElement('div');
            bubble.className = 'message-bubble';
            bubble.textContent = message;
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(bubble);
            chatMessagesEl.appendChild(messageDiv);
            chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;
        }

        // ===== Send message: now persists to cloud =====
        async function sendMessage(message){
            if (!message || !message.trim()) return;

            // UI + local model state
            addMessage('user', message);
            messageInputEl.value = '';
            conversationHistory.push({ role:'user', content: message, timestamp: new Date().toISOString() });
            saveSessionHistory();

            // Typing indicator
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message bot typing';
            typingDiv.innerHTML = `<div class="message-avatar">
                <svg viewBox="0 0 200 200" style="width: 24px; height: 24px;">
                    <circle cx="100" cy="100" r="35" fill="#FFD700"/>
                    <circle cx="90" cy="95" r="6" fill="#000"/>
                    <circle cx="110" cy="95" r="6" fill="#000"/>
                    <rect x="95" y="108" width="10" height="3" rx="1" fill="#000"/>
                </svg>
            </div><div class="message-bubble">Thinking...</div>`;
            chatMessagesEl.appendChild(typingDiv);
            chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;

            try {
                const email = currentAccount?.username || userProfile?.mail || 'demo@saxtechnology.com';
                const name = currentAccount?.name || userProfile?.displayName || 'Demo User';
                const payload = {
                    chatInput: message,
                    message,
                    input: message,
                    prompt: message,
                    text: message,
                    query: message,
                    sessionId: (window.userSessionId || sessionStorage.getItem('megamind_sax_session_id') || ('session_' + Date.now())),
                    selectedVoice: 'alloy',
                    timestamp: new Date().toISOString(),
                    userContext: {
                        userProfile: {
                            name,
                            email,
                            jobTitle: 'Employee',
                            department: 'SAX Advisory Group'
                        },
                        source: 'megamind-webapp',
                        version: '1.0'
                    }
                };

                const response = await fetch('https://workflows.saxtechnology.com/webhook/megamind-chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Accept': 'application/json', 'User-Agent': 'MegaMind-WebApp/1.0' },
                    body: JSON.stringify(payload)
                });

                chatMessagesEl.removeChild(typingDiv);

                if (response.ok){
                    let result = {};
                    try { result = await response.json(); } catch {}
                    const botResponse = result.response || result.message || result.text || result.answer || 'I received your message!';
                    addMessage('bot', botResponse);
                    conversationHistory.push({ role:'assistant', content: botResponse, timestamp: new Date().toISOString() });
                    saveSessionHistory();

                    if (result.audioData){
                        try { new Audio('data:audio/mp3;base64,' + result.audioData).play().catch(()=>{}); } catch {}
                    }
                } else {
                    const errorText = await response.text();
                    console.error('Webhook error:', response.status, errorText);
                    let errorMessage = `I'm having trouble connecting to the server (HTTP ${response.status}).`;
                    if (response.status === 404) errorMessage += ' The webhook endpoint might not be active yet.';
                    if (response.status === 500) errorMessage += ' There is a server error.';
                    addMessage('bot', errorMessage);
                }
            } catch (error){
                console.error('Fetch error:', error);
                if (chatMessagesEl.contains(typingDiv)) chatMessagesEl.removeChild(typingDiv);
                let msg = 'I\'m having trouble connecting to the server. ';
                if (error?.message?.includes('fetch')) msg += 'This might be a network or CORS issue.';
                addMessage('bot', msg);
            }
        }

        // ===== History loading and restore =====
        let historyOpen = false;
        let loadedHistorySessions = [];
        let currentHistoryRange = 'month'; // initial window; load more switches to 'all'

        function escapeHtml(str){
            try { return String(str).replace(/[&<>"']/g, s=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[s])); } catch { return str; }
        }

        function toggleHistoryPanel(){
            const panel = document.getElementById('historyPanel');
            const loading = document.getElementById('historyLoading');
            const list = document.getElementById('historyList');
            const empty = document.getElementById('historyEmpty');
            const moreWrap = document.getElementById('historyMoreWrap');
            historyOpen = !historyOpen;
            if (historyOpen){
                panel.classList.add('active');
                if (loading) loading.style.display = 'block';
                if (empty) empty.style.display = 'none';
                if (list) list.innerHTML = '';
                currentHistoryRange = 'month';
                loadCloudHistory(currentHistoryRange, false).then(hadCloud => { if (!hadCloud) loadLocalHistory(); });
                if (moreWrap) moreWrap.style.display = 'block';
            } else {
                panel.classList.remove('active');
            }
        }

        function addMessageToUI(role, content){
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;
            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            if (role === 'user') {
                const initials = (userProfile?.displayName || (currentAccount?.name || 'U')).slice(0,2).toUpperCase();
                avatar.textContent = initials;
            } else {
                avatar.innerHTML = `<svg viewBox="0 0 200 200" style="width: 24px; height: 24px;">
                    <circle cx="100" cy="100" r="35" fill="#FFD700"/>
                    <circle cx="90" cy="95" r="6" fill="#000"/>
                    <circle cx="110" cy="95" r="6" fill="#000"/>
                    <rect x="95" y="108" width="10" height="3" rx="1" fill="#000"/>
                </svg>`;
            }
            const bubble = document.createElement('div');
            bubble.className = 'message-bubble';
            bubble.innerHTML = content;
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(bubble);
            chatMessagesEl.appendChild(messageDiv);
            chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;
        }

        function restoreConversation(messages){
            try {
                chatMessagesEl.innerHTML = '';
                (messages||[]).forEach(msg => {
                    const role = (msg.role === 'assistant') ? 'bot' : (msg.role === 'user' ? 'user' : 'bot');
                    addMessageToUI(role, escapeHtml(msg.content || ''));
                });
                // Do not auto-save on restore
                // Close panel after restore
                const panel = document.getElementById('historyPanel');
                if (panel) panel.classList.remove('active');
                historyOpen = false;
            } catch(e){ console.warn('Failed to restore conversation', e); }
        }

        window.displayHistoryList = function(sessions){
            const list = document.getElementById('historyList');
            const empty = document.getElementById('historyEmpty');
            const loading = document.getElementById('historyLoading');
            const moreWrap = document.getElementById('historyMoreWrap');
            if (loading) loading.style.display = 'none';
            if (!list) return;
            if (!sessions || sessions.length === 0){
                if (empty) empty.style.display = 'block';
                list.innerHTML = '';
                if (moreWrap) moreWrap.style.display = 'none';
                return;
            }
            if (empty) empty.style.display = 'none';
            list.innerHTML = '';
            sessions.forEach((s, idx) => {
                const ts = new Date(s.timestamp || s.createdAt || Date.now());
                const dateStr = ts.toLocaleDateString() + ' ' + ts.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                let preview = 'Conversation';
                let conv = [];
                try {
                    conv = Array.isArray(s.conversation) ? s.conversation : (typeof s.conversation === 'string' ? (JSON.parse(s.conversation).messages || []) : []);
                } catch {}
                const firstUser = conv?.find?.(m => (m.role === 'user' || m.type === 'user') && (m.content || m.message));
                if (firstUser) {
                    const txt = (firstUser.content || firstUser.message).replace(/<[^>]*>/g, '').trim();
                    preview = (txt || 'Conversation').substring(0, 60);
                }
                const item = document.createElement('div');
                item.className = 'history-item';
                item.innerHTML = `
                    <div class="history-item-main" style="cursor:pointer;" onclick="window.loadHistorySession(${idx})">
                        <div class="history-item-title">${escapeHtml(preview)}</div>
                        <div class="history-item-time">${dateStr}</div>
                        <div class="history-item-preview">${(conv?.length||0)} messages</div>
                    </div>
                    <div class="history-actions">
                        <button class="history-action" onclick="window.loadHistorySession(${idx})">View</button>
                        <button class="history-action" onclick="window.continueHistorySession(${idx})">Continue</button>
                        <button class="history-action danger" onclick="window.deleteHistorySession(${idx})">Delete</button>
                    </div>
                `;
                list.appendChild(item);
            });
            if (moreWrap) {
                // Show 'Load more' only if not at 'all'
                moreWrap.style.display = currentHistoryRange === 'all' ? 'none' : 'block';
            }
        }

        window.loadHistorySession = function(index){
            const session = loadedHistorySessions[index];
            if (!session) return;
            let conv = [];
            try {
                if (Array.isArray(session.conversation)) conv = session.conversation;
                else if (typeof session.conversation === 'string') {
                    const parsed = JSON.parse(session.conversation);
                    conv = Array.isArray(parsed) ? parsed : (parsed.messages || []);
                }
            } catch {}
            restoreConversation(conv || []);
        }

        window.continueHistorySession = function(index){
            const session = loadedHistorySessions[index];
            if (!session) return;
            try {
                let conv = [];
                if (Array.isArray(session.conversation)) conv = session.conversation;
                else if (typeof session.conversation === 'string') {
                    const parsed = JSON.parse(session.conversation);
                    conv = Array.isArray(parsed) ? parsed : (parsed.messages || []);
                }
                // Set active sessionId and conversation history; persist to sessionStorage so saves target it
                window.userSessionId = session.sessionId || window.userSessionId || `session_${Date.now()}`;
                sessionStorage.setItem('megamind_sax_session_id', window.userSessionId);
                conversationHistory = conv;
                // Save local snapshot immediately
                saveSessionHistory();
                // Render into UI
                restoreConversation(conv);
                // Inform user
                addMessage('bot', 'Continuing previous session.');
            } catch(e){ console.warn('Continue session failed', e); }
        }

        window.deleteHistorySession = async function(index){
            const session = loadedHistorySessions[index];
            if (!session) return;
            if (!confirm('Delete this session from cloud storage?')) return;
            try {
                const resp = await fetch('https://saxtechconversationlogs.azurewebsites.net/api/SaveConversationLog?code=w_j-EeXYy7G1yfUBkSVvlT5Hhafzg-eCNkaUOkOzzIveAzFu9NTlQw==',{
                    method:'POST',
                    headers:{ 'Content-Type':'application/json' },
                    body: JSON.stringify({ action:'delete', sessionId: session.sessionId })
                });
                if (!resp.ok){
                    const t = await resp.text();
                    alert('Delete failed: ' + t);
                    return;
                }
                // Remove from local state and refresh list
                loadedHistorySessions.splice(index,1);
                window.displayHistoryList(loadedHistorySessions);
                addMessage('bot', 'Session deleted.');
            } catch(e){
                console.error('Delete failed', e);
                alert('Delete failed: ' + (e?.message||e));
            }
        }

        window.loadCloudHistory = async function(rangeArg, append){
            const loading = document.getElementById('historyLoading');
            const empty = document.getElementById('historyEmpty');
            const list = document.getElementById('historyList');
            if (!append){
                if (loading) loading.style.display = 'block';
                if (empty) empty.style.display = 'none';
                if (list) list.innerHTML = '';
            }
            try {
                const email = currentAccount?.username || userProfile?.mail || null;
                if (!email){ if (loading) loading.style.display = 'none'; return false; }
                const range = rangeArg || currentHistoryRange || 'month';
                const url = `https://saxtechconversationlogs.azurewebsites.net/api/SaveConversationLog?action=get&email=${encodeURIComponent(email)}&range=${encodeURIComponent(range)}&code=w_j-EeXYy7G1yfUBkSVvlT5Hhafzg-eCNkaUOkOzzIveAzFu9NTlQw==`;
                const resp = await fetch(url);
                if (!resp.ok){ if (loading) loading.style.display = 'none'; if (!append && empty) empty.style.display = 'block'; return false; }
                const data = await resp.json();
                const sessions = Array.isArray(data) ? data : (data.sessions || data.conversations || data.data || []);
                if (!Array.isArray(sessions) || sessions.length === 0){ if (loading) loading.style.display = 'none'; if (!append && empty) empty.style.display = 'block'; return false; }
                if (append){
                    // Merge dedup by id
                    const byId = new Map(loadedHistorySessions.map(s => [s.id || (s.sessionId+':' + s.timestamp), s]));
                    for (const s of sessions){
                        const key = s.id || (s.sessionId+':' + s.timestamp);
                        if (!byId.has(key)) byId.set(key, s);
                    }
                    loadedHistorySessions = Array.from(byId.values()).sort((a,b)=> new Date(b.timestamp) - new Date(a.timestamp));
                    window.displayHistoryList(loadedHistorySessions);
                } else {
                    loadedHistorySessions = sessions;
                    window.displayHistoryList(sessions);
                }
                if (loading) loading.style.display = 'none';
                return true;
            } catch(e){ console.warn('Cloud history failed', e); if (loading) loading.style.display = 'none'; return false; }
        }

        window.loadLocalHistory = function(){
            const loading = document.getElementById('historyLoading');
            const empty = document.getElementById('historyEmpty');
            const list = document.getElementById('historyList');
            if (loading) loading.style.display = 'none';
            const localSessions = [];
            try {
                const maybeKey = currentAccount?.username ? `${currentAccount.username}_session` : null;
                if (maybeKey){
                    const raw = localStorage.getItem(maybeKey);
                    if (raw){
                        const parsed = JSON.parse(raw);
                        localSessions.push({ sessionId: maybeKey, timestamp: parsed.lastUpdated || new Date().toISOString(), conversation: parsed.messages || [] });
                    }
                }
                for (let i=0; i<localStorage.length; i++){
                    const key = localStorage.key(i);
                    if (key && key.startsWith('megamind_conversation_')){
                        try {
                            const data = JSON.parse(localStorage.getItem(key));
                            if (data?.messages?.length){
                                localSessions.push({ sessionId: key, timestamp: data.timestamp || new Date().toISOString(), conversation: data.messages });
                            }
                        } catch {}
                    }
                }
            } catch {}
            if (!localSessions.length){ if (empty) empty.style.display = 'block'; if (list) list.innerHTML = ''; return; }
            loadedHistorySessions = localSessions.sort((a,b)=> new Date(b.timestamp)-new Date(a.timestamp)).slice(0,50);
            window.displayHistoryList(loadedHistorySessions);
        }

        // ===== Voice recording (unchanged) =====
        let isRecording = false; let mediaRecorder = null; let audioChunks = [];
        async function startRecording(){
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                mediaRecorder.ondataavailable = (e)=>{ audioChunks.push(e.data); };
                mediaRecorder.onstop = ()=>{ const audioBlob = new Blob(audioChunks, { type:'audio/wav' }); processVoiceInput(audioBlob); };
                mediaRecorder.start(); isRecording = true;
                document.getElementById('voiceBtn').classList.add('recording');
                document.getElementById('speakerIcon').classList.add('listening');
                document.getElementById('statusText').textContent = 'Listening...';
                document.getElementById('statusText').classList.add('listening');
            } catch (e){ console.error('Error starting recording:', e); alert('Could not access microphone.'); }
        }
        function stopRecording(){
            if (mediaRecorder && isRecording){
                mediaRecorder.stop(); mediaRecorder.stream.getTracks().forEach(t=>t.stop()); isRecording=false;
                document.getElementById('voiceBtn').classList.remove('recording');
                document.getElementById('speakerIcon').classList.remove('listening');
                document.getElementById('statusText').textContent = 'Processing...';
                document.getElementById('statusText').classList.remove('listening');
            }
        }
        async function processVoiceInput(audioBlob){
            try {
                document.getElementById('statusText').textContent = 'Processing voice...';
                const reader = new FileReader();
                reader.onload = function(){
                    addMessage('user', '[Voice message received]');
                    addMessage('bot', 'I received your voice message! Voice processing will be implemented later.');
                    document.getElementById('statusText').textContent = 'Tap to talk';
                };
                reader.readAsArrayBuffer(audioBlob);
            } catch (e){ console.error('Error processing voice input:', e); }
        }

        // ===== Event listeners =====
        document.getElementById('sendBtn').addEventListener('click', ()=> sendMessage(messageInputEl.value));
        messageInputEl.addEventListener('keypress', (e)=>{ if (e.key==='Enter') sendMessage(messageInputEl.value); });
        document.getElementById('voiceBtn').addEventListener('click', ()=>{ isRecording ? stopRecording() : startRecording(); });
        document.getElementById('speakerIcon').addEventListener('click', ()=>{ isRecording ? stopRecording() : startRecording(); });
        document.getElementById('historyBtn').addEventListener('click', toggleHistoryPanel);
        document.getElementById('historyLoadMoreBtn').addEventListener('click', async ()=>{
            // escalate range to 'all' for now
            if (currentHistoryRange !== 'all'){
                currentHistoryRange = 'all';
                await loadCloudHistory(currentHistoryRange, true);
            }
        });
        // Close history panel when clicking outside
        document.addEventListener('click', (e)=>{
            if (!e.target.closest('.history-wrap')){
                const panel = document.getElementById('historyPanel');
                if (panel && panel.classList.contains('active')){ panel.classList.remove('active'); historyOpen = false; }
            }
        });

        // Replace demo sign-in with MSAL
        document.getElementById('signInBtn').addEventListener('click', async ()=>{
            try {
                if (!msalInstance){ msalInstance = new msal.PublicClientApplication(msalConfig); await msalInstance.initialize(); }
                await msalInstance.loginRedirect({ scopes:["openid","profile","email","User.Read"], prompt: 'select_account' });
            } catch (e){ console.error('Login error:', e); alert('Login failed: ' + (e?.message||e)); }
        });
        document.getElementById('signOutBtn').addEventListener('click', async ()=>{
            try {
                const acct = currentAccount || (msalInstance?.getAllAccounts?.()[0]);
                if (acct && msalInstance){ await msalInstance.logout({ account: acct }); }
            } catch (e){ console.warn('Logout error:', e); }
            currentAccount = null; userProfile = null; conversationHistory = []; window.userSessionId = null;
            chatMessagesEl.innerHTML = '';
            showAuthOverlay();
        });

        // Initialize on load
        window.addEventListener('load', initializeAuth);
    </script>
</body>
</html>
